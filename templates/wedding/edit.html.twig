{% extends 'base.html.twig' %}

{% block title %}{{ wedding.id ? 'Modifier le mariage' : 'Ajouter un mariage' }}{% endblock %}

{% block body %}
<header class="page-header">
    <div>
        <h1>{{ wedding.id ? 'Modifier le mariage' : 'Ajouter un mariage' }}</h1>
        {% if wedding.marie or wedding.mariee %}
            <div class="badge-pill badge-tertiary mt-2">
                {% if wedding.messe is defined and wedding.messe %}Messe{% else %}Célébration{% endif %} de mariage de
                {{ wedding.marie ? (wedding.marie.firstName ~ (wedding.marie.name ? ' ' ~ wedding.marie.name : '')) : '-' }}
                &amp;
                {{ wedding.mariee ? (wedding.mariee.firstName ~ (wedding.mariee.name ? ' ' ~ wedding.mariee.name : '')) : '-' }}
                {% if wedding.date is defined %} — {{ wedding.date|date('d/m/Y') }}{% endif %}
            </div>
        {% endif %}
    </div>

    <div class="app-actions">
        <button type="submit" form="weddingForm" class="btn btn-primary btn-rounded btn-icon">
            <i class="bi bi-check-lg"></i>
            Enregistrer
        </button>
        {% if wedding.id %}
            <button type="button" class="btn btn-outline-primary btn-rounded btn-icon" data-bs-toggle="modal" data-bs-target="#inviteModal">
                <i class="bi bi-envelope-plus"></i>
                Inviter
            </button>
        {% endif %}
        <a href="{{ wedding.id ? path('app_wedding_view', {'id': wedding.id}) : path('app_wedding_index') }}" class="btn btn-outline-secondary btn-rounded">Annuler</a>
    </div>
</header>

    <!-- Tabs -->
    <ul class="app-tabs" role="tablist">
        <li class="nav-item">
            <button class="app-tab app-tab-primary active" id="tab-info" data-bs-toggle="tab" data-bs-target="#pane-info" type="button" role="tab" aria-selected="true">
                <i class="bi bi-info-circle"></i>
                <span>Informations générales</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="app-tab app-tab-secondary" id="tab-deroule" data-bs-toggle="tab" data-bs-target="#pane-deroule" type="button" role="tab" aria-selected="false">
                <i class="bi bi-list-ul"></i>
                <span>Déroulé</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="app-tab app-tab-secondary" id="tab-logistique" data-bs-toggle="tab" data-bs-target="#pane-logistique" type="button" role="tab" aria-selected="false">
                <i class="bi bi-gear"></i>
                <span>Logistique</span>
            </button>
        </li>
    </ul>

    {{ form_start(form, {'attr': {'id': 'weddingForm'}}) }}

    <div class="tab-content">
        <!-- Informations générales -->
        <div class="tab-pane fade show active" id="pane-info">
            <div class="row g-3 mb-4">
                <!-- Card Informations Mariage -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="wedding-info-card">
                        <div class="wedding-info-card__header">
                            Informations mariage
                        </div>

                        <div class="wedding-info-card__body">
                            {{ form_row(form.messe, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.date, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.time, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.parish, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.church, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.addressLine1, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.addressLine2, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.addressPostalCodeAndCity, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.archive, {'label_attr': {'class': 'form-label-sm'}}) }}
                        </div>
                    </div>
                </div>

                <!-- Futur marié -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="wedding-info-card">
                        <div class="wedding-info-card__header">
                            Informations futur marié
                        </div>

                        <div class="wedding-info-card__body text-center">
                            <div class="app-avatar app-avatar-lg mx-auto mb-3" style="background: var(--color-primary);">
                                {{ wedding.marie and wedding.marie.firstName ? wedding.marie.firstName|slice(0,1)|upper : 'A' }}
                            </div>

                            <div class="mb-2">
                                {{ form_label(form.marie, null, {'label_attr': {'class': 'form-label-sm'}}) }}
                                {{ form_widget(form.marie, {'attr': {'class': 'form-select form-select-sm'}}) }}
                                {{ form_errors(form.marie) }}
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Prénom</label>
                                <input type="text" name="marie[firstName]" class="form-control form-control-sm" value="{{ wedding.marie ? wedding.marie.firstName : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Nom</label>
                                <input type="text" name="marie[name]" class="form-control form-control-sm" value="{{ wedding.marie ? wedding.marie.name : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Email</label>
                                <input type="email" name="marie[email]" class="form-control form-control-sm" value="{{ wedding.marie ? wedding.marie.email : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Téléphone</label>
                                <input type="text" name="marie[telephone]" class="form-control form-control-sm" value="{{ wedding.marie ? wedding.marie.telephone : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Adresse</label>
                                <input type="text" name="marie[addressLine1]" class="form-control form-control-sm" value="{{ wedding.marie ? wedding.marie.addressLine1 : '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Futur mariée -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="wedding-info-card">
                        <div class="wedding-info-card__header">
                            Informations future mariée
                        </div>

                        <div class="wedding-info-card__body text-center">
                            <div class="app-avatar app-avatar-lg mx-auto mb-3" style="background: var(--color-primary);">
                                {{ wedding.mariee and wedding.mariee.firstName ? wedding.mariee.firstName|slice(0,1)|upper : 'A' }}
                            </div>

                            <div class="mb-2">
                                {{ form_label(form.mariee, null, {'label_attr': {'class': 'form-label-sm'}}) }}
                                {{ form_widget(form.mariee, {'attr': {'class': 'form-select form-select-sm'}}) }}
                                {{ form_errors(form.mariee) }}
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Prénom</label>
                                <input type="text" name="mariee[firstName]" class="form-control form-control-sm" value="{{ wedding.mariee ? wedding.mariee.firstName : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Nom</label>
                                <input type="text" name="mariee[name]" class="form-control form-control-sm" value="{{ wedding.mariee ? wedding.mariee.name : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Email</label>
                                <input type="email" name="mariee[email]" class="form-control form-control-sm" value="{{ wedding.mariee ? wedding.mariee.email : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Téléphone</label>
                                <input type="text" name="mariee[telephone]" class="form-control form-control-sm" value="{{ wedding.mariee ? wedding.mariee.telephone : '' }}">
                            </div>

                            <div class="form-group-sm">
                                <label class="form-label-sm">Adresse</label>
                                <input type="text" name="mariee[addressLine1]" class="form-control form-control-sm" value="{{ wedding.mariee ? wedding.mariee.addressLine1 : '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paroisse -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="wedding-info-card">
                        <div class="wedding-info-card__header">
                            Informations paroisse
                        </div>

                        <div class="wedding-info-card__body">
                            {{ form_row(form.priestFirstName, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.priestLastName, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.priestPhoneNumber, {'label_attr': {'class': 'form-label-sm'}}) }}
                            {{ form_row(form.priestEMail, {'label_attr': {'class': 'form-label-sm'}}) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bloc financier -->
            <div class="wedding-finance-panel">
                <div class="wedding-finance-grid">
                    <div class="wedding-finance-item">
                        <label class="wedding-finance-label">Montant de la prestation</label>
                        {{ form_widget(form.montantTotal, {'attr': {'class':'form-control text-center'}}) }}
                    </div>

                    <div class="wedding-finance-item">
                        <label class="wedding-finance-label">Montant déjà versé</label>
                        {{ form_widget(form.montantPaye, {'attr': {'class':'form-control text-center'}}) }}
                    </div>

                    <div class="wedding-finance-item">
                        <div class="wedding-finance-label">Pourcentage de l'acompte</div>
                        <div class="wedding-finance-value">
                            {% if wedding.montantTotal and wedding.montantPaye is not null and wedding.montantTotal > 0 %}
                                {{ ((wedding.montantPaye / wedding.montantTotal) * 100)|round(0) }} %
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </div>

                    <div class="wedding-finance-item">
                        <div class="wedding-finance-label">Montant restant dû</div>
                        <div class="wedding-finance-value">
                            {% if wedding.montantTotal is defined and wedding.montantPaye is defined %}
                                {{ (wedding.montantTotal - wedding.montantPaye) ~ ' €' }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Déroulé -->
        <div class="tab-pane fade" id="pane-deroule">
            <div class="deroule-container">
                {# regroupement des songTypes par celebrationPeriod #}
                {% set types = songTypes is defined ? songTypes : [] %}
                {% set groups = {} %}
                {% for t in types %}
                    {% set label = t.celebrationPeriod is not null ? t.celebrationPeriod.value : 'Autres' %}
                    {% if groups[label] is defined %}
                        {% set groups = groups|merge({ (label) : groups[label]|merge([t]) }) %}
                    {% else %}
                        {% set groups = groups|merge({ (label) : [t] }) %}
                    {% endif %}
                {% endfor %}

                {# ordre souhaité basé sur l'enum #}
                {% set order = ['Accueil','Liturgie de la Parole','Liturgie du Mariage','Liturgie Eucharistique','Envoi','Autres'] %}

                {% if groups is empty %}
                    <div class="app-card">
                        <p class="text-muted mb-0">Aucun type de chant défini. Ajoute des types dans l'administration.</p>
                    </div>
                {% else %}
                    <!-- En-têtes des colonnes (masqué sur mobile) -->
                    <div class="deroule-header d-none d-lg-flex">
                        <div class="deroule-col-type">TYPE</div>
                        <div class="deroule-col-choice">VOTRE CHOIX</div>
                        <div class="deroule-col-check">VALIDATION CÉLÉBRANT</div>
                        <div class="deroule-col-check">VALIDATION MUSICIEN</div>
                        <div class="deroule-col-comments">COMMENTAIRES</div>
                    </div>

                    <div class="deroule-groups">
                        {% for label in order %}
                            {% if groups[label] is defined %}
                                <div class="deroule-group">
                                    <div class="deroule-group-header">
                                        {{ label }}
                                    </div>

                                    <div class="deroule-group-body">
                                        {% for type in groups[label] %}
                                            {% set songsForType = availableSongsByType[type.id]|default(type.songs) %}
                                            <div class="deroule-row">
                                                <div class="deroule-col deroule-col-type">
                                                    <span class="deroule-label d-lg-none">Type</span>
                                                    <span class="deroule-type-badge">{{ type.name }}</span>
                                                </div>

                                                <div class="deroule-col deroule-col-choice">
                                                    <label class="deroule-label d-lg-none">Votre choix</label>
                                                    <select name="deroule[{{ label|replace({' ':'_'}) }}][{{ type.id|default(loop.index) }}]"
                                                            class="form-select deroule-select js-deroule-select"
                                                            data-placeholder="Rechercher un chant">
                                                        <option value="">Aucun chant sélectionné</option>
                                                        {% if songsForType|length > 0 %}
                                                            {% for song in songsForType %}
                                                                <option value="{{ song.id }}">{{ song.name ?? (song.title ?? 'Titre inconnu') }}</option>
                                                            {% endfor %}
                                                        {% else %}
                                                            <option disabled>Pas de chants disponibles</option>
                                                        {% endif %}
                                                    </select>
                                                </div>

                                                <div class="deroule-col deroule-col-check">
                                                    <label class="deroule-label d-lg-none">Validation célébrant</label>
                                                    <input type="checkbox" name="deroule_valid_celebrant[{{ label|replace({' ':'_'}) }}][{{ type.id|default(loop.index) }}]" class="form-check-input" />
                                                </div>

                                                <div class="deroule-col deroule-col-check">
                                                    <label class="deroule-label d-lg-none">Validation musicien</label>
                                                    <input type="checkbox" name="deroule_valid_musicien[{{ label|replace({' ':'_'}) }}][{{ type.id|default(loop.index) }}]" class="form-check-input" />
                                                </div>

                                                <div class="deroule-col deroule-col-comments">
                                                    <label class="deroule-label d-lg-none">Commentaires</label>
                                                    {% if wedding.id %}
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-secondary open-comments"
                                                                data-wedding="{{ wedding.id }}"
                                                                data-songtype="{{ type.id }}"
                                                                aria-haspopup="dialog"
                                                                aria-controls="commentsModal">
                                                            <i class="bi bi-chat-dots"></i>
                                                            <span class="d-none d-md-inline">Commentaires</span>
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Sauvegardez le mariage pour activer les commentaires">
                                                            <i class="bi bi-chat-dots"></i>
                                                            <span class="d-none d-md-inline">Commentaires</span>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Logistique -->
        <div class="tab-pane fade" id="pane-logistique">
            <div class="app-card">
                <h5>Informations logistiques</h5>
                <p class="text-muted mb-0">Section désactivée pour l'instant.</p>
            </div>
        </div>
    </div>

    <!-- Actions du formulaire (boutons visibles sur tous les onglets) -->
    <div class="form-actions-bar">
        <button type="submit" class="btn btn-primary btn-rounded">
            <i class="bi bi-check-circle"></i> Enregistrer
        </button>
        {% if wedding.id %}
            <a href="{{ path('app_wedding_view', {'id': wedding.id}) }}" class="btn btn-secondary btn-rounded">
                Annuler
            </a>
            <button type="button" class="btn btn-outline-primary btn-rounded" data-bs-toggle="modal" data-bs-target="#inviteModal">
                <i class="bi bi-envelope-plus"></i> Inviter
            </button>
        {% else %}
            <a href="{{ path('app_wedding_index') }}" class="btn btn-secondary btn-rounded">
                Annuler
            </a>
        {% endif %}
    </div>

    {{ form_end(form) }}

    {# Modal d'invitation : ne pas afficher lors de la création tant que wedding.id n'existe pas #}
    {% if wedding.id %}
        <!-- Modal d'invitation -->
        <div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="inviteModalLabel">Inviter quelqu'un</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form action="{{ path('app_wedding_invite', {'id': wedding.id}) }}" method="POST">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="role" class="form-label">Rôle</label>
                                <select class="form-select" id="role" name="role" required>
                                    <option value="paroisse">Paroisse</option>
                                    <option value="musicien">Musicien</option>
                                    <option value="marie">Marié</option>
                                    <option value="mariee">Mariée</option>
                                </select>
                            </div>
                        </div>
                        {% if generatedInvitationLink is defined %}
                            <div class="alert alert-info mt-3 mx-3">
                                <p>Lien d'invitation généré :</p>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="invitation-link" value="{{ generatedInvitationLink }}" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copyInvitationLink()">Copier</button>
                                </div>
                            </div>
                            <script>
                                function copyInvitationLink() {
                                    var copyText = document.getElementById('invitation-link');
                                    copyText.select();
                                    copyText.setSelectionRange(0, 99999);
                                    navigator.clipboard.writeText(copyText.value).then(function () {
                                        alert('Lien copié dans le presse-papiers !');
                                    });
                                }
                            </script>
                        {% endif %}
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="submit" class="btn btn-primary">Envoyer l'invitation</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}

    {# Modal générique pour afficher la conversation de commentaires en popup #}
    <div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Commentaires</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-4" id="commentsModalSpinner">
                        <div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Chargement...</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- le formulaire de commentaire sera injecté ici -->
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        if (window.TomSelect) {
            document.querySelectorAll('.js-deroule-select').forEach((select) => {
                if (!select.tomselect) {
                    new TomSelect(select, {
                        placeholder: select.dataset.placeholder || 'Rechercher un chant',
                        allowEmptyOption: true,
                        create: false,
                        maxOptions: 500,
                    });
                }
            });
        }

        const modalEl = document.getElementById('commentsModal');
        const bsModal = new bootstrap.Modal(modalEl);

        // ouverture : charger la conversation (HTML complet) et en extraire les parties utiles
        document.querySelectorAll('.open-comments').forEach(btn => {
            btn.addEventListener('click', async function () {
                const weddingId = this.dataset.wedding;
                const songTypeId = this.dataset.songtype;
                const url = `/comments/${weddingId}/${songTypeId}`;

                const body = modalEl.querySelector('.modal-body');
                const footer = modalEl.querySelector('.modal-footer');
                body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Chargement...</span></div></div>';
                footer.innerHTML = '';
                bsModal.show();

                try {
                    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const text = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');

                    // extraire titre, boîte de commentaires et formulaire
                    const header = doc.querySelector('h2');
                    const commentsBox = doc.querySelector('#comments-box');
                    // formulaire de commentaire (dans .card-footer ou premier form présent)
                    const form = doc.querySelector('.card-footer form') || doc.querySelector('form');

                    body.innerHTML = '';
                    if (header) body.appendChild(header.cloneNode(true));
                    if (commentsBox) body.appendChild(commentsBox.cloneNode(true));
                    else body.innerHTML += '<p class="text-muted">Aucun commentaire.</p>';

                    footer.innerHTML = '';
                    if (form) {
                        // injecter le form dans le footer et intercepter son envoi pour mise à jour ajax
                        const injectedForm = form.cloneNode(true);
                        footer.appendChild(injectedForm);

                        injectedForm.addEventListener('submit', async function (evt) {
                            evt.preventDefault();
                            const fd = new FormData(injectedForm);
                            const action = injectedForm.getAttribute('action') || url;
                            const method = (injectedForm.getAttribute('method') || 'POST').toUpperCase();

                            try {
                                const response = await fetch(action, { method: method, body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                                if (!response.ok) {
                                    throw new Error('Requête invalide');
                                }

                                // après soumission, recharger la conversation pour afficher le nouveau message
                                const refreshed = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                                const refreshedText = await refreshed.text();
                                const refreshedDoc = new DOMParser().parseFromString(refreshedText, 'text/html');
                                const newComments = refreshedDoc.querySelector('#comments-box');
                                const newForm = refreshedDoc.querySelector('.card-footer form') || refreshedDoc.querySelector('form');

                                body.querySelector('h2')?.remove();
                                if (newComments) {
                                    const old = body.querySelector('#comments-box');
                                    if (old) {
                                        old.replaceWith(newComments.cloneNode(true));
                                    } else {
                                        body.appendChild(newComments.cloneNode(true));
                                    }
                                }

                                if (newForm) {
                                    footer.innerHTML = '';
                                    footer.appendChild(newForm.cloneNode(true));
                                }
                            } catch (err) {
                                console.error(err);
                                alert('Erreur lors de l\'envoi du commentaire.');
                            }
                        });
                    } else {
                        footer.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
                    }
                } catch (err) {
                    console.error(err);
                    body.innerHTML = '<p class="text-danger">Impossible de charger les commentaires.</p>';
                    modalEl.querySelector('.modal-footer').innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
                }
            });
        });
    });
    </script>
 </div>
 {% endblock %}