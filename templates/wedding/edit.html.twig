{% extends 'base.html.twig' %}

{% block title %}
	{{ wedding.id ? 'Modifier le mariage' : 'Ajouter un mariage' }}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
{% endblock %}

{% block body %}
	<div class="container-xl py-5">
		<div class="wizard-layout {{ wedding.id ? 'wizard-layout--full' : '' }}" id="weddingWizard" data-default-step="{{ initialWizardStep|default(0) }}">
			<section class="wizard-panel">
				{{ form_start(form, {'attr': {'id': 'weddingForm'}}) }}
				{% set currentPaymentOption = selectedPaymentOption ?: '' %}
				{% set availableSongsByType = availableSongsByType|default({}) %}
				{% set availableSongsByTypeInMusiciansRepo = availableSongsByTypeInMusiciansRepo|default({}) %}

				<header class="wizard-header">
					<div class="wizard-header__intro">
						<h2 class="wizard-panel__title">{{ wedding.id ? 'Modifier le mariage' : 'Ajouter un mariage' }}</h2>
						<p class="wizard-header__meta mb-0">
							<span>
								{% if wedding.marie or wedding.mariee or wedding.marieFirstName or wedding.marieeFirstName %}
									{% if wedding.marie %}
										{{ wedding.marie.fullName }}
									{% elseif wedding.marieFirstName %}
										{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}{% else %}Mari√© √† compl√©ter
									{% endif %}
									&amp;
									{% if wedding.mariee %}
										{{ wedding.mariee.fullName }}
									{% elseif wedding.marieeFirstName %}
										{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}{% else %}Mari√©e √† compl√©ter
									{% endif %}
								{% else %}
									Identifiez le couple pour personnaliser la collaboration.
								{% endif %}
							</span>
							{% if wedding.date %}
								<span>&mdash;
									{{ wedding.date|date('d/m/Y') }}</span>
							{% endif %}
							{% if wedding.church %}
								<span>&mdash;
									{{ wedding.church }}</span>
							{% endif %}
						</p>
					</div>
					<div class="wizard-header__actions">
						<button type="submit" class="btn btn-primary btn-rounded btn-icon">
							Enregistrer
						</button>
						{% if wedding.id %}
							<button type="button" class="btn btn-outline-primary btn-rounded btn-icon" data-bs-toggle="modal" data-bs-target="#inviteModal">
								<i class="bi bi-envelope-plus"></i>
								Inviter
							</button>
						{% endif %}
						<a href="{{ wedding.id ? path('app_wedding_view', {'id': wedding.id}) : path('app_wedding_index') }}" id="cancelBtn" class="btn btn-outline-secondary btn-rounded">Annuler</a>
					</div>
				</header>

				{{ form_errors(form) }}

				<input type="hidden" name="payment_option" id="payment_option_input" value="{{ selectedPaymentOption }}">
				<input type="hidden" name="user_role" id="user_role_input" value="">
				<input type="hidden" name="current_step" id="current_step_input" value="{{ initialWizardStep|default(0) }}">
				<input type="hidden" name="stay_on_edit" id="stay_on_edit_input" value="0">

				<div class="wizard-stepper" id="weddingStepper">
					<button type="button" class="wizard-stepper__item active" data-step="0">
						Essentiels<br><small>Date &amp; lieu</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="1">
						Couple<br><small>Coordonn√©es</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="2">
						Intervenants<br><small>Musiciens &amp; paroisse</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="3">
						R√©pertoire<br><small>D√©roul√© &amp; validations</small>
					</button>
					{% if not isCouple %}
						<button type="button" class="wizard-stepper__item" data-step="4">
							Suivi<br><small>Finances &amp; archive</small>
						</button>
					{% endif %}
					{% if isMusician|default(false) %}
						<button type="button" class="wizard-stepper__item" data-step="5">
							Notes<br><small>Espace musicien</small>
						</button>
					{% endif %}
				</div>

				<div class="wizard-steps">
					<div class="wizard-step active" data-step="0">
						<div class="form-grid">
							<div class="form-card">
								<div class="form-card__title">
									<span>Calendrier</span>
									<h3 class="mb-0">Renseignements essentiels</h3>
								</div>
								{% set isMesse = form.messe.vars.data ?? false %}
								<div class="mb-4">
									<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Format de la c√©l√©bration</span>
									<div class="d-flex flex-wrap gap-2">
										<button type="button" class="btn btn-validation js-toggle-option {{ isMesse ? 'is-active' : '' }}" data-target="#{{ form.messe.vars.id }}" data-value="1">
											Messe
										</button>
										<button type="button" class="btn btn-validation js-toggle-option {{ isMesse ? '' : 'is-active' }}" data-target="#{{ form.messe.vars.id }}" data-value="0">
											C√©l√©bration
										</button>
									</div>
									{{ form_widget(form.messe, {'attr': {'class': 'd-none js-toggle-input'}}) }}
									{{ form_errors(form.messe) }}
								</div>
								<div class="row g-3">
									<div class="col-sm-6">
										{{ form_row(form.date, {
                                    'label_attr': {'class': 'form-label-sm'},
                                    'attr': {
                                        'class': (form.date.vars.attr.class|default('') ~ ' js-date')|trim,
                                        'placeholder': 'jj/mm/aaaa',
                                        'inputmode': 'numeric',
                                        'autocomplete': 'off'
                                    }
                                }) }}
									</div>
									<div class="col-sm-6">
										{{ form_row(form.time, {
                                    'label_attr': {'class': 'form-label-sm'},
                                    'attr': {
                                        'class': (form.time.vars.attr.class|default('') ~ ' js-time')|trim,
                                        'placeholder': 'HH:MM',
                                        'inputmode': 'numeric',
                                        'autocomplete': 'off'
                                    }
                                }) }}
									</div>
								</div>
							</div>
							<div class="form-card">
								<div class="form-card__title">
									<span>Localisation</span>
									<h3 class="mb-0">Lieu de la c√©l√©bration</h3>
								</div>
								{{ form_row(form.parish, {'label_attr': {'class': 'form-label-sm'}}) }}
								{{ form_row(form.church, {'label_attr': {'class': 'form-label-sm'}}) }}
								{{ form_row(form.addressLine1, {'label_attr': {'class': 'form-label-sm'}}) }}
								{{ form_row(form.addressLine2, {'label_attr': {'class': 'form-label-sm'}}) }}
								{{ form_row(form.addressPostalCodeAndCity, {'label_attr': {'class': 'form-label-sm'}}) }}
							</div>
						</div>
					</div>

					<div class="wizard-step" data-step="1">
						<div class="participant-grid">
							<div>
								<div class="participant-card">
									<div class="participant-card__header">
										<h3 class="mb-0">Futur mari√©</h3>
										<div class="d-flex flex-column flex-md-row gap-1 gap-md-2 align-items-end align-items-md-center">
											{% if wedding.marie %}
												<span class="badge rounded-pill bg-success text-white">
													<i class="bi bi-check-circle me-1"></i>Utilisateur rattach√©
												</span>
												<span class="badge rounded-pill bg-light text-secondary">{{ wedding.marie.email }}</span>
											{% else %}
												<span class="badge rounded-pill bg-warning text-dark">
													<i class="bi bi-exclamation-triangle me-1"></i>Aucun utilisateur rattach√©
												</span>
											{% endif %}
										</div>
									</div>

									{% if wedding.marie %}
										<div class="d-flex align-items-center gap-3 mb-3">
											{% if wedding.marie.profilePictureName %}
												<img src="{{ vich_uploader_asset(wedding.marie, 'profilePictureFile') }}" class="participant-avatar" alt="{{ wedding.marie.firstName|default('Mari√©') }}">
											{% else %}
												<div class="participant-avatar participant-avatar--placeholder">
													{{ wedding.marie.firstName|default('')|slice(0,1)|upper ~ wedding.marie.name|default('')|slice(0,1)|upper ?: '-' }}
												</div>
											{% endif %}
											<div class="alert alert-info mb-0 flex-grow-1">
												<i class="bi bi-info-circle me-2"></i>Les informations affich√©es proviennent du profil utilisateur de
												<strong>{{ wedding.marie.fullName }}</strong>.
											</div>
										</div>
										<div class="row g-3">
											<div class="col-sm-6">
												<label class="form-label-sm">Pr√©nom</label>
												<div class="form-control-plaintext">{{ wedding.marie.firstName }}</div>
											</div>
											<div class="col-sm-6">
												<label class="form-label-sm">Nom</label>
												<div class="form-control-plaintext">{{ wedding.marie.name }}</div>
											</div>
											<div class="col-sm-6">
												<label class="form-label-sm">Email</label>
												<div class="form-control-plaintext">{{ wedding.marie.email }}</div>
											</div>
											<div class="col-sm-6">
												<label class="form-label-sm">T√©l√©phone</label>
												<div class="form-control-plaintext">{{ wedding.marie.telephone ?: 'Non renseign√©' }}</div>
											</div>
											<div class="col-12">
												<label class="form-label-sm">Adresse ligne 1</label>
												<div class="form-control-plaintext">{{ wedding.marie.addressLine1 ?: 'Non renseign√©' }}</div>
											</div>
											<div class="col-12">
												<label class="form-label-sm">Adresse ligne 2</label>
												<div class="form-control-plaintext">{{ wedding.marie.addressLine2 ?: 'Non renseign√©' }}</div>
											</div>
											<div class="col-12">
												<label class="form-label-sm">Code postal & ville</label>
												<div class="form-control-plaintext">{{ wedding.marie.addressPostalCodeAndCity ?: 'Non renseign√©' }}</div>
											</div>
										</div>
									{% else %}
										<div class="row g-3">
											<div class="col-sm-6">{{ form_row(form.marieFirstName, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-sm-6">{{ form_row(form.marieName, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-sm-6">{{ form_row(form.marieEmail, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-sm-6">{{ form_row(form.marieTelephone, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-12">{{ form_row(form.marieAddressLine1, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-12">{{ form_row(form.marieAddressLine2, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-12">{{ form_row(form.marieAddressPostalCodeAndCity, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
										</div>
									{% endif %}

									{% if not wedding.marie and wedding.id %}
										<div class="mt-3">
											<button type="button" class="btn btn-primary invite-trigger" data-invite-role="marie" data-bs-toggle="modal" data-bs-target="#inviteModal">
												<i class="bi bi-envelope-heart"></i>
												Inviter le futur mari√©
											</button>
											<p class="text-muted small mt-2 mb-0">En invitant le mari√©, ses coordonn√©es seront automatiquement synchronis√©es avec son profil utilisateur.</p>
										</div>
									{% elseif not wedding.marie %}
										<div class="alert alert-light mt-3 mb-0">
											<i class="bi bi-info-circle me-2"></i>Sauvegardez le mariage pour pouvoir envoyer une invitation.
										</div>
									{% endif %}
								</div>
							</div>

							<div>
								<div class="participant-card">
									<div class="participant-card__header">
										<h3 class="mb-0">Future mari√©e</h3>
										<div class="d-flex flex-column flex-md-row gap-1 gap-md-2 align-items-end align-items-md-center">
											{% if wedding.mariee %}
												<span class="badge rounded-pill bg-success text-white">
													<i class="bi bi-check-circle me-1"></i>Utilisateur rattach√©
												</span>
												<span class="badge rounded-pill bg-light text-secondary">{{ wedding.mariee.email }}</span>
											{% else %}
												<span class="badge rounded-pill bg-warning text-dark">
													<i class="bi bi-exclamation-triangle me-1"></i>Aucun utilisateur rattach√©
												</span>
											{% endif %}
										</div>
									</div>

									{% if wedding.mariee %}
										<div class="d-flex align-items-center gap-3 mb-3">
											{% if wedding.mariee.profilePictureName %}
												<img src="{{ vich_uploader_asset(wedding.mariee, 'profilePictureFile') }}" class="participant-avatar" alt="{{ wedding.mariee.firstName|default('Mari√©e') }}">
											{% else %}
												<div class="participant-avatar participant-avatar--placeholder">
													{{ wedding.mariee.firstName|default('')|slice(0,1)|upper ~ wedding.mariee.name|default('')|slice(0,1)|upper ?: '-' }}
												</div>
											{% endif %}
											<div class="alert alert-info mb-0 flex-grow-1">
												<i class="bi bi-info-circle me-2"></i>Les informations affich√©es proviennent du profil utilisateur de
												<strong>{{ wedding.mariee.fullName }}</strong>.
											</div>
										</div>
										<div class="row g-3">
											<div class="col-sm-6">
												<label class="form-label-sm">Pr√©nom</label>
												<div class="form-control-plaintext">{{ wedding.mariee.firstName }}</div>
											</div>
											<div class="col-sm-6">
												<label class="form-label-sm">Nom</label>
												<div class="form-control-plaintext">{{ wedding.mariee.name }}</div>
											</div>
											<div class="col-sm-6">
												<label class="form-label-sm">Email</label>
												<div class="form-control-plaintext">{{ wedding.mariee.email }}</div>
											</div>
											<div class="col-sm-6">
												<label class="form-label-sm">T√©l√©phone</label>
												<div class="form-control-plaintext">{{ wedding.mariee.telephone ?: 'Non renseign√©' }}</div>
											</div>
											<div class="col-12">
												<label class="form-label-sm">Adresse ligne 1</label>
												<div class="form-control-plaintext">{{ wedding.mariee.addressLine1 ?: 'Non renseign√©' }}</div>
											</div>
											<div class="col-12">
												<label class="form-label-sm">Adresse ligne 2</label>
												<div class="form-control-plaintext">{{ wedding.mariee.addressLine2 ?: 'Non renseign√©' }}</div>
											</div>
											<div class="col-12">
												<label class="form-label-sm">Code postal & ville</label>
												<div class="form-control-plaintext">{{ wedding.mariee.addressPostalCodeAndCity ?: 'Non renseign√©' }}</div>
											</div>
										</div>
									{% else %}
										<div class="row g-3">
											<div class="col-sm-6">{{ form_row(form.marieeFirstName, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-sm-6">{{ form_row(form.marieeName, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-sm-6">{{ form_row(form.marieeEmail, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-sm-6">{{ form_row(form.marieeTelephone, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-12">{{ form_row(form.marieeAddressLine1, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-12">{{ form_row(form.marieeAddressLine2, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
											<div class="col-12">{{ form_row(form.marieeAddressPostalCodeAndCity, {'label_attr': {'class': 'form-label-sm'}}) }}</div>
										</div>
									{% endif %}

									{% if not wedding.mariee and wedding.id %}
										<div class="mt-3">
											<button type="button" class="btn btn-primary invite-trigger" data-invite-role="mariee" data-bs-toggle="modal" data-bs-target="#inviteModal">
												<i class="bi bi-envelope-heart"></i>
												Inviter la future mari√©e
											</button>
											<p class="text-muted small mt-2 mb-0">En invitant la mari√©e, ses coordonn√©es seront automatiquement synchronis√©es avec son profil utilisateur.</p>
										</div>
									{% elseif not wedding.mariee %}
										<div class="alert alert-light mt-3 mb-0">
											<i class="bi bi-info-circle me-2"></i>Sauvegardez le mariage pour pouvoir envoyer une invitation.
										</div>
									{% endif %}
								</div>
							</div>
						</div>
					</div>

					<div class="wizard-step" data-step="2">
						<div class="form-grid">
							<div class="form-card">
								<div class="form-card__title">
									<span>Musiciens</span>
									<h3 class="mb-0">Coordonner les musiciens</h3>
								</div>
								<div class="d-flex align-items-center gap-2 text-muted small mb-3">
									<span class="badge text-bg-light">{{ wedding.musicians|length }}</span>
									<span>Musicien(s)</span>
								</div>
								{% if wedding.musicians|length > 0 %}
									<ul class="list-group list-group-flush">
										{% for musician in wedding.musicians %}
											<li class="list-group-item px-0 border-0 py-3 d-flex justify-content-between align-items-start gap-3">
												<div>
													<span class="fw-semibold">{{ musician.fullName ?? musician.email }}</span>
													<div class="text-muted small">{{ musician.email }}</div>
													{% if musician.telephone %}
														<div class="text-muted small">
															<i class="bi bi-telephone me-1"></i>
															{{ musician.telephone }}</div>
													{% endif %}
												</div>
												{% if wedding.id %}
													<button type="button" class="btn btn-sm btn-outline-danger ms-auto js-remove-intervenant" data-form="remove-musician-{{ musician.id }}" data-confirm="Retirer ce musicien du mariage ?" title="Retirer">
														<i class="bi bi-trash"></i>
													</button>
												{% endif %}
											</li>
										{% endfor %}
									</ul>
								{% else %}
									<p class="text-muted small mb-0">Aucun musicien n'est encore associ√© pour le moment.</p>
								{% endif %}
								<div class="d-flex flex-wrap gap-2 mt-3">
									{% if wedding.id %}
										<button type="button" class="btn btn-outline-primary btn-rounded invite-trigger" data-invite-role="musicien" data-bs-toggle="modal" data-bs-target="#inviteModal">
											<i class="bi bi-person-plus"></i>
											Inviter un musicien
										</button>
									{% else %}
										<p class="text-muted small mb-0">Sauvegardez le mariage pour inviter un intervenant.</p>
									{% endif %}
								</div>
							</div>

							<div class="form-card">
								<div class="form-card__title">
									<span>Paroisse</span>
									<h3 class="mb-0">Collaborer avec la paroisse</h3>
								</div>
								<div class="d-flex align-items-center gap-2 text-muted small mb-3">
									<span class="badge text-bg-light">{{ wedding.parishUsers|length }}</span>
									<span>Contact(s)</span>
								</div>
								{% if wedding.parishUsers|length > 0 %}
									<ul class="list-group list-group-flush">
										{% for parishUser in wedding.parishUsers %}
											<li class="list-group-item px-0 border-0 py-3 d-flex justify-content-between align-items-start gap-3">
												<div>
													<span class="fw-semibold">{{ parishUser.fullName ?? parishUser.email }}</span>
													<div class="text-muted small">{{ parishUser.email }}</div>
													{% if parishUser.telephone %}
														<div class="text-muted small">
															<i class="bi bi-telephone me-1"></i>
															{{ parishUser.telephone }}</div>
													{% endif %}
												</div>
												{% if wedding.id %}
													<button type="button" class="btn btn-sm btn-outline-danger ms-auto js-remove-intervenant" data-form="remove-parish-{{ parishUser.id }}" data-confirm="Retirer ce contact paroissial ?" title="Retirer">
														<i class="bi bi-trash"></i>
													</button>
												{% endif %}
											</li>
										{% endfor %}
									</ul>
								{% else %}
									<p class="text-muted small mb-0">Aucun contact paroissial n'est encore associ√© √† ce mariage.</p>
								{% endif %}
								<div class="d-flex flex-wrap gap-2 mt-3">
									{% if wedding.id %}
										<button type="button" class="btn btn-outline-primary btn-rounded invite-trigger" data-invite-role="paroisse" data-bs-toggle="modal" data-bs-target="#inviteModal">
											<i class="bi bi-building"></i>
											Inviter la paroisse
										</button>
									{% else %}
										<p class="text-muted small mb-0">Sauvegardez le mariage pour inviter un intervenant.</p>
									{% endif %}
								</div>
							</div>

							<div class="form-card">
								<div class="form-card__title">
									<span>C√©l√©brant</span>
									<h3 class="mb-0">Coordonn√©es du pr√™tre</h3>
								</div>
								{{ form_row(form.priestFirstName, {'label_attr': {'class': 'form-label-sm'}}) }}
								{{ form_row(form.priestLastName, {'label_attr': {'class': 'form-label-sm'}}) }}
								{{ form_row(form.priestPhoneNumber, {'label_attr': {'class': 'form-label-sm'}}) }}
								{{ form_row(form.priestEMail, {'label_attr': {'class': 'form-label-sm'}}) }}
							</div>
						</div>
					</div>

					<div
						class="wizard-step" data-step="3">
						<!-- Petite card de l√©gende pour les s√©lections -->
						<div class="mb-4">
							<div class="alert alert-info mb-0 deroule-legend">
								<span class="deroule-legend__intro">Les ic√¥nes indiquent la disponibilit√© d'un chant  :</span>
								<ul class="deroule-legend__list">
									<li><strong>üéπ</strong> <span>Dans le r√©pertoire d'au moins un musicien</span></li>
									<li><strong>‚ö†Ô∏è</strong> <span>Non pr√©sent dans le r√©pertoire d'au moins un musicien</span></li>
									<li><strong>‚ú®</strong> <span>Suggestion</span></li>
									<li><strong>üìñ</strong> <span>Texte uniquement</span></li>
								</ul>
							</div>
						</div>

						<div class="deroule-container">
							{% set types = songTypes is defined ? songTypes : [] %}
							{% set groups = {} %}
							{% for t in types %}
								{% set period = t.celebrationPeriod %}
								{% set label = period ? period.fullName : 'Autres' %}
								{% set color = period ? period.color : null %}
								{% set orderValue = period and period.periodOrder is not null ? period.periodOrder : 999 %}
								{% set key = '%03d'|format(orderValue) ~ '-' ~ (period ? period.id : 'default') %}
								{% set existing = groups[key]|default({ 'label': label, 'color': color, 'order': orderValue, 'types': [] }) %}
								{% set groups = groups|merge({
                            (key): existing|merge({
                                'label': label,
                                'color': color,
                                'order': orderValue,
                                'types': existing.types|merge([t])
                            })
                            }) %}
							{% endfor %}
							{% set orderedGroupKeys = groups|keys|sort %}

							{% if groups is empty %}

								<div class="alert alert-light mb-0">Aucun type de chant d√©fini. Ajoute des types dans l'administration.</div>
							{% else %}
								<div class="deroule-header d-none d-lg-flex">
									<div class="deroule-col-type">TYPE</div>
									<div class="deroule-col-choice">VOTRE CHOIX</div>
									<div class="deroule-col-check" style="width:30px;">ACTIONS</div>
									<div class="deroule-col-check">VALIDATIONS</div>
									<div class="deroule-col-check">EN CHARGE</div>
									<div class="deroule-col-comments">COM.</div>
								</div>

								<div class="deroule-groups">
									{% for groupKey in orderedGroupKeys %}
										{% set group = groups[groupKey] %}
										{% set sanitizedLabel = group.label ? group.label|replace({' ': '_'}) : 'Autres' %}
										<div class="deroule-group">
											<div class="deroule-group-header" {% if group.color %} style="border-left: 4px solid {{ group.color }}; background-color: {{ group.color }}" {% endif %}>{{ group.label }}</div>
											<div class="deroule-group-body">
												{% for type in group.types %}
													{% set songsForType = availableSongsByType[type.id]|default(type.songs) %}
													{% set selectionState = songSelectionsByType[type.id]|default({}) %}
													{% set selectedSongId = selectionState.songId ?? null %}
													{% set validatedMusician = selectionState.validatedByMusician ?? false %}
													{% set validatedParish = selectionState.validatedByParish ?? false %}
													<div class="deroule-row">
														<div>
															<span class="deroule-type-badge"  style="{% if group.color %}background-color: {{ group.color }}; color: #FFFFFF;{% endif %}; max-width: 160px; width: 160px;" >{{ type.name }}</span>
														</div>
														<div class="d-flex gap-2 align-items-center">
															<select name="deroule[{{ sanitizedLabel }}][{{ type.id|default(loop.index) }}]" class="form-select deroule-select deroule-select--large js-deroule-select" data-placeholder="Rechercher un chant" data-song-type="{{ type.id }}" data-song-type-id="{{ type.id }}" style="flex: 1;">
																<option value="" {% if selectedSongId is null %} selected {% endif %}>Aucune s√©lection</option>
																{% if songsForType|length > 0 %}
																	{% for song in songsForType %}
																		<option value="{{ song.id }}" {% if selectedSongId is not null and song.id == selectedSongId %} selected {% endif %}>
																			{% if not song.song %}üìñ
																				{% elseif song.suggestion %}‚ú®
																				{% elseif song in availableSongsByTypeInMusiciansRepo[type.id]|default([]) %}üéπ
																				{% else %}‚ö†Ô∏è
																			{% endif %}
																			{{ song.name ?? (song.title ?? 'Titre inconnu') }}
																			{% if song.suggestion %}
																				(suggestion)
																			{% endif %}
																		</option>
																	{% endfor %}
																{% else %}
																	<option disabled>Pas de chants disponibles</option>
																{% endif %}
															</select>
															<button type="button" class="btn btn-sm btn-outline-primary js-suggest-song" data-song-type="{{ type.id }}" title="Sugg√©rer un nouveau chant">
																<i class="bi bi-plus-circle"></i>
															</button>
                                                            <button type="button" class="btn btn-sm btn-outline-secondary js-preview-song" data-song-type="{{ type.id }}" data-song-id="{{ selectedSongId }}" title="Pr√©visualiser le chant" {% if selectedSongId is null %} disabled {% endif %}>
                                                                <i class="bi bi-eye"></i>
                                                            </button>
														</div>
														<div>
															<input type="hidden" name="deroule_validation_musician[{{ type.id }}]" value="{{ validatedMusician ? '1' : '0' }}" data-validation-input="musician-{{ type.id }}">
															<button type="button" class="btn btn-validation js-validation-toggle {{ validatedMusician ? 'is-active' : '' }}" data-role="musician" data-type="{{ type.id }}">MUS</button>
														</div>
														<div>
															<input type="hidden" name="deroule_validation_parish[{{ type.id }}]" value="{{ validatedParish ? '1' : '0' }}" data-validation-input="parish-{{ type.id }}">
															<button type="button" class="btn btn-validation js-validation-toggle {{ validatedParish ? 'is-active' : '' }}" data-role="parish" data-type="{{ type.id }}">PAR</button>
														</div>
														<div class="deroule-person-field">
															<input type="text" class="form-control form-control-sm deroule-person-input" name="deroule_personne[{{ type.id }}]" value="{{ selectionState.personneEnCharge|default('') }}" placeholder="Personne en charge" maxlength="255">
														</div>
														<div>
															{% if wedding.id %}
																{% set commentsCount = selectionState.commentsCount|default(0) %}
																<div class="d-flex align-items-center gap-2">
																	<button type="button" class="btn btn-sm btn-outline-secondary open-comments" data-wedding="{{ wedding.id }}" data-songtype="{{ type.id }}" aria-haspopup="dialog" aria-controls="commentsModal">
																		<i class="bi bi-chat-dots"></i>
																	</button>
																	{% if commentsCount > 0 %}
																		<span class="badge rounded-pill text-bg-secondary" aria-label="{{ commentsCount }} commentaire{{ commentsCount > 1 ? 's' : '' }}">
																			{{ commentsCount }}
																		</span>
																	{% endif %}
																</div>
															{% else %}
																<button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Sauvegardez le mariage pour activer les commentaires">
																	<i class="bi bi-chat-dots"></i>
																</button>
															{% endif %}
														</div>
													</div>
												{% endfor %}
											</div>
										</div>
									{% endfor %}
								</div>
							{% endif %}
						</div>
						{{ form_widget(form.songs, {'attr': {'class': 'd-none'}}) }}
					</div>

					{% if not isCouple %}
						<div class="wizard-step" data-step="4">
							<div class="form-grid">
								<div class="form-card">
									<div class="form-card__title">
										<span>Finances</span>
										<h3 class="mb-0">Suivi des montants</h3>
									</div>
									{% set paymentStatus = {
                            'label': 'Statut non d√©fini',
                            'badge': 'secondary'
                        } %}
									{% if wedding.isPaid %}
										{% set paymentStatus = {
                                'label': 'Mariage r√©gl√©',
                                'badge': 'success'
                            } %}
									{% else %}
										{% if wedding.paymentOption == 'delegated' %}
											{% set paymentStatus = {
                                    'label': 'En attente du paiement des mari√©s',
                                    'badge': 'warning'
                                } %}
										{% elseif wedding.paymentOption == 'card_pending_partner' %}
											{% set paymentStatus = {
                                    'label': 'Paiement partenaire en cours',
                                    'badge': 'warning'
                                } %}
										{% elseif wedding.paymentOption == 'card_partner' %}
											{% set paymentStatus = {
                                    'label': 'Paiement CB partenaire confirm√©',
                                    'badge': 'success'
                                } %}
										{% elseif wedding.paymentOption == 'card_user' %}
											{% set paymentStatus = {
                                    'label': 'Paiement en ligne √† finaliser',
                                    'badge': 'info'
                                } %}
										{% elseif wedding.paymentOption == 'card_couple' %}
											{% set paymentStatus = {
                                    'label': 'Pay√© par le couple',
                                    'badge': 'success'
                                } %}
										{% elseif wedding.paymentOption == 'credit' %}
											{% set paymentStatus = {
                                    'label': 'R√©gl√© via cr√©dits',
                                    'badge': 'success'
                                } %}
										{% endif %}
									{% endif %}
									<div class="wizard-finance-inputs">
										<div class="wizard-finance-field">
											<label for="{{ form.montantTotal.vars.id }}" class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Montant de la prestation
												<span class="text-danger">*</span>
											</label>
											{{ form_widget(form.montantTotal, {'attr': form.montantTotal.vars.attr|merge({'required': 'required'})}) }}
											{{ form_errors(form.montantTotal) }}
										</div>
										<div class="wizard-finance-field">
											<label for="{{ form.montantPaye.vars.id }}" class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Montant d√©j√† vers√©
												<span class="text-danger">*</span>
											</label>
											{{ form_widget(form.montantPaye, {'attr': form.montantPaye.vars.attr|merge({'required': 'required'})}) }}
											{{ form_errors(form.montantPaye) }}
										</div>
									</div>
									<div class="wizard-finance-grid">
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Acompte</div>
											<div class="wizard-finance-value">
												{% if wedding.montantTotal and wedding.montantPaye is not null and wedding.montantTotal > 0 %}
													{{ ((wedding.montantPaye / wedding.montantTotal) * 100)|round(0) }}
													%
												{% else %}
													-
												{% endif %}
											</div>
										</div>
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Reste d√ª</div>
											<div class="wizard-finance-value">
												{% if wedding.montantTotal is not null and wedding.montantPaye is not null %}
													{{ (wedding.montantTotal - wedding.montantPaye)|number_format(2, '.', ' ') }}
													‚Ç¨
												{% else %}
													-
												{% endif %}
											</div>
										</div>
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Statut du paiement NMDM</div>
											<div class="wizard-finance-value">
												<span class="badge text-bg-{{ paymentStatus.badge }}">{{ paymentStatus.label }}</span>
											</div>
										</div>
									</div>
								</div>

								<div class="form-card">
									<div class="form-card__title">
										<span>Cl√¥ture</span>
										<h3 class="mb-0">Archive &amp; options</h3>
									</div>
									{% set isArchived = form.archive.vars.data ?? false %}
									<div class="mb-3">
										<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Statut du dossier</span>
										<div class="d-flex flex-wrap gap-2">
											<button type="button" class="btn btn-validation js-toggle-option {{ isArchived ? '' : 'is-active' }}" data-target="#{{ form.archive.vars.id }}" data-value="0">
												Actif
											</button>
											<button type="button" class="btn btn-validation js-toggle-option {{ isArchived ? 'is-active' : '' }}" data-target="#{{ form.archive.vars.id }}" data-value="1">
												Archiv√©
											</button>
										</div>
										{{ form_widget(form.archive, {'attr': {'class': 'd-none js-toggle-input'}}) }}
										{{ form_errors(form.archive) }}
									</div>
									<p class="mb-0 small text-muted">Archivez un mariage une fois la c√©l√©bration pass√©e pour conserver un historique propre.</p>
								</div>
							</div>
						</div>
					{% endif %}

					{# Step 5: Notes Musiciens (r√©serv√© aux musiciens) #}
					{% if isMusician|default(false) %}
						<div class="wizard-step" data-step="5">
							<div class="form-grid form-grid--single">
								<div class="form-card">
									<div class="form-card__title">
										<span>Espace Musicien</span>
										<h3 class="mb-0">Notes pour les musiciens</h3>
									</div>
									<p class="text-muted mb-3">
										Cet espace vous permet de r√©diger des notes en
										<strong>Markdown</strong>
										pour pr√©parer la c√©l√©bration. 
										                            Ces notes sont visibles uniquement par les musiciens associ√©s √† ce mariage.
									</p>

									<div class="markdown-container">
										<div class="markdown-tabs">
											<button type="button" class="markdown-tab active" data-tab="edit">
												<i class="bi bi-pencil me-1"></i>
												√âditer
											</button>
											<button type="button" class="markdown-tab" data-tab="preview">
												<i class="bi bi-eye me-1"></i>
												Aper√ßu
											</button>
										</div>

										<div class="markdown-toolbar" id="markdownToolbar">
											<div class="markdown-toolbar__group">
												<button type="button" class="markdown-toolbar__btn" data-md-action="h1" title="Titre 1 (Ctrl+1)">
													<span class="markdown-toolbar__icon">H1</span>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="h2" title="Titre 2 (Ctrl+2)">
													<span class="markdown-toolbar__icon">H2</span>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="h3" title="Titre 3 (Ctrl+3)">
													<span class="markdown-toolbar__icon">H3</span>
												</button>
											</div>
											<div class="markdown-toolbar__separator"></div>
											<div class="markdown-toolbar__group">
												<button type="button" class="markdown-toolbar__btn" data-md-action="bold" title="Gras (Ctrl+B)">
													<i class="bi bi-type-bold"></i>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="italic" title="Italique (Ctrl+I)">
													<i class="bi bi-type-italic"></i>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="strikethrough" title="Barr√©">
													<i class="bi bi-type-strikethrough"></i>
												</button>
											</div>
											<div class="markdown-toolbar__separator"></div>
											<div class="markdown-toolbar__group">
												<button type="button" class="markdown-toolbar__btn" data-md-action="ul" title="Liste √† puces">
													<i class="bi bi-list-ul"></i>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="ol" title="Liste num√©rot√©e">
													<i class="bi bi-list-ol"></i>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="checklist" title="Checklist">
													<i class="bi bi-check2-square"></i>
												</button>
											</div>
											<div class="markdown-toolbar__separator"></div>
											<div class="markdown-toolbar__group">
												<button type="button" class="markdown-toolbar__btn" data-md-action="quote" title="Citation">
													<i class="bi bi-quote"></i>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="code" title="Code en ligne">
													<i class="bi bi-code"></i>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="codeblock" title="Bloc de code">
													<i class="bi bi-code-square"></i>
												</button>
											</div>
											<div class="markdown-toolbar__separator"></div>
											<div class="markdown-toolbar__group">
												<button type="button" class="markdown-toolbar__btn" data-md-action="link" title="Lien">
													<i class="bi bi-link-45deg"></i>
												</button>
												<button type="button" class="markdown-toolbar__btn" data-md-action="hr" title="Ligne horizontale">
													<i class="bi bi-hr"></i>
												</button>
											</div>
										</div>

										<div class="markdown-content">
											<div class="markdown-edit-pane active" data-pane="edit">
												{{ form_widget(form.notesMusiciens, {
                                        'attr': {
                                            'class': 'form-control markdown-editor',
                                            'rows': 15,
                                            'placeholder': '# Titre de section

## Sous-titre

Texte normal avec **gras** et *italique*.

- √âl√©ment de liste 1
- √âl√©ment de liste 2

### Exemple de checklist
- [ ] T√¢che √† faire
- [x] T√¢che termin√©e

> Citation ou note importante

```
Bloc de code ou partition
```'
                                        }
                                    }) }}
												{{ form_errors(form.notesMusiciens) }}
											</div>
											<div class="markdown-preview-pane" data-pane="preview">
												<div class="markdown-rendered" id="markdownPreview">
													<p class="text-muted fst-italic">L'aper√ßu appara√Ætra ici...</p>
												</div>
											</div>
										</div>

										<div class="markdown-help mt-3">
											<button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#markdownHelp">
												<i class="bi bi-question-circle me-1"></i>
												Aide Markdown
											</button>
											<div class="collapse mt-2" id="markdownHelp">
												<div class="card card-body small">
													<div class="row g-3">
														<div class="col-md-6">
															<strong>Formatage de texte</strong>
															<ul class="mb-2">
																<li>
																	<code>**texte**</code>
																	‚Üí
																	<strong>gras</strong>
																</li>
																<li>
																	<code>*texte*</code>
																	‚Üí
																	<em>italique</em>
																</li>
																<li>
																	<code>~~texte~~</code>
																	‚Üí
																	<del>barr√©</del>
																</li>
															</ul>
															<strong>Titres</strong>
															<ul class="mb-0">
																<li>
																	<code># Titre 1</code>
																</li>
																<li>
																	<code>## Titre 2</code>
																</li>
																<li>
																	<code>### Titre 3</code>
																</li>
															</ul>
														</div>
														<div class="col-md-6">
															<strong>Listes</strong>
															<ul class="mb-2">
																<li>
																	<code>- item</code>
																	‚Üí liste √† puces</li>
																<li>
																	<code>1. item</code>
																	‚Üí liste num√©rot√©e</li>
																<li>
																	<code>- [ ] t√¢che</code>
																	‚Üí checkbox</li>
															</ul>
															<strong>Autres</strong>
															<ul class="mb-0">
																<li>
																	<code>&gt; texte</code>
																	‚Üí citation</li>
																<li>
																	<code>```code```</code>
																	‚Üí bloc de code</li>
																<li>
																	<code>[lien](url)</code>
																	‚Üí lien</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					{% endif %}
				</div>

				<div class="wizard-actions">
					<div class="wizard-actions__nav">
						<button type="button" class="btn btn-outline-secondary wizard-prev d-none" data-action="prev-step">
							<i class="bi bi-arrow-left"></i>
							Retour
						</button>
						<button type="button" class="btn btn-primary wizard-next" data-action="next-step">
							Continuer
							<i class="bi bi-arrow-right ms-2"></i>
						</button>
					</div>
					<button type="submit" class="btn btn-success wizard-submit d-none" data-action="submit-step">
						<i class="bi bi-check-circle"></i>
						Enregistrer
					</button>
				</div>

				{# Rendre uniquement le token CSRF et les champs syst√®me n√©cessaires #}
				{{ form_row(form._token) }}

				{# Rendre les champs marie/mariee dynamiques s'ils existent #}
				{% if form.marie is defined %}
					<div class="d-none">{{ form_row(form.marie) }}</div>
				{% endif %}
				{% if form.mariee is defined %}
					<div class="d-none">{{ form_row(form.mariee) }}</div>
				{% endif %}

				{{ form_end(form, {'render_rest': false}) }}
			</section>

			{% if wedding.id %}
				<div class="d-none">
					{% for musician in wedding.musicians %}
						<form id="remove-musician-{{ musician.id }}" method="post" action="{{ path('app_wedding_intervenants_remove', {'id': wedding.id, 'type': 'musician', 'userId': musician.id}) }}">
							<input type="hidden" name="_token" value="{{ csrf_token('remove_intervenant_musician_' ~ wedding.id ~ '_' ~ musician.id) }}">
						</form>
					{% endfor %}
					{% for parishUser in wedding.parishUsers %}
						<form id="remove-parish-{{ parishUser.id }}" method="post" action="{{ path('app_wedding_intervenants_remove', {'id': wedding.id, 'type': 'parish', 'userId': parishUser.id}) }}">
							<input type="hidden" name="_token" value="{{ csrf_token('remove_intervenant_parish_' ~ wedding.id ~ '_' ~ parishUser.id) }}">
						</form>
					{% endfor %}
				</div>
			{% endif %}
			{% if not wedding.id %}
				<aside class="wizard-sidecard">
					<div class="wizard-sidecard__inner" id="wizardSideContent">
						<div class="wizard-sidecard__slide active" data-step="0">
							<span class="wizard-badge">
								<i class="bi bi-geo-alt"></i>
								√âtape 1</span>
							<h2 class="wizard-sidecard__title">Cadrez la c√©l√©bration</h2>
							<p class="mb-0">Pr√©cisez le format, la date et le lieu pour d√©clencher les rappels automatiques aupr√®s des partenaires.</p>
							<div class="wizard-tip">
								<i class="bi bi-lightbulb me-2"></i>Plus les informations sont compl√®tes, plus le calendrier partag√© est pertinent.</div>
						</div>
						<div class="wizard-sidecard__slide" data-step="1">
							<span class="wizard-badge">
								<i class="bi bi-people"></i>
								√âtape 2</span>
							<h2 class="wizard-sidecard__title">Pilotez le couple</h2>
							<p class="mb-0">Actualisez les coordonn√©es des mari√©s sans quitter le parcours. Invitez-les instantan√©ment s‚Äôils ne sont pas encore connect√©s.</p>
							<div class="wizard-tip">
								<i class="bi bi-envelope-heart me-2"></i>Les invitations envoy√©es depuis ici h√©ritent automatiquement des cr√©dits disponibles.</div>
						</div>
						<div class="wizard-sidecard__slide" data-step="2">
							<span class="wizard-badge">
								<i class="bi bi-people"></i>
								√âtape 3</span>
							<h2 class="wizard-sidecard__title">Activez les intervenants</h2>
							<p class="mb-0">Invitez les musiciens et la paroisse, centralisez leurs coordonn√©es et suivez l'√©tat des contacts cl√©s.</p>
							<div class="wizard-tip">
								<i class="bi bi-telephone me-2"></i>Ajoutez les d√©tails du c√©l√©brant pour fluidifier la collaboration.</div>
						</div>
						<div class="wizard-sidecard__slide" data-step="3">
							<span class="wizard-badge">
								<i class="bi bi-music-note-beamed"></i>
								√âtape 4</span>
							<h2 class="wizard-sidecard__title">Construisez le d√©roul√©</h2>
							<p class="mb-0">Associez des chants √† chaque moment cl√© et suivez les validations du c√©l√©brant et des musiciens en direct.</p>
							<div class="wizard-tip">
								<i class="bi bi-chat-dots me-2"></i>Les commentaires contextualis√©s restent accessibles depuis chaque type de chant.</div>
						</div>
						<div class="wizard-sidecard__slide" data-step="4">
							<span class="wizard-badge">
								<i class="bi bi-coin"></i>
								√âtape 5</span>
							<h2 class="wizard-sidecard__title">Cl√¥turez le dossier</h2>
							<p class="mb-0">Suivez les montants vers√©s et finalisez les options avant d'archiver le dossier.</p>
							<div class="wizard-tip">
								<i class="bi bi-clipboard-check me-2"></i>Pensez √† archiver le mariage une fois la c√©l√©bration pass√©e pour conserver un historique propre.</div>
						</div>
					</div>
				</aside>
			{% endif %}
		</div>
	</div>

	<div class="modal fade" id="userRoleModal" tabindex="-1" aria-hidden="true" data-autoshow="{{ (shouldOpenRoleModal or (isOnlyUser and not wedding.id)) ? '1' : '0' }}" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Votre r√¥le dans ce mariage</h5>
				</div>
				<div class="modal-body">
					<p class="mb-4">Pour commencer, merci de pr√©ciser votre r√¥le : √™tes-vous le mari√© ou la mari√©e ?</p>
					<div class="d-grid gap-3">
						<button type="button" class="btn btn-outline-primary btn-lg js-user-role-option" data-role="marie">
							<i class="bi bi-person me-2"></i>
							Je suis le mari√©
						</button>
						<button type="button" class="btn btn-outline-primary btn-lg js-user-role-option" data-role="mariee">
							<i class="bi bi-person me-2"></i>
							Je suis la mari√©e
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade payment-option-modal" id="paymentOptionModal" tabindex="-1" aria-hidden="true" data-autoshow="{{ shouldOpenPaymentModal ? '1' : '0' }}" data-intercept="{{ shouldPromptPaymentOption ? '1' : '0' }}">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Choisir l'option de paiement</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body">
					{% if paymentOptionError %}
						<div class="alert alert-danger mb-4">{{ paymentOptionError }}</div>
					{% endif %}
					<p class="text-muted mb-4">S√©lectionnez comment r√©gler la cr√©ation du mariage. Vous pourrez modifier ce choix tant que le paiement n'est pas confirm√©.</p>
					<div class="payment-option-grid">
						<button<i type="button" class="payment-option-card js-payment-option {{ currentPaymentOption == 'credit' ? 'is-selected' }}" data-option="credit" {% if userCredits < 1 %}disabled{% endif %}> <span class="payment-option-card__title"><i class="bi bi-gem"></i> Utiliser 1 cr√©dit</span> <span class="payment-option-card__subtitle">D√©duisez un cr√©dit de votre solde et ouvrez instantan√©ment les invitations.</span> <span class="payment-option-card__meta"> {% if userCredits > 0 %} {{ userCredits }} cr√©dit {{ userCredits > 1 ? 's' : '' }} disponible {{ userCredits > 1 ? 's' : '' }} {% else %} solde insuffisant {% endif %} </span> </button> <button type="button" class="payment-option-card js-payment-option {{ currentPaymentOption == 'card' ? 'is-selected' }}" data-option="card"> <span class="payment-option-card__title"> class="bi bi-credit-card"></i>
						Payer 39,99 ‚Ç¨</span>
					<span class="payment-option-card__subtitle">R√©glez maintenant par carte bancaire √† tarif pr√©f√©rentiel partenaire.</span>
					<span class="payment-option-card__meta">Redirection s√©curis√©e vers Stripe</span>
				</button>
				<button type="button" class="payment-option-card js-payment-option {{ currentPaymentOption == 'later' ? 'is-selected' }}" data-option="later">
					<span class="payment-option-card__title">
						<i class="bi bi-people"></i>
						Laisser les mari√©s payer</span>
					<span class="payment-option-card__subtitle">Cr√©ez le dossier et envoyez une demande de paiement aux mari√©s.</span>
					<span class="payment-option-card__meta">Ils recevront une notification d√©di√©e</span>
				</button>
			</div>
		</div>
		<div class="modal-footer d-flex justify-content-between">
			<small class="text-muted">Le choix du paiement conditionne l'acc√®s aux invitations.</small>
			<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
		</div>
	</div>
</div></div><div class="modal fade duplicate-modal" id="duplicateCheckModal" tabindex="-1" aria-hidden="true" data-autoshow="0" data-shouldautoshow="{{ (wedding.id ? '0' : '1') }}">
<div class="modal-dialog modal-dialog-centered modal-lg">
	<div class="modal-content">
		<div class="modal-header duplicate-modal__header">
			<h5 class="modal-title text-white">V√©rifier les mariages existants</h5>
			<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
		</div>
		<div class="modal-body">
			<p class="duplicate-modal__intro mb-4">
				Pour √©viter la cr√©ation de doublons, indiquez l'adresse e-mail d'au moins un des mari√©s. Nous vous proposerons les mariages d√©j√† associ√©s √† ces contacts.
			</p>
			<form id="duplicateCheckForm" class="duplicate-form" data-check-url="{{ path('app_wedding_check_duplicates') }}" data-request-url-template="{{ path('app_wedding_request_access', {'id': 999999}) }}">
				<div class="row g-3">
					<div class="col-md-6">
						<label for="duplicate-email-marie" class="form-label">Email du futur mari√©</label>
						<input type="email" class="form-control" id="duplicate-email-marie" name="email_marie" placeholder="nom@exemple.fr">
					</div>
					<div class="col-md-6">
						<label for="duplicate-email-mariee" class="form-label">Email de la future mari√©e</label>
						<input type="email" class="form-control" id="duplicate-email-mariee" name="email_mariee" placeholder="prenom@exemple.fr">
					</div>
					<div class="col-12">
						<label for="duplicate-message" class="form-label">Message pour les mari√©s (facultatif)</label>
						<textarea class="form-control" id="duplicate-message" name="request_message" rows="3" placeholder="Expliquez votre demande ou pr√©cisez votre r√¥le."></textarea>
					</div>
				</div>
				<div class="d-flex flex-column flex-md-row gap-3 align-items-md-center justify-content-between mt-4">
					<div id="duplicateFeedback" class="duplicate-feedback text-muted"></div>
					<div class="d-flex gap-2">
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-search"></i>
							Rechercher des mariages
						</button>
						<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
							Continuer sans doublon
						</button>
					</div>
				</div>
			</form>
			<div id="duplicateResults" class="duplicate-results"></div>
		</div>
	</div>
</div></div>{% if wedding.id %}
<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="inviteModalLabel">Inviter quelqu'un</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
			</div>
			<form action="{{ path('app_wedding_invite', {'id': wedding.id}) }}" method="POST">
				<div class="modal-body">
					<div class="mb-3">
						<label for="email" class="form-label">Email</label>
						<input type="email" class="form-control" id="email" name="email" required>
					</div>
					<div class="mb-3">
						<label for="role" class="form-label">R√¥le</label>
						<select class="form-select" id="role" name="role" required>
							<option value="paroisse">Paroisse</option>
							<option value="musicien">Musicien</option>
							<option value="marie">Mari√©</option>
							<option value="mariee">Mari√©e</option>
						</select>
					</div>
					<div class="mb-3">
						<label for="message" class="form-label">Message personnalis√© (optionnel)</label>
						<textarea class="form-control" id="message" name="message" rows="3" placeholder="Ajoutez un message personnel pour accompagner l'invitation..."></textarea>
						<small class="text-muted">Ce message appara√Ætra dans l'email d'invitation et la notification.</small>
					</div>
				</div>
				{% if generatedInvitationLink is defined %}
					<div class="alert alert-info mt-3 mx-3">
						<p class="mb-2">Lien d'invitation g√©n√©r√© :</p>
						<div class="input-group">
							<input type="text" class="form-control" id="invitation-link" value="{{ generatedInvitationLink }}" readonly>
							<button type="button" class="btn btn-outline-secondary" onclick="window.copyInvitationLink()">Copier</button>
						</div>
					</div>
				{% endif %}
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<button type="submit" class="btn btn-primary">Envoyer l'invitation</button>
				</div>
			</form>
		</div>
	</div>
</div>{% endif %}<!-- Modal pour sugg√©rer un chant personnalis√© --><div class="modal fade" id="suggestSongModal" tabindex="-1" aria-labelledby="suggestSongModalLabel" aria-hidden="true">
<div class="modal-dialog modal-xl">
	<div class="modal-content">
		<div class="modal-header">
			<h5 class="modal-title" id="suggestSongModalLabel">Ajouter un nouvel √©l√©ment</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body">
			{% include 'song/_suggestion_content.html.twig' with {
                    songTypes: songTypes|default([])
                } %}
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
			<button type="button" class="btn btn-primary" id="confirm-song-suggestion">Enregistrer</button>
		</div>
	</div>
</div></div><div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg modal-dialog-centered">
	<div class="modal-content">
		<div class="modal-header">
			<h5 class="modal-title">Commentaires</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
		</div>
		<div class="modal-body">
			<div class="text-center py-4" id="commentsModalSpinner">
				<div class="spinner-border text-secondary" role="status">
					<span class="visually-hidden">Chargement...</span>
				</div>
			</div>
		</div>
		<div class="modal-footer"></div>
	</div>
</div></div>

<!-- Modal de pr√©visualisation d'un chant -->
<div class="modal fade" id="songPreviewModal" tabindex="-1" aria-labelledby="songPreviewModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="songPreviewModalLabel">Pr√©visualisation du chant</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
			</div>
			<div class="modal-body" id="songPreviewModalBody">
				<div class="text-center py-4" id="songPreviewSpinner">
					<div class="spinner-border text-secondary" role="status">
						<span class="visually-hidden">Chargement...</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

{% endblock %}{% block javascripts %}{{ parent() }}{{ include('song/_suggestion_ui_script.html.twig') }} <script>
	        window.copyInvitationLink = function () {
	            const copyText = document.getElementById('invitation-link');
	            if (!copyText) {
	                return;
	            }
	            copyText.select();
	            copyText.setSelectionRange(0, 99999);
	            navigator.clipboard.writeText(copyText.value).then(function () {
	                alert('Lien copi√© dans le presse-papiers !');
	            });
	        };
	
	        document.addEventListener('DOMContentLoaded', function () {
	            const weddingForm = document.getElementById('weddingForm');
	            const paymentHiddenInput = document.getElementById('payment_option_input');
	            const paymentModalEl = document.getElementById('paymentOptionModal');
	            const hiddenSongsSelect = document.getElementById('{{ form.songs.vars.id|e('js') }}');
	            const derouleSelects = Array.from(document.querySelectorAll('.js-deroule-select'));
	            const booleanToggleInputs = Array.from(document.querySelectorAll('.js-toggle-input'));
	
	            const syncBooleanToggle = (input) => {
	                if (!input) {
	                    return;
	                }
	                const isChecked = input.checked;
	                document.querySelectorAll(`.js-toggle-option[data-target="#${input.id}"]`).forEach((btn) => {
	                    const btnValue = btn.dataset.value === '1';
	                    btn.classList.toggle('is-active', btnValue === isChecked);
	                });
	            };
	
	            const syncSongsField = () => {
	                if (!hiddenSongsSelect) {
	                    return;
	                }
	
	                const selectedIds = new Set();
	                derouleSelects.forEach((selectEl) => {
	                    const value = selectEl.value;
	                    if (value) {
	                        selectedIds.add(value);
	                    }
	                });
	
	                Array.from(hiddenSongsSelect.options).forEach((option) => {
	                    option.selected = selectedIds.has(option.value);
	                });
	            };
	
	            derouleSelects.forEach((selectEl) => {
	                selectEl.addEventListener('change', syncSongsField);
	            });
	
	            if (weddingForm) {
	                weddingForm.addEventListener('submit', syncSongsField);
	            }
	
	            syncSongsField();
	
	            document.querySelectorAll('.js-validation-toggle').forEach((btn) => {
	                btn.addEventListener('click', function () {
	                    const typeId = this.dataset.type;
	                    const role = this.dataset.role;
	                    if (!typeId || !role) {
	                        return;
	                    }
	
	                    const input = document.querySelector(`[data-validation-input="${role}-${typeId}"]`);
	                    if (!input) {
	                        return;
	                    }
	
	                    const newValue = input.value === '1' ? '0' : '1';
	                    input.value = newValue;
	                    this.classList.toggle('is-active', newValue === '1');
	                });
	            });
	
	            document.querySelectorAll('.js-toggle-option').forEach((btn) => {
	                btn.addEventListener('click', function () {
	                    const targetSelector = this.dataset.target;
	                    if (!targetSelector) {
	                        return;
	                    }
	
	                    const targetInput = document.querySelector(targetSelector);
	                    if (!targetInput) {
	                        return;
	                    }
	
	                    const shouldCheck = this.dataset.value === '1';
	                    targetInput.checked = shouldCheck;
	                    if (shouldCheck) {
	                        targetInput.setAttribute('checked', 'checked');
	                    } else {
	                        targetInput.removeAttribute('checked');
	                    }
	
	                    targetInput.dispatchEvent(new Event('change', { bubbles: true }));
	                    syncBooleanToggle(targetInput);
	                });
	            });
	
	            booleanToggleInputs.forEach((input) => {
	                input.addEventListener('change', () => syncBooleanToggle(input));
	                syncBooleanToggle(input);
	            });
	
	            document.querySelectorAll('.js-remove-intervenant').forEach((btn) => {
	                btn.addEventListener('click', function () {
	                    const formId = this.dataset.form;
	                    const confirmation = this.dataset.confirm || '';
	                    if (!formId) {
	                        return;
	                    }
	                    if (confirmation && !window.confirm(confirmation)) {
	                        return;
	                    }
	                    const targetForm = document.getElementById(formId);
	                    if (targetForm) {
	                        targetForm.submit();
	                    }
	                });
	            });
	
	            // Gestion de la modal de s√©lection du r√¥le utilisateur (mari√©/mari√©e)
	            const userRoleModalEl = document.getElementById('userRoleModal');
	            const userRoleInput = document.getElementById('user_role_input');
	            if (userRoleModalEl && typeof bootstrap !== 'undefined') {
	                const userRoleModal = new bootstrap.Modal(userRoleModalEl, {
	                    backdrop: 'static',
	                    keyboard: false,
	                });
	                const autoShowRoleModal = userRoleModalEl.dataset.autoshow === '1';
	                const roleButtons = userRoleModalEl.querySelectorAll('.js-user-role-option');
	
	                roleButtons.forEach((btn) => {
	                    btn.addEventListener('click', function () {
	                        const role = this.dataset.role || '';
	                        if (!role || !userRoleInput) {
	                            return;
	                        }
	
	                        userRoleInput.value = role;
	                        userRoleModal.hide();
	                        
	                        // Apr√®s avoir s√©lectionn√© le r√¥le, auto-remplir les champs avec les infos utilisateur
	                        const currentUserFirstName = '{{ app.user ? app.user.firstName : "" }}';
	                        const currentUserLastName = '{{ app.user ? app.user.name : "" }}';
	                        const currentUserEmail = '{{ app.user ? app.user.email : "" }}';
	                        const currentUserPhone = '{{ app.user ? app.user.telephone : "" }}';
	                        const currentUserAddress1 = '{{ app.user ? app.user.addressLine1 : "" }}';
	                        const currentUserAddress2 = '{{ app.user ? app.user.addressLine2 : "" }}';
	                        const currentUserPostal = '{{ app.user ? app.user.addressPostalCodeAndCity : "" }}';
	                        
	                        if (role === 'marie') {
	                            const marieFirstNameInput = document.getElementById('wedding_form_marieFirstName');
	                            const marieNameInput = document.getElementById('wedding_form_marieName');
	                            const marieEmailInput = document.getElementById('wedding_form_marieEmail');
	                            const marieTelInput = document.getElementById('wedding_form_marieTelephone');
	                            const marieAddr1Input = document.getElementById('wedding_form_marieAddressLine1');
	                            const marieAddr2Input = document.getElementById('wedding_form_marieAddressLine2');
	                            const mariePostalInput = document.getElementById('wedding_form_marieAddressPostalCodeAndCity');
	                            
	                            if (marieFirstNameInput && !marieFirstNameInput.value) marieFirstNameInput.value = currentUserFirstName;
	                            if (marieNameInput && !marieNameInput.value) marieNameInput.value = currentUserLastName;
	                            if (marieEmailInput && !marieEmailInput.value) marieEmailInput.value = currentUserEmail;
	                            if (marieTelInput && !marieTelInput.value) marieTelInput.value = currentUserPhone;
	                            if (marieAddr1Input && !marieAddr1Input.value) marieAddr1Input.value = currentUserAddress1;
	                            if (marieAddr2Input && !marieAddr2Input.value) marieAddr2Input.value = currentUserAddress2;
	                            if (mariePostalInput && !mariePostalInput.value) mariePostalInput.value = currentUserPostal;
	                        } else if (role === 'mariee') {
	                            const marieeFirstNameInput = document.getElementById('wedding_form_marieeFirstName');
	                            const marieeNameInput = document.getElementById('wedding_form_marieeName');
	                            const marieeEmailInput = document.getElementById('wedding_form_marieeEmail');
	                            const marieeTelInput = document.getElementById('wedding_form_marieeTelephone');
	                            const marieeAddr1Input = document.getElementById('wedding_form_marieeAddressLine1');
	                            const marieeAddr2Input = document.getElementById('wedding_form_marieeAddressLine2');
	                            const marieePostalInput = document.getElementById('wedding_form_marieeAddressPostalCodeAndCity');
	                            
	                            if (marieeFirstNameInput && !marieeFirstNameInput.value) marieeFirstNameInput.value = currentUserFirstName;
	                            if (marieeNameInput && !marieeNameInput.value) marieeNameInput.value = currentUserLastName;
	                            if (marieeEmailInput && !marieeEmailInput.value) marieeEmailInput.value = currentUserEmail;
	                            if (marieeTelInput && !marieeTelInput.value) marieeTelInput.value = currentUserPhone;
	                            if (marieeAddr1Input && !marieeAddr1Input.value) marieeAddr1Input.value = currentUserAddress1;
	                            if (marieeAddr2Input && !marieeAddr2Input.value) marieeAddr2Input.value = currentUserAddress2;
	                            if (marieePostalInput && !marieePostalInput.value) marieePostalInput.value = currentUserPostal;
	                        }
	                        
	                        // Apr√®s avoir rempli les champs, ouvrir la modal de v√©rification des doublons
	                        const duplicateModalEl = document.getElementById('duplicateCheckModal');
	                        if (duplicateModalEl && duplicateModalEl.dataset.shouldAutoshow === '1') {
	                            const duplicateModal = bootstrap.Modal.getInstance(duplicateModalEl) || new bootstrap.Modal(duplicateModalEl, {
	                                backdrop: 'static',
	                                keyboard: false,
	                            });
	                            duplicateModal.show();
	                        }
	                    });
	                });
	
	                if (autoShowRoleModal) {
	                    userRoleModal.show();
	                }
	
	                // Intercepter la soumission si l'utilisateur est ROLE_USER uniquement et n'a pas choisi son r√¥le
	                const isOnlyUser = {{ isOnlyUser ? 'true' : 'false' }};
	                const isNewWedding = {{ wedding.id ? 'false' : 'true' }};
	                if (isOnlyUser && isNewWedding && weddingForm) {
	                    weddingForm.addEventListener('submit', function (event) {
	                        if (!userRoleInput || userRoleInput.value !== '') {
	                            return;
	                        }
	
	                        event.preventDefault();
	                        userRoleModal.show();
	                    });
	                }
	            }
	
	            if (paymentModalEl && typeof bootstrap !== 'undefined') {
	                const paymentModal = new bootstrap.Modal(paymentModalEl, {
	                    backdrop: 'static',
	                    keyboard: false,
	                });
	                const autoShowPaymentModal = paymentModalEl.dataset.autoshow === '1';
	                const shouldInterceptPayment = paymentModalEl.dataset.intercept === '1';
	                const paymentButtons = paymentModalEl.querySelectorAll('.js-payment-option');
	
	                const highlightPaymentOption = (value) => {
	                    paymentButtons.forEach((btn) => {
	                        btn.classList.toggle('is-selected', btn.dataset.option === value);
	                    });
	                };
	
	                if (paymentHiddenInput && paymentHiddenInput.value) {
	                    highlightPaymentOption(paymentHiddenInput.value);
	                }
	
	                paymentButtons.forEach((btn) => {
	                    if (btn.disabled) {
	                        return;
	                    }
	                    btn.addEventListener('click', function () {
	                        const option = this.dataset.option || '';
	                        if (!option || !paymentHiddenInput || !weddingForm) {
	                            return;
	                        }
	
	                        paymentHiddenInput.value = option;
	                        highlightPaymentOption(option);
	                        paymentModal.hide();
	                        weddingForm.requestSubmit();
	                    });
	                });
	
	                if (shouldInterceptPayment && weddingForm) {
	                    weddingForm.addEventListener('submit', function (event) {
	                        if (!paymentHiddenInput || paymentHiddenInput.value !== '') {
	                            return;
	                        }
	
	                        event.preventDefault();
	                        highlightPaymentOption('');
	                        paymentModal.show();
	                    });
	                }
	
	                if (autoShowPaymentModal) {
	                    paymentModal.show();
	                }
	            }
	
	            const duplicateModalEl = document.getElementById('duplicateCheckModal');
	            if (duplicateModalEl && typeof bootstrap !== 'undefined') {
	                const autoshow = duplicateModalEl.dataset.autoshow === '1';
	                const shouldAutoshow = duplicateModalEl.dataset.shouldautoshow === '1';
	                const isOnlyUser = {{ isOnlyUser ? 'true' : 'false' }};
	                const isNewWedding = {{ wedding.id ? 'false' : 'true' }};
	                
	                const duplicateModal = new bootstrap.Modal(duplicateModalEl, {
	                    backdrop: 'static',
	                    keyboard: false,
	                });
	                const duplicateForm = duplicateModalEl.querySelector('#duplicateCheckForm');
	                const feedbackEl = duplicateModalEl.querySelector('#duplicateFeedback');
	                const resultsContainer = duplicateModalEl.querySelector('#duplicateResults');
	                const messageInput = duplicateModalEl.querySelector('#duplicate-message');
	                const submitBtn = duplicateForm?.querySelector('button[type="submit"]');
	                const checkUrl = duplicateForm?.dataset.checkUrl || '';
	                const requestTemplate = duplicateForm?.dataset.requestUrlTemplate || '';
	                let lastEmails = [];
	
	                const setFeedback = (text, tone = 'muted') => {
	                    if (!feedbackEl) {
	                        return;
	                    }
	                    feedbackEl.textContent = text;
	                    feedbackEl.className = `duplicate-feedback text-${tone}`;
	                };
	
	                const buildRequestUrl = (id) => {
	                    if (!requestTemplate) {
	                        return `/mariages/${id}/request-access`;
	                    }
	                    if (requestTemplate.includes('999999')) {
	                        return requestTemplate.replace('999999', String(id));
	                    }
	                    return requestTemplate.replace(/\d+/, String(id));
	                };
	
	                const renderParticipants = (list) => {
	                    if (!Array.isArray(list) || list.length === 0) {
	                        return '<span class="text-muted">Aucun participant renseign√©.</span>';
	                    }
	                    return list
	                        .map((item) => `<span><i class="bi bi-person-fill me-2 text-secondary"></i>${item}</span>`)
	                        .join('');
	                };
	
	                const renderResults = (weddings) => {
	                    resultsContainer.innerHTML = '';
	
	                    if (!Array.isArray(weddings) || weddings.length === 0) {
	                        setFeedback('Aucun mariage correspondant n‚Äôa √©t√© trouv√©.', 'warning');
	                        return;
	                    }
	
	                    const fragment = document.createDocumentFragment();
	
	                    weddings.forEach((wedding) => {
	                        const card = document.createElement('article');
	                        card.className = 'duplicate-card';
	                        card.innerHTML = `
	                            <div class="duplicate-card__header">
	                                <span class="duplicate-card__badge"><i class="bi bi-stars"></i> Potentiel doublon</span>
	                                <span class="text-muted small">${wedding.date ?? 'Date inconnue'}</span>
	                            </div>
	                            <h3 class="h5 mb-1">${wedding.title}</h3>
	                            <p class="mb-0 text-muted">${wedding.church ?? 'Lieu non renseign√©'}</p>
	                            <div class="duplicate-card__participants">
	                                ${renderParticipants(wedding.participants)}
	                            </div>
	                            <div class="duplicate-card__footer">
	                                <a class="btn btn-light btn-sm" href="${wedding.viewUrl}" target="_blank" rel="noopener">
	                                    <i class="bi bi-box-arrow-up-right"></i>
	                                    Ouvrir
	                                </a>
	                                <button type="button" class="btn btn-outline-primary btn-sm duplicate-request" data-wedding-id="${wedding.id}">
	                                    <i class="bi bi-envelope"></i>
	                                    Demander l‚Äôajout
	                                </button>
	                            </div>
	                        `;
	                        fragment.appendChild(card);
	                    });
	
	                    resultsContainer.appendChild(fragment);
	                    setFeedback('S√©lectionnez un mariage existant pour envoyer votre demande.', 'success');
	                };
	
	                if (duplicateForm && checkUrl) {
	                    duplicateForm.addEventListener('submit', async (event) => {
	                        event.preventDefault();
	                        const formData = new FormData(duplicateForm);
	                        const emailMarie = (formData.get('email_marie') || '').toString().trim();
	                        const emailMariee = (formData.get('email_mariee') || '').toString().trim();
	
	                        if (!emailMarie && !emailMariee) {
	                            setFeedback('Veuillez renseigner au moins une adresse e-mail.', 'danger');
	                            return;
	                        }
	
	                        lastEmails = [emailMarie, emailMariee].filter(Boolean);
	                        setFeedback('Recherche en cours...', 'info');
	                        resultsContainer.innerHTML = '';
	                        if (submitBtn) {
	                            submitBtn.disabled = true;
	                        }
	
	                        try {
	                            const response = await fetch(checkUrl, {
	                                method: 'POST',
	                                headers: {
	                                    'Content-Type': 'application/json',
	                                    'X-Requested-With': 'XMLHttpRequest',
	                                },
	                                body: JSON.stringify({
	                                    ...(emailMarie ? { email_marie: emailMarie } : {}),
	                                    ...(emailMariee ? { email_mariee: emailMariee } : {}),
	                                }),
	                            });
	
	                            const payload = await response.json();
	
	                            if (!response.ok) {
	                                setFeedback(payload.message || 'La recherche a √©chou√©.', 'danger');
	                                return;
	                            }
	
	                            renderResults(payload.weddings || []);
	                            if (payload.message) {
	                                setFeedback(payload.message, (payload.weddings || []).length ? 'success' : 'warning');
	                            }
	                        } catch (error) {
	                            console.error(error);
	                            setFeedback('Une erreur est survenue lors de la recherche.', 'danger');
	                        } finally {
	                            if (submitBtn) {
	                                submitBtn.disabled = false;
	                            }
	                        }
	                    });
	                }
	
	                if (resultsContainer) {
	                    resultsContainer.addEventListener('click', async (event) => {
	                        const trigger = event.target.closest('.duplicate-request');
	                        if (!trigger) {
	                            return;
	                        }
	
	                        const weddingId = trigger.getAttribute('data-wedding-id');
	                        if (!weddingId) {
	                            return;
	                        }
	
	                        trigger.disabled = true;
	                        trigger.classList.add('disabled');
	
	                        try {
	                            const response = await fetch(buildRequestUrl(weddingId), {
	                                method: 'POST',
	                                headers: {
	                                    'Content-Type': 'application/json',
	                                    'X-Requested-With': 'XMLHttpRequest',
	                                },
	                                body: JSON.stringify({
	                                    message: messageInput ? messageInput.value : '',
	                                    emails: lastEmails,
	                                }),
	                            });
	
	                            const payload = await response.json();
	                            if (!response.ok) {
	                                setFeedback(payload.message || 'Impossible d‚Äôenvoyer la demande.', 'danger');
	                                trigger.disabled = false;
	                                trigger.classList.remove('disabled');
	                                return;
	                            }
	
	                            setFeedback(payload.message || 'Demande envoy√©e.', 'success');
	                            trigger.innerHTML = '<i class="bi bi-check-lg"></i> Demande envoy√©e';
	                            trigger.classList.replace('btn-outline-primary', 'btn-success');
	                        } catch (error) {
	                            console.error(error);
	                            setFeedback('Une erreur est survenue lors de l‚Äôenvoi de la demande.', 'danger');
	                            trigger.disabled = false;
	                            trigger.classList.remove('disabled');
	                        }
	                    });
	                }
	
	                // N'afficher la modal de duplication automatiquement que si ce n'est pas un utilisateur simple cr√©ant un nouveau mariage
	                // (pour les utilisateurs simples, elle s'affichera apr√®s la s√©lection du r√¥le)
	                if (autoshow && !(isOnlyUser && isNewWedding)) {
	                    duplicateModal.show();
	                }
	            }
	
	            console.log('=== DEBUT INITIALISATION WIZARD ===');
	            const wizardLayout = document.getElementById('weddingWizard');
	            console.log('wizardLayout:', wizardLayout);
	            const steps = Array.from(document.querySelectorAll('.wizard-step'));
	            console.log('Nombre d\'√©tapes trouv√©es:', steps.length);
	            const stepperItems = Array.from(document.querySelectorAll('.wizard-stepper__item'));
	            console.log('Nombre de stepper items:', stepperItems.length);
	            const sideSlides = Array.from(document.querySelectorAll('.wizard-sidecard__slide'));
	            const prevBtn = document.querySelector('.wizard-prev');
	            const nextBtn = document.querySelector('.wizard-next');
	            const submitBtn = document.querySelector('.wizard-submit');
	            let currentStep = 0;
	
	            // Initialiser avec l'√©tape demand√©e via le param√®tre URL
	            if (wizardLayout) {
	                const defaultStepAttr = wizardLayout.dataset.defaultStep;
	                console.log('Attribut data-default-step:', defaultStepAttr);
	                const defaultStep = parseInt(defaultStepAttr || '0', 10);
	                console.log('defaultStep pars√©:', defaultStep);
	                if (!Number.isNaN(defaultStep) && defaultStep >= 0) {
	                    currentStep = Math.max(0, Math.min(steps.length - 1, defaultStep));
	                    console.log('Initialisation √† l\'√©tape:', currentStep, 'depuis data-default-step:', defaultStep);
	                }
	            }
	
	            function syncUI() {
	                steps.forEach((step, index) => step.classList.toggle('active', index === currentStep));
	                stepperItems.forEach((item, index) => item.classList.toggle('active', index === currentStep));
	                sideSlides.forEach((slide, index) => slide.classList.toggle('active', index === currentStep));
	                if (prevBtn) {
	                    prevBtn.classList.toggle('d-none', currentStep === 0);
	                }
	                if (nextBtn) {
	                    nextBtn.classList.toggle('d-none', currentStep >= steps.length - 1);
	                }
	                if (submitBtn) {
	                    submitBtn.classList.toggle('d-none', currentStep < steps.length - 1);
	                }
	            }
	
	            if (prevBtn) {
	                prevBtn.addEventListener('click', function () {
	                    if (currentStep > 0) {
	                        currentStep -= 1;
	                        syncUI();
	                    }
	                });
	            }
	
	            if (nextBtn) {
	                nextBtn.addEventListener('click', function () {
	                    if (currentStep < steps.length - 1) {
	                        currentStep += 1;
	                        syncUI();
	                    }
	                });
	            }
	
	            stepperItems.forEach((item) => {
	                item.addEventListener('click', function () {
	                    const target = parseInt(item.dataset.step, 10);
	                    if (!Number.isNaN(target)) {
	                        currentStep = target;
	                        syncUI();
	                    }
	                });
	            });
	
	            syncUI();
	
	            // Mettre √† jour le champ cach√© current_step quand on change d'√©tape
	            const currentStepInput = document.getElementById('current_step_input');
	            const originalSyncUI = syncUI;
	            syncUI = function() {
	                originalSyncUI();
	                if (currentStepInput) {
	                    currentStepInput.value = currentStep;
	                    console.log('Step actuel mis √† jour dans le formulaire:', currentStep);
	                }
	            };
	
	            // G√©rer le bouton Annuler pour revenir √† la page view au m√™me step
	            const cancelBtn = document.getElementById('cancelBtn');
	            if (cancelBtn) {
	                cancelBtn.addEventListener('click', function(e) {
	                    e.preventDefault();
	                    const weddingId = '{{ wedding.id }}';
	                    if (weddingId) {
	                        const viewUrl = '{{ path('app_wedding_view', {'id': wedding.id}) }}' + '?step=' + currentStep;
	                        console.log('Redirection Annuler vers:', viewUrl);
	                        window.location.href = viewUrl;
	                    } else {
	                        window.location.href = '{{ path('app_wedding_index') }}';
	                    }
	                });
	            }
	
	            if (window.TomSelect) {
	                derouleSelects.forEach((select) => {
	                    if (!select.tomselect) {
	                        const instance = new TomSelect(select, {
	                            placeholder: select.dataset.placeholder || 'Rechercher un chant',
	                            allowEmptyOption: true,
	                            create: false,
	                            maxOptions: 500,
	                            onChange: () => {
	                                syncSongsField();
	                            },
	                        });
	                        instance.wrapper.classList.add('deroule-select--large');
	                        instance.control.classList.add('deroule-select--large');
	                    }
	                });
	            }
	
	            document.querySelectorAll('.invite-trigger').forEach((btn) => {
	                btn.addEventListener('click', function () {
	                    const roleInput = document.getElementById('role');
	                    if (roleInput) {
	                        roleInput.value = btn.getAttribute('data-invite-role') || '';
	                    }
	                });
	            });
	
	            const modalEl = document.getElementById('commentsModal');
	            if (modalEl) {
	                const bsModal = new bootstrap.Modal(modalEl);
	                document.querySelectorAll('.open-comments').forEach((btn) => {
	                    btn.addEventListener('click', async function () {
	                        const weddingId = this.dataset.wedding;
	                        const songTypeId = this.dataset.songtype;
	                        const url = `/comments/${weddingId}/${songTypeId}`;
	
	                        const body = modalEl.querySelector('.modal-body');
	                        const footer = modalEl.querySelector('.modal-footer');
	                        body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Chargement...</span></div></div>';
	                        footer.innerHTML = '';
	                        bsModal.show();
	
	                        try {
	                            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
	                            const text = await res.text();
	                            const parser = new DOMParser();
	                            const doc = parser.parseFromString(text, 'text/html');
	
	                            const header = doc.querySelector('h2');
	                            const commentsBox = doc.querySelector('#comments-box');
	                            const form = doc.querySelector('.card-footer form') || doc.querySelector('form');
	
	                            body.innerHTML = '';
	                            if (header) {
	                                body.appendChild(header.cloneNode(true));
	                            }
	                            if (commentsBox) {
	                                body.appendChild(commentsBox.cloneNode(true));
	                            } else {
	                                body.innerHTML += '<p class="text-muted">Aucun commentaire.</p>';
	                            }
	
	                            footer.innerHTML = '';
	                            if (form) {
	                                const injectedForm = form.cloneNode(true);
	                                footer.appendChild(injectedForm);
	
	                                injectedForm.addEventListener('submit', async function (evt) {
	                                    evt.preventDefault();
	                                    const fd = new FormData(injectedForm);
	                                    const action = injectedForm.getAttribute('action') || url;
	                                    const method = (injectedForm.getAttribute('method') || 'POST').toUpperCase();
	
	                                    try {
	                                        const response = await fetch(action, {
	                                            method: method,
	                                            body: fd,
	                                            headers: { 'X-Requested-With': 'XMLHttpRequest' },
	                                        });
	                                        if (!response.ok) {
	                                            throw new Error('Requ√™te invalide');
	                                        }
	
	                                        const refreshed = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
	                                        const refreshedText = await refreshed.text();
	                                        const refreshedDoc = new DOMParser().parseFromString(refreshedText, 'text/html');
	                                        const newComments = refreshedDoc.querySelector('#comments-box');
	                                        const newForm = refreshedDoc.querySelector('.card-footer form') || refreshedDoc.querySelector('form');
	
	                                        body.querySelector('h2')?.remove();
	                                        if (newComments) {
	                                            const old = body.querySelector('#comments-box');
	                                            if (old) {
	                                                old.replaceWith(newComments.cloneNode(true));
	                                            } else {
	                                                body.appendChild(newComments.cloneNode(true));
	                                            }
	                                        }
	
	                                        if (newForm) {
	                                            footer.innerHTML = '';
	                                            footer.appendChild(newForm.cloneNode(true));
	                                        }
	                                    } catch (err) {
	                                        console.error(err);
	                                        alert('Erreur lors de l\'envoi du commentaire.');
	                                    }
	                                });
	                            } else {
	                                footer.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
	                            }
	                        } catch (err) {
	                            console.error(err);
	                            const bodyEl = modalEl.querySelector('.modal-body');
	                            bodyEl.innerHTML = '<p class="text-danger">Impossible de charger les commentaires.</p>';
	                            modalEl.querySelector('.modal-footer').innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
	                        }
	                    });
	                });
	            }
	        });
	
	        // Gestion des suggestions de chants personnalis√©s
	        document.addEventListener('DOMContentLoaded', function() {
	            const suggestModalEl = document.getElementById('suggestSongModal');
	            const confirmBtn = document.getElementById('confirm-song-suggestion');
	            if (!suggestModalEl || typeof bootstrap === 'undefined' || !confirmBtn) {
	                return;
	            }
	
	            const suggestModal = new bootstrap.Modal(suggestModalEl);
	            let currentSongTypeId = null;
	
	            const getState = () => window.suggestionForm || {};
	
	            const resetFields = () => {
	                const songRadio = document.getElementById('suggestion-type-song');
	                const textRadio = document.getElementById('suggestion-type-text');
	                if (songRadio) {
	                    songRadio.checked = true;
	                }
	                if (textRadio) {
	                    textRadio.checked = false;
	                }
	                const idsToClear = [
	                    'suggestion-name',
	                    'suggestion-lyrics',
	                    'suggestion-preview-url',
	                    'suggestion-music-author',
	                    'suggestion-lyrics-author',
	                    'suggestion-interpret',
	                    'suggestion-editor',
	                    'suggestion-text-ref',
	                    'suggestion-text-translation'
	                ];
	                idsToClear.forEach((inputId) => {
	                    const input = document.getElementById(inputId);
	                    if (input) {
	                        input.value = '';
	                    }
	                });
	
	                const state = getState();
	                if (state.resetPreview) {
	                    state.resetPreview();
	                }
	                if (state.toggleSections) {
	                    state.toggleSections(true);
	                }
	                if (state.clearTypeSelection) {
	                    state.clearTypeSelection();
	                }
	            };
	
	            document.querySelectorAll('.js-suggest-song').forEach((btn) => {
	                btn.addEventListener('click', function() {
	                    currentSongTypeId = this.getAttribute('data-song-type');
	                    resetFields();
	
	                    const state = getState();
	                    if (currentSongTypeId && state.setTypeSelection) {
	                        state.setTypeSelection([currentSongTypeId]);
	                    } else if (currentSongTypeId && state.typesSelectElement) {
	                        Array.from(state.typesSelectElement.options).forEach((option) => {
	                            option.selected = option.value === currentSongTypeId;
	                        });
	                    }
	
	                    suggestModal.show();
	                    setTimeout(() => document.getElementById('suggestion-name')?.focus(), 300);
	                });
	            });
	
	            confirmBtn.addEventListener('click', async function() {
	                const songName = document.getElementById('suggestion-name')?.value.trim();
	                if (!songName) {
	                    alert('Veuillez entrer le titre');
	                    return;
	                }
	
	                const isSong = document.getElementById('suggestion-type-song')?.checked ?? true;
	                const state = getState();
	                let selectedTypes = [];
	                if (state.tomSelect) {
	                    selectedTypes = state.tomSelect.getValue();
	                    if (typeof selectedTypes === 'string') {
	                        selectedTypes = selectedTypes ? [selectedTypes] : [];
	                    }
	                } else if (state.typesSelectElement) {
	                    selectedTypes = Array.from(state.typesSelectElement.selectedOptions).map((opt) => opt.value);
	                }
	
	                confirmBtn.disabled = true;
	                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cr√©ation...';
	
	                try {
	                    const formData = new FormData();
	                    formData.append('name', songName);
	                    formData.append('isSong', isSong ? '1' : '0');
	                    formData.append('lyrics', document.getElementById('suggestion-lyrics')?.value || '');
	                    formData.append('previewUrl', document.getElementById('suggestion-preview-url')?.value || '');
	                    formData.append('lyricsAuthorName', document.getElementById('suggestion-lyrics-author')?.value || '');
	                    formData.append('musicAuthorName', document.getElementById('suggestion-music-author')?.value || '');
	                    formData.append('interpretName', document.getElementById('suggestion-interpret')?.value || '');
	                    formData.append('editorName', document.getElementById('suggestion-editor')?.value || '');
	                    formData.append('textRef', document.getElementById('suggestion-text-ref')?.value || '');
	                    formData.append('textTranslationName', document.getElementById('suggestion-text-translation')?.value || '');
	                    selectedTypes.forEach((typeId) => formData.append('typeIds[]', typeId));
	
	                    const response = await fetch('{{ path('song_suggestion_create') }}', {
	                        method: 'POST',
	                        body: formData,
	                        headers: {
	                            'X-Requested-With': 'XMLHttpRequest'
	                        }
	                    });
	
	                    if (!response.ok) {
	                        throw new Error('Erreur lors de la cr√©ation de la suggestion');
	                    }
	
	                    const data = await response.json();
	                    if (!data.success || !data.songId) {
	                        throw new Error(data.message || 'Erreur lors de la cr√©ation');
	                    }
	
	                    suggestModal.hide();
	
	                    const wizardLayout = document.getElementById('weddingWizard');
	                    const currentStepValue = wizardLayout ? parseInt(wizardLayout.dataset.defaultStep || '0', 10) : 0;
	                    const mainForm = document.querySelector('form[name="wedding_form"]');
	                    if (mainForm) {
	                        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement...';
	                        const currentStepInput = document.getElementById('current_step_input');
	                        if (currentStepInput) {
	                            currentStepInput.value = currentStepValue;
	                        }
	                        const stayOnEditInput = document.getElementById('stay_on_edit_input');
	                        if (stayOnEditInput) {
	                            stayOnEditInput.value = '1';
	                        }
	
	                        const select = document.querySelector('.deroule-select[data-song-type-id="' + currentSongTypeId + '"]');
	                        if (select) {
	                            const option = document.createElement('option');
	                            option.value = data.songId;
	                            option.textContent = '‚ú® ' + songName + ' (suggestion)';
	                            option.selected = true;
	                            select.insertBefore(option, select.firstChild);
	                        }
	
	                        mainForm.submit();
	                    } else {
	                        window.location.href = window.location.pathname + '?step=' + currentStepValue;
	                        window.location.reload();
	                    }
	                } catch (error) {
	                    console.error(error);
	                    alert('Erreur : ' + error.message);
	                    confirmBtn.disabled = false;
	                    confirmBtn.innerHTML = 'Enregistrer';
	                }
	            });
	        });
	
	        // Gestion de l'√©diteur Markdown pour les notes musiciens
	        document.addEventListener('DOMContentLoaded', function() {
	            const markdownContainer = document.querySelector('.markdown-container');
	            if (!markdownContainer) return;
	
	            const tabs = markdownContainer.querySelectorAll('.markdown-tab');
	            const editPane = markdownContainer.querySelector('[data-pane="edit"]');
	            const previewPane = markdownContainer.querySelector('[data-pane="preview"]');
	            const editor = markdownContainer.querySelector('.markdown-editor');
	            const previewEl = document.getElementById('markdownPreview');
	            const toolbar = document.getElementById('markdownToolbar');
	
	            if (!tabs.length || !editPane || !previewPane || !editor || !previewEl) return;
	
	            // Simple parseur Markdown
	            function parseMarkdown(text) {
	                if (!text || !text.trim()) {
	                    return '<p class="text-muted fst-italic">L\'aper√ßu appara√Ætra ici...</p>';
	                }
	
	                let html = text
	                    // √âchapper les caract√®res HTML dangereux
	                    .replace(/&/g, '&amp;')
	                    .replace(/</g, '&lt;')
	                    .replace(/>/g, '&gt;')
	                    // Blocs de code (avant autres transformations)
	                    .replace(/```([\s\S]*?)```/g, '<pre class="markdown-code-block"><code>$1</code></pre>')
	                    .replace(/`([^`]+)`/g, '<code class="markdown-inline-code">$1</code>')
	                    // Titres
	                    .replace(/^### (.+)$/gm, '<h5 class="markdown-h3">$1</h5>')
	                    .replace(/^## (.+)$/gm, '<h4 class="markdown-h2">$1</h4>')
	                    .replace(/^# (.+)$/gm, '<h3 class="markdown-h1">$1</h3>')
	                    // Gras et italique
	                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
	                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
	                    .replace(/~~([^~]+)~~/g, '<del>$1</del>')
	                    // Citations
	                    .replace(/^&gt; (.+)$/gm, '<blockquote class="markdown-quote">$1</blockquote>')
	                    // Checkboxes
	                    .replace(/^- \[x\] (.+)$/gm, '<div class="markdown-checkbox"><input type="checkbox" checked disabled> <span>$1</span></div>')
	                    .replace(/^- \[ \] (.+)$/gm, '<div class="markdown-checkbox"><input type="checkbox" disabled> <span>$1</span></div>')
	                    // Listes √† puces
	                    .replace(/^- (.+)$/gm, '<li class="markdown-li">$1</li>')
	                    .replace(/^(\d+)\. (.+)$/gm, '<li class="markdown-li-num" value="$1">$2</li>')
	                    // Liens
	                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
	                    // Lignes horizontales
	                    .replace(/^---$/gm, '<hr class="markdown-hr">')
	                    // Paragraphes (lignes vides)
	                    .replace(/\n\n/g, '</p><p class="markdown-p">')
	                    // Sauts de ligne simples
	                    .replace(/\n/g, '<br>');
	
	                // Envelopper les listes
	                html = html.replace(/(<li class="markdown-li">.*?<\/li>(\s*<br>)?)+/g, function(match) {
	                    return '<ul class="markdown-ul">' + match.replace(/<br>/g, '') + '</ul>';
	                });
	                html = html.replace(/(<li class="markdown-li-num".*?<\/li>(\s*<br>)?)+/g, function(match) {
	                    return '<ol class="markdown-ol">' + match.replace(/<br>/g, '') + '</ol>';
	                });
	
	                return '<div class="markdown-body"><p class="markdown-p">' + html + '</p></div>';
	            }
	
	            // Fonction d'insertion dans l'√©diteur
	            function insertText(before, after = '', defaultText = '') {
	                const start = editor.selectionStart;
	                const end = editor.selectionEnd;
	                const selectedText = editor.value.substring(start, end) || defaultText;
	                const newText = before + selectedText + after;
	                
	                editor.setRangeText(newText, start, end, 'end');
	                
	                // Positionner le curseur
	                if (!editor.value.substring(start, end) && defaultText) {
	                    editor.selectionStart = start + before.length;
	                    editor.selectionEnd = start + before.length + defaultText.length;
	                }
	                
	                editor.focus();
	            }
	
	            // Fonction d'insertion en d√©but de ligne
	            function insertAtLineStart(prefix) {
	                const start = editor.selectionStart;
	                const end = editor.selectionEnd;
	                const value = editor.value;
	                
	                // Trouver le d√©but de la ligne
	                let lineStart = start;
	                while (lineStart > 0 && value[lineStart - 1] !== '\n') {
	                    lineStart--;
	                }
	                
	                // Ins√©rer le pr√©fixe
	                editor.setRangeText(prefix, lineStart, lineStart, 'end');
	                editor.selectionStart = editor.selectionEnd = start + prefix.length;
	                editor.focus();
	            }
	
	            // Gestion de la barre d'outils
	            if (toolbar) {
	                toolbar.addEventListener('click', function(e) {
	                    const btn = e.target.closest('[data-md-action]');
	                    if (!btn) return;
	
	                    e.preventDefault();
	                    const action = btn.dataset.mdAction;
	
	                    switch(action) {
	                        case 'h1':
	                            insertAtLineStart('# ');
	                            break;
	                        case 'h2':
	                            insertAtLineStart('## ');
	                            break;
	                        case 'h3':
	                            insertAtLineStart('### ');
	                            break;
	                        case 'bold':
	                            insertText('**', '**', 'texte en gras');
	                            break;
	                        case 'italic':
	                            insertText('*', '*', 'texte en italique');
	                            break;
	                        case 'strikethrough':
	                            insertText('~~', '~~', 'texte barr√©');
	                            break;
	                        case 'ul':
	                            insertAtLineStart('- ');
	                            break;
	                        case 'ol':
	                            insertAtLineStart('1. ');
	                            break;
	                        case 'checklist':
	                            insertAtLineStart('- [ ] ');
	                            break;
	                        case 'quote':
	                            insertAtLineStart('> ');
	                            break;
	                        case 'code':
	                            insertText('`', '`', 'code');
	                            break;
	                        case 'codeblock':
	                            insertText('\n```\n', '\n```\n', 'bloc de code');
	                            break;
	                        case 'link':
	                            const url = prompt('URL du lien :');
	                            if (url) {
	                                insertText('[', '](' + url + ')', 'texte du lien');
	                            }
	                            break;
	                        case 'hr':
	                            insertText('\n---\n', '', '');
	                            break;
	                    }
	                });
	            }
	
	            // Gestion des onglets
	            tabs.forEach(tab => {
	                tab.addEventListener('click', function() {
	                    const targetTab = this.dataset.tab;
	
	                    // Mettre √† jour les classes des onglets
	                    tabs.forEach(t => t.classList.remove('active'));
	                    this.classList.add('active');
	
	                    // Afficher le bon panneau
	                    if (targetTab === 'edit') {
	                        editPane.classList.add('active');
	                        previewPane.classList.remove('active');
	                        if (toolbar) toolbar.style.display = '';
	                    } else {
	                        editPane.classList.remove('active');
	                        previewPane.classList.add('active');
	                        if (toolbar) toolbar.style.display = 'none';
	                        // Mettre √† jour l'aper√ßu
	                        previewEl.innerHTML = parseMarkdown(editor.value);
	                    }
	                });
	            });
	
	            // Mettre √† jour l'aper√ßu en temps r√©el quand on tape
	            editor.addEventListener('input', function() {
	                if (previewPane.classList.contains('active')) {
	                    previewEl.innerHTML = parseMarkdown(this.value);
	                }
	            });
	
	            // Raccourcis clavier pour l'√©diteur
	            editor.addEventListener('keydown', function(e) {
	                if (e.ctrlKey || e.metaKey) {
	                    const start = this.selectionStart;
	                    const end = this.selectionEnd;
	                    const selectedText = this.value.substring(start, end);
	
	                    switch(e.key) {
	                        case 'b':
	                        case 'B':
	                            e.preventDefault();
	                            insertText('**', '**', 'texte en gras');
	                            break;
	                        case 'i':
	                        case 'I':
	                            e.preventDefault();
	                            insertText('*', '*', 'texte en italique');
	                            break;
	                        case '1':
	                            e.preventDefault();
	                            insertAtLineStart('# ');
	                            break;
	                        case '2':
	                            e.preventDefault();
	                            insertAtLineStart('## ');
	                            break;
	                        case '3':
	                            e.preventDefault();
	                            insertAtLineStart('### ');
	                            break;
	                    }
	                }
	            });
	        });

	        // Pr√©visualisation des chants
	        (function() {
	            const songPreviewModalEl = document.getElementById('songPreviewModal');
	            const songPreviewModalBody = document.getElementById('songPreviewModalBody');
	            const songPreviewSpinner = document.getElementById('songPreviewSpinner');
	            
	            if (!songPreviewModalEl || typeof bootstrap === 'undefined') return;
	            
	            const songPreviewModal = new bootstrap.Modal(songPreviewModalEl);
	            
	            // Gestion des clics sur les boutons de pr√©visualisation
	            document.querySelectorAll('.js-preview-song').forEach(btn => {
	                btn.addEventListener('click', function() {
	                    const songId = this.dataset.songId;
	                    if (!songId) return;
	                    
	                    // Afficher la modal avec le spinner
	                    songPreviewModalBody.innerHTML = `
	                        <div class="text-center py-4">
	                            <div class="spinner-border text-secondary" role="status">
	                                <span class="visually-hidden">Chargement...</span>
	                            </div>
	                        </div>
	                    `;
	                    songPreviewModal.show();
	                    
	                    // Charger le contenu via AJAX
	                    fetch(`/songs/preview/${songId}`)
	                        .then(response => {
	                            if (!response.ok) throw new Error('Chant introuvable');
	                            return response.text();
	                        })
	                        .then(html => {
	                            songPreviewModalBody.innerHTML = html;
	                        })
	                        .catch(error => {
	                            songPreviewModalBody.innerHTML = `
	                                <div class="alert alert-danger mb-0">
	                                    <i class="bi bi-exclamation-triangle me-2"></i>
	                                    Impossible de charger la pr√©visualisation du chant.
	                                </div>
	                            `;
	                        });
	                });
	            });
	            
	            // Mettre √† jour le bouton de pr√©visualisation quand le select change
	            document.querySelectorAll('.js-deroule-select').forEach(select => {
	                select.addEventListener('change', function() {
	                    const songTypeId = this.dataset.songType;
	                    const previewBtn = this.closest('.deroule-row')?.querySelector('.js-preview-song');
	                    if (previewBtn) {
	                        const selectedSongId = this.value;
	                        previewBtn.dataset.songId = selectedSongId;
	                        previewBtn.disabled = !selectedSongId;
	                    }
	                });
	            });
	        })();
	    </script>{% endblock %}
