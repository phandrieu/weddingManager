<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Déroulé de la célébration</title>
    <style>
        @page {
            margin: 14mm 14mm;
            size: A4;
        }

        :root {
            --ink: #1e1f29;
            --muted: #6b7280;
            --border: #d9dce3;
            --accent: #eff3ff;
            --accent-strong: #d4e0ff;
            --success: #1c8c63;
            --warning: #bb7500;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 12px;
            color: var(--ink);
            margin: 0;
            background: #ffffff;
        }

        h1, h2, h3 {
            margin: 0;
            font-weight: 600;
        }

        p {
            margin: 0;
        }

        .document {
            width: 100%;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 18px;
        }

        .header-identity {
            display: flex;
            gap: 16px;
        }

        .header-identity img {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }

        .eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 11px;
            color: var(--muted);
        }

        .couple-name {
            margin-top: 6px;
            font-size: 14px;
        }

        .header-meta {
            text-align: right;
            font-size: 11px;
            color: var(--muted);
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .info-table th,
        .info-table td {
            padding: 8px 10px;
            border: 1px solid var(--border);
            vertical-align: top;
        }

        .info-table th {
            width: 20%;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 10px;
            color: var(--muted);
            background: var(--accent);
        }

        .metrics {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .metric-card {
            flex: 1 1 120px;
            border: 1px solid var(--border);
            padding: 10px 12px;
            border-radius: 6px;
            background: #fafbff;
        }

        .metric-card span {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            color: var(--muted);
            letter-spacing: 0.08em;
        }

        .metric-card strong {
            display: block;
            font-size: 18px;
            margin-top: 4px;
        }

        .deroule-section {
            margin-bottom: 24px;
        }

        .sequence-card {
            border: 1px solid var(--border);
            border-radius: 18px;
            margin-bottom: 18px;
            overflow: hidden;
        }

        .sequence-card__header {
            padding: 16px 20px 12px;
            background: #f9f7ff;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 11px;
            font-weight: 700;
            border-bottom: 2px solid var(--border);
        }

        .sequence-card__header::after {
            content: '';
            display: block;
            width: 70px;
            height: 3px;
            border-radius: 999px;
            margin-top: 10px;
            background: currentColor;
        }

        .sequence-card__table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .sequence-card__table th,
        .sequence-card__table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .sequence-card__table th {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 10px;
            background: #ffffff;
        }

        .sequence-card__table tr:last-child td {
            border-bottom: none;
        }

        .status-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-label--ok {
            background: rgba(28, 140, 99, 0.12);
            color: var(--success);
        }

        .status-label--pending {
            background: rgba(187, 117, 0, 0.12);
            color: var(--warning);
        }

        .notes-block,
        .contacts-block {
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 18px;
        }

        .contacts-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .contacts-list li {
            margin-bottom: 6px;
        }

        .muted {
            color: var(--muted);
        }

        .qr-inline {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .qr-inline img {
            width: 80px;
            height: 80px;
            border: 1px solid var(--border);
            padding: 4px;
        }

        footer {
            border-top: 1px solid var(--border);
            padding-top: 10px;
            font-size: 10px;
            color: var(--muted);
            text-align: right;
        }
    </style>
</head>
<body>
{% set logoSource = logoDataUri ?? absolute_url(asset('logos/logo_app.png')) %}
{% set weddingUrl = absolute_url(path('app_wedding_view', { id: wedding.id })) %}
{% set qrCodeUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' ~ (weddingUrl|url_encode) %}
{% set firstParishContact = wedding.parishUsers|length > 0 ? wedding.parishUsers|first : null %}
{% set celebrantName = (wedding.priestFirstName ~ ' ' ~ wedding.priestLastName)|trim %}
{% set commentCountsByType = commentCountsByType|default({}) %}
{% set songsById = songsById|default({}) %}
{% set totalTypes = songTypes|length %}
{% set selectionCount = 0 %}
{% set musicianValidated = 0 %}
{% set parishValidated = 0 %}
{% for type in songTypes %}
    {% set selection = songSelectionsByType[type.id]|default(null) %}
    {% if selection %}
        {% set selectionCount = selectionCount + 1 %}
        {% if selection.validatedByMusician %}{% set musicianValidated = musicianValidated + 1 %}{% endif %}
        {% if selection.validatedByParish %}{% set parishValidated = parishValidated + 1 %}{% endif %}
    {% endif %}
{% endfor %}
{% set pendingTypes = totalTypes - selectionCount %}
{% if pendingTypes < 0 %}{% set pendingTypes = 0 %}{% endif %}
{% set musicianPending = selectionCount - musicianValidated %}
{% if musicianPending < 0 %}{% set musicianPending = 0 %}{% endif %}
{% set parishPending = selectionCount - parishValidated %}
{% if parishPending < 0 %}{% set parishPending = 0 %}{% endif %}

<div class="document">
    <header class="document-header">
        <div class="header-identity">
            <img src="{{ logoSource }}" alt="Logo">
            <div>
                <h1 style="color:">Déroulé de la {{ wedding.messe ? 'messe' : 'célébration' }} du mariage de {{ wedding.marie ? wedding.marie.fullName : 'Marié' }} et de {{ wedding.mariee ? wedding.mariee.fullName : 'Mariée' }}</h1>
            </div>
        </div>

    </header>

    <section class="info-section">
        <table class="info-table">
            <tbody>
                <tr>
                    <th>Date &amp; heure</th>
                    <td>
                        {% if wedding.date %}
                            {{ wedding.date|date('d/m/Y') }}{% if wedding.time %} à {{ wedding.time|date('H\hi') }}{% endif %}
                        {% else %}
                            Date à confirmer
                        {% endif %}
                    </td>
                    <th>Lieu</th>
                    <td>
                        {% if wedding.church %}
                            {{ wedding.church }}{% if wedding.parish %} - {{ wedding.parish }}{% endif %}
                        {% elseif wedding.parish %}
                            {{ wedding.parish }}
                        {% else %}
                            Lieu à confirmer
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Adresse</th>
                    <td>
                        {% if wedding.addressLine1 %}<div>{{ wedding.addressLine1 }}</div>{% endif %}
                        {% if wedding.addressLine2 %}<div>{{ wedding.addressLine2 }}</div>{% endif %}
                        {% if wedding.addressPostalCodeAndCity %}<div>{{ wedding.addressPostalCodeAndCity }}</div>{% endif %}
                        {% if not wedding.addressLine1 and not wedding.addressPostalCodeAndCity %}
                            <span class="muted">Adresse à compléter</span>
                        {% endif %}
                    </td>
                    <th>Contact paroisse</th>
                    <td>
                        {% if firstParishContact %}
                            <div><strong>{{ firstParishContact.fullName }}</strong></div>
                            {% if firstParishContact.telephone %}<div>{{ firstParishContact.telephone }}</div>{% endif %}
                            {% if firstParishContact.email %}<div>{{ firstParishContact.email }}</div>{% endif %}
                        {% else %}
                            <span class="muted">Aucun contact associé</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Célébrant</th>
                    <td>
                        <div><strong>{{ celebrantName ?: 'À définir' }}</strong></div>
                        {% if wedding.priestPhoneNumber %}<div>{{ wedding.priestPhoneNumber }}</div>{% endif %}
                        {% if wedding.priestEMail %}<div>{{ wedding.priestEMail }}</div>{% endif %}
                    </td>
                    <th>Musiciens</th>
                    <td>
                        {% if wedding.musicians|length > 0 %}
                            {% for musician in wedding.musicians %}
                                <div>{{ musician.fullName }}{% if musician.telephone %} — {{ musician.telephone }}{% endif %}</div>
                            {% endfor %}
                        {% else %}
                            <span class="muted">Aucun musicien associé</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </section>


    <section class="deroule-section">
        <h2>Déroulé détaillé</h2>
        <br>
        {% set groups = {} %}
        {% for t in songTypes %}
            {% set period = t.celebrationPeriod %}
            {% set label = period ? period.fullName : 'Autres' %}
            {% set color = period and period.color ? period.color : '#4b5563' %}
            {% set orderValue = period and period.periodOrder is not null ? period.periodOrder : 999 %}
            {% set key = '%03d'|format(orderValue) ~ '-' ~ (period ? period.id : 'default') %}
            {% set existing = groups[key]|default({ 'label': label, 'color': color, 'types': [] }) %}
            {% set groups = groups|merge({ (key): existing|merge({
                'label': label,
                'color': existing.color ?? color,
                'types': existing.types|merge([t])
            }) }) %}
        {% endfor %}

        {% if groups is empty %}
            <p>Aucun type de chant n'a encore été configuré.</p>
        {% else %}
            {% for groupKey in groups|keys|sort %}
                {% set group = groups[groupKey] %}
                {% set groupColor = group.color ?? '#4b5563' %}
                <div class="sequence-card" style="border-color: {{ groupColor }};">
                    <div class="sequence-card__header" style="color: {{ groupColor }}; border-bottom-color: {{ groupColor }};">
                        {{ group.label }}
                    </div>
                    <table class="sequence-card__table">
                        <thead style="color: {{ groupColor }};">
                            <tr>
                                <th style="width: 30%;">Type</th>
                                <th style="width: 34%;">Choix retenu</th>
                                <th style="width: 18%;">Validation musicien</th>
                                <th style="width: 18%;">Validation paroisse</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for type in group.types %}
                                {% set selection = songSelectionsByType[type.id]|default(null) %}
                                {% set song = selection and selection.songId ? songsById[selection.songId]|default(null) : null %}
                                {% set musicianOK = selection ? selection.validatedByMusician : false %}
                                {% set parishOK = selection ? selection.validatedByParish : false %}
                                <tr>
                                    <td><strong>{{ type.name }}</strong></td>
                                    <td>
                                        {% if song %}
                                            {{ song.name ?? song.title ?? 'Titre inconnu' }}
                                        {% else %}
                                            <span class="muted">Pas de sélection</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="status-label {{ musicianOK ? 'status-label--ok' : 'status-label--pending' }}">
                                            {{ musicianOK ? 'Validé' : 'À valider' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-label {{ parishOK ? 'status-label--ok' : 'status-label--pending' }}">
                                            {{ parishOK ? 'Validé' : 'À valider' }}
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        {% endif %}
    </section>

    {% if notesHtml %}
        <section class="notes-block">
            <h2>Notes aux intervenants</h2>
            {{ notesHtml|raw }}
        </section>
    {% endif %}

    <section class="contacts-block">
        <h2>Contacts utiles</h2>
        <ul class="contacts-list">
            <li><strong>Couple :</strong>
                {% if wedding.marie or wedding.mariee %}
                    {{ wedding.marie ? wedding.marie.fullName : 'Marié' }} &amp; {{ wedding.mariee ? wedding.mariee.fullName : 'Mariée' }}
                {% else %}
                    À compléter
                {% endif %}
            </li>
            <li><strong>Lien :</strong> {{ weddingUrl }}</li>
        </ul>
        <div class="qr-inline">
            <img src="{{ qrCodeUrl }}" alt="QR code du mariage">
            <p class="muted">Scannez le QR code pour ouvrir le déroulé en ligne.</p>
        </div>
    </section>

    <footer>
        Notre Messe de Mariage © Nuptia Logos 2026 - Document généré le {{ generatedAt|date('d/m/Y à H\hi') }} - {{ weddingUrl }}
    </footer>
</div>
</body>
</html>
