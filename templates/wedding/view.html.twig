{% extends 'base.html.twig' %}

{% block title %}
	{% if wedding.marie or wedding.mariee or wedding.marieFirstName or wedding.marieeFirstName %}
		Mariage de
		{% if wedding.marie %}
			{{ wedding.marie.fullName }}
		{% elseif wedding.marieFirstName %}
			{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}{% else %}Mari√©
		{% endif %}
		&amp;
		{% if wedding.mariee %}
			{{ wedding.mariee.fullName }}
		{% elseif wedding.marieeFirstName %}
			{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}{% else %}Mari√©e
		{% endif %}
	{% else %}
		D√©tails du mariage
	{% endif %}
{% endblock %}

{% block body %}
	{% set songSelectionsByType = songSelectionsByType|default({}) %}
	{% set commentCountsByType = commentCountsByType|default({}) %}
	{% set availableSongsByType = availableSongsByType|default({}) %}
	{% set availableSongsByTypeInMusiciansRepo = availableSongsByTypeInMusiciansRepo|default({}) %}
	<div class="container-xl py-5">
		<div class="wizard-layout wizard-layout--full" id="weddingWizardView" data-default-step="0">
			<section class="wizard-panel">
				<header class="wizard-header">
					<div class="wizard-header__intro">
						<h2 class="wizard-panel__title">
							{% if wedding.marie or wedding.mariee or wedding.marieFirstName or wedding.marieeFirstName %}
								Mariage de
								{% if wedding.marie %}
									{{ wedding.marie.fullName }}
								{% elseif wedding.marieFirstName %}
									{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}{% else %}Mari√©
								{% endif %}
								&amp;
								{% if wedding.mariee %}
									{{ wedding.mariee.fullName }}
								{% elseif wedding.marieeFirstName %}
									{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}{% else %}Mari√©e
								{% endif %}
							{% else %}
								D√©tails du mariage
							{% endif %}
						</h2>
						<p class="wizard-header__meta mb-0">
							<span>
								{% if wedding.marie or wedding.mariee or wedding.marieFirstName or wedding.marieeFirstName %}
									{% if wedding.marie %}
										{{ wedding.marie.fullName }}
									{% elseif wedding.marieFirstName %}
										{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}{% else %}Mari√© √† compl√©ter
									{% endif %}
									&amp;
									{% if wedding.mariee %}
										{{ wedding.mariee.fullName }}
									{% elseif wedding.marieeFirstName %}
										{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}{% else %}Mari√©e √† compl√©ter
									{% endif %}
								{% else %}
									Couple √† compl√©ter pour personnaliser la collaboration.
								{% endif %}
							</span>
							{% if wedding.date %}
								<span>&mdash;
									{{ wedding.date|date('d/m/Y') }}</span>
							{% endif %}
							{% if wedding.church %}
								<span>&mdash;
									{{ wedding.church }}</span>
							{% endif %}
						</p>
					</div>
					<div class="wizard-header__actions">
						<button type="button" class="btn btn-outline-primary btn-rounded btn-icon" data-bs-toggle="modal" data-bs-target="#inviteModal">
							<i class="bi bi-envelope-plus"></i>
							Inviter
						</button>
						<a href="{{ path('app_wedding_edit', {'id': wedding.id}) }}" id="editWeddingBtn" class="btn btn-cta btn-rounded btn-icon js-edit-wedding-btn">
							<i class="bi bi-pencil-square"></i>
							Modifier
						</a>
						<a href="{{ path('app_wedding_index') }}" class="btn btn-outline-secondary btn-rounded">
							Retour aux mariages
						</a>
					</div>
				</header>

				<div class="wizard-stepper" id="weddingStepper">
					<button type="button" class="wizard-stepper__item active" data-step="0">
						Essentiels<br><small>Date &amp; lieu</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="1">
						Couple<br><small>Coordonn√©es</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="2">
						Intervenants<br><small>Musiciens &amp; paroisse</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="3">
						R√©pertoire<br><small>D√©roul√© &amp; validations</small>
					</button>
					{% if not isCouple %}
						<button type="button" class="wizard-stepper__item" data-step="4">
							Suivi<br><small>Finances &amp; archive</small>
						</button>
					{% endif %}
					{% if isMusician|default(false) %}
						<button type="button" class="wizard-stepper__item" data-step="5">
							Notes<br><small>Espace musicien</small>
						</button>
					{% endif %}
				</div>

				<div class="wizard-steps">
					<div class="wizard-step active" data-step="0">
						<div class="form-grid">
							<div class="form-card">
								<div class="form-card__title">
									<span>Calendrier</span>
									<h3 class="mb-0">Renseignements essentiels</h3>
								</div>
								<div class="mb-4">
									<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Format de la c√©l√©bration</span>
									<div class="d-flex flex-wrap gap-2">
										<span class="btn btn-validation {{ wedding.isMesse ? 'is-active' : '' }} disabled" role="presentation">Messe</span>
										<span class="btn btn-validation {{ not wedding.isMesse ? 'is-active' : '' }} disabled" role="presentation">C√©l√©bration</span>
									</div>
								</div>
								<div class="row g-3">
									<div class="col-sm-6">
										<span class="form-label-sm">Date</span>
										<div class="fs-5 fw-semibold text-primary">{{ wedding.date ? wedding.date|date('d/m/Y') : '-' }}</div>
									</div>
									<div class="col-sm-6">
										<span class="form-label-sm">Heure</span>
										<div class="fs-5 fw-semibold text-primary">
											{% if wedding.time %}
												{{ wedding.time|date('H') }}h{{ wedding.time|date('i') }}
											{% else %}
												-
											{% endif %}
										</div>
									</div>
								</div>
							</div>
							<div class="form-card">
								<div class="form-card__title">
									<span>Localisation</span>
									<h3 class="mb-0">Lieu de la c√©l√©bration</h3>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Paroisse</span>
									<div class="fw-semibold">{{ wedding.parish ?? '-' }}</div>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">√âglise</span>
									<div class="fw-semibold">{{ wedding.church ?? '-' }}</div>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Adresse</span>
									<div class="fw-semibold">{{ wedding.addressLine1 ?? '-' }}</div>
									{% if wedding.addressLine2 %}
										<div class="text-muted">{{ wedding.addressLine2 }}</div>
									{% endif %}
									<div class="text-muted">{{ wedding.addressPostalCodeAndCity ?? '' }}</div>
								</div>
							</div>
						</div>
					</div>

					<div class="wizard-step" data-step="1">
						<div class="participant-grid">
							<div>
								{% if wedding.marie %}
									<div class="participant-card">
										<div class="participant-card__header">
											<h3 class="mb-0">Futur mari√©</h3>
											<div class="d-flex flex-column flex-md-row gap-1 gap-md-2 align-items-end align-items-md-center">
												<span class="badge rounded-pill bg-success text-white">
													<i class="bi bi-check-circle me-1"></i>Utilisateur rattach√©
												</span>
												{% if wedding.marie.email %}
													<span class="badge rounded-pill bg-light text-secondary">{{ wedding.marie.email }}</span>
												{% endif %}
											</div>
										</div>
										<div class="participant-card__body d-flex flex-column gap-2">
											<div class="d-flex align-items-center gap-3 mb-2">
												{% if wedding.marie.profilePictureName %}
													<img src="{{ vich_uploader_asset(wedding.marie, 'profilePictureFile') }}" class="participant-avatar" alt="{{ wedding.marie.firstName|default('Mari√©') }}">
												{% else %}
													<div class="participant-avatar participant-avatar--placeholder">
														{{ wedding.marie.firstName|default('')|slice(0,1)|upper ~ wedding.marie.name|default('')|slice(0,1)|upper ?: '-' }}
													</div>
												{% endif %}
												<div>
													<span class="form-label-sm">Nom complet</span>
													<div class="fw-semibold">{{ wedding.marie.fullName ?? '-' }}</div>
												</div>
											</div>
											{% if wedding.marie.telephone %}
												<div class="text-muted small">
													<i class="bi bi-telephone me-1"></i>
													{{ wedding.marie.telephone }}</div>
											{% endif %}
											{% if wedding.marie.addressLine1 or wedding.marie.addressPostalCodeAndCity %}
												<div class="text-muted small">
													{% if wedding.marie.addressLine1 %}
														{{ wedding.marie.addressLine1 }}<br>
													{% endif %}
													{% if wedding.marie.addressLine2 %}
														{{ wedding.marie.addressLine2 }}<br>
													{% endif %}
													{% if wedding.marie.addressPostalCodeAndCity %}
														{{ wedding.marie.addressPostalCodeAndCity }}
													{% endif %}
												</div>
											{% endif %}
										</div>
									</div>
								{% elseif wedding.marieFirstName or wedding.marieName or wedding.marieEmail %}
									<div class="participant-card">
										<div class="participant-card__header">
											<h3 class="mb-0">Futur mari√©</h3>
											<div class="d-flex flex-column flex-md-row gap-1 gap-md-2 align-items-end align-items-md-center">
												<span class="badge rounded-pill bg-warning text-dark">
													<i class="bi bi-exclamation-triangle me-1"></i>Aucun utilisateur rattach√©
												</span>
												{% if wedding.marieEmail %}
													<span class="badge rounded-pill bg-light text-secondary">{{ wedding.marieEmail }}</span>
												{% endif %}
											</div>
										</div>
										<div class="participant-card__body d-flex flex-column gap-2">
											{% if wedding.marieFirstName or wedding.marieName %}
												<div>
													<span class="form-label-sm">Nom complet</span>
													<div class="fw-semibold">{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}</div>
												</div>
											{% endif %}
											{% if wedding.marieTelephone %}
												<div class="text-muted small">
													<i class="bi bi-telephone me-1"></i>
													{{ wedding.marieTelephone }}</div>
											{% endif %}
											{% if wedding.marieAddressLine1 or wedding.marieAddressPostalCodeAndCity %}
												<div class="text-muted small">
													{% if wedding.marieAddressLine1 %}
														{{ wedding.marieAddressLine1 }}<br>
													{% endif %}
													{% if wedding.marieAddressLine2 %}
														{{ wedding.marieAddressLine2 }}<br>
													{% endif %}
													{% if wedding.marieAddressPostalCodeAndCity %}
														{{ wedding.marieAddressPostalCodeAndCity }}
													{% endif %}
												</div>
											{% endif %}
										</div>
									</div>
								{% else %}
									<div class="participant-empty">
										<h3 class="mb-1">Futur mari√© manquant</h3>
										<p class="mb-0">Aucune information renseign√©e pour le futur mari√©.</p>
									</div>
								{% endif %}
							</div>

							<div>
								{% if wedding.mariee %}
									<div class="participant-card">
										<div class="participant-card__header">
											<h3 class="mb-0">Future mari√©e</h3>
											<div class="d-flex flex-column flex-md-row gap-1 gap-md-2 align-items-end align-items-md-center">
												<span class="badge rounded-pill bg-success text-white">
													<i class="bi bi-check-circle me-1"></i>Utilisateur rattach√©
												</span>
												{% if wedding.mariee.email %}
													<span class="badge rounded-pill bg-light text-secondary">{{ wedding.mariee.email }}</span>
												{% endif %}
											</div>
										</div>
										<div class="participant-card__body d-flex flex-column gap-2">
											<div class="d-flex align-items-center gap-3 mb-2">
												{% if wedding.mariee.profilePictureName %}
													<img src="{{ vich_uploader_asset(wedding.mariee, 'profilePictureFile') }}" class="participant-avatar" alt="{{ wedding.mariee.firstName|default('Mari√©e') }}">
												{% else %}
													<div class="participant-avatar participant-avatar--placeholder">
														{{ wedding.mariee.firstName|default('')|slice(0,1)|upper ~ wedding.mariee.name|default('')|slice(0,1)|upper ?: '-' }}
													</div>
												{% endif %}
												<div>
													<span class="form-label-sm">Nom complet</span>
													<div class="fw-semibold">{{ wedding.mariee.fullName ?? '-' }}</div>
												</div>
											</div>
											{% if wedding.mariee.telephone %}
												<div class="text-muted small">
													<i class="bi bi-telephone me-1"></i>
													{{ wedding.mariee.telephone }}</div>
											{% endif %}
											{% if wedding.mariee.addressLine1 or wedding.mariee.addressPostalCodeAndCity %}
												<div class="text-muted small">
													{% if wedding.mariee.addressLine1 %}
														{{ wedding.mariee.addressLine1 }}<br>
													{% endif %}
													{% if wedding.mariee.addressLine2 %}
														{{ wedding.mariee.addressLine2 }}<br>
													{% endif %}
													{% if wedding.mariee.addressPostalCodeAndCity %}
														{{ wedding.mariee.addressPostalCodeAndCity }}
													{% endif %}
												</div>
											{% endif %}
										</div>
									</div>
								{% elseif wedding.marieeFirstName or wedding.marieeName or wedding.marieeEmail %}
									<div class="participant-card">
										<div class="participant-card__header">
											<h3 class="mb-0">Future mari√©e</h3>
											<div class="d-flex flex-column flex-md-row gap-1 gap-md-2 align-items-end align-items-md-center">
												<span class="badge rounded-pill bg-warning text-dark">
													<i class="bi bi-exclamation-triangle me-1"></i>Aucun utilisateur rattach√©
												</span>
												{% if wedding.marieeEmail %}
													<span class="badge rounded-pill bg-light text-secondary">{{ wedding.marieeEmail }}</span>
												{% endif %}
											</div>
										</div>
										<div class="participant-card__body d-flex flex-column gap-2">
											{% if wedding.marieeFirstName or wedding.marieeName %}
												<div>
													<span class="form-label-sm">Nom complet</span>
													<div class="fw-semibold">{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}</div>
												</div>
											{% endif %}
											{% if wedding.marieeTelephone %}
												<div class="text-muted small">
													<i class="bi bi-telephone me-1"></i>
													{{ wedding.marieeTelephone }}</div>
											{% endif %}
											{% if wedding.marieeAddressLine1 or wedding.marieeAddressPostalCodeAndCity %}
												<div class="text-muted small">
													{% if wedding.marieeAddressLine1 %}
														{{ wedding.marieeAddressLine1 }}<br>
													{% endif %}
													{% if wedding.marieeAddressLine2 %}
														{{ wedding.marieeAddressLine2 }}<br>
													{% endif %}
													{% if wedding.marieeAddressPostalCodeAndCity %}
														{{ wedding.marieeAddressPostalCodeAndCity }}
													{% endif %}
												</div>
											{% endif %}
										</div>
									</div>
								{% else %}
									<div class="participant-empty">
										<h3 class="mb-1">Future mari√©e manquante</h3>
										<p class="mb-0">Aucune information renseign√©e pour la future mari√©e.</p>
									</div>
								{% endif %}
							</div>
						</div>
					</div>

					<div class="wizard-step" data-step="2">
						<div class="form-grid">
							<div class="form-card">
								<div class="form-card__title">
									<span>Musiciens</span>
									<h3 class="mb-0">Coordonner les musiciens</h3>
								</div>
								<div class="d-flex align-items-center gap-2 text-muted small mb-3">
									<span class="badge text-bg-light">{{ wedding.musicians|length }}</span>
									<span>Musicien(s)</span>
								</div>
								{% if wedding.musicians|length > 0 %}
									<ul class="list-group list-group-flush">
										{% for musician in wedding.musicians %}
											<li class="list-group-item px-0 border-0 py-3 d-flex justify-content-between align-items-start gap-3">
												<div>
													<span class="fw-semibold">{{ musician.fullName ?? musician.email }}</span>
													<div class="text-muted small">{{ musician.email }}</div>
													{% if musician.telephone %}
														<div class="text-muted small">
															<i class="bi bi-telephone me-1"></i>
															{{ musician.telephone }}</div>
													{% endif %}
												</div>
											</li>
										{% endfor %}
									</ul>
								{% else %}
									<p class="text-muted small mb-0">Aucun musicien n'est encore associ√© pour le moment.</p>
								{% endif %}
							</div>

							<div class="form-card">
								<div class="form-card__title">
									<span>Paroisse</span>
									<h3 class="mb-0">Collaborer avec la paroisse</h3>
								</div>
								<div class="d-flex align-items-center gap-2 text-muted small mb-3">
									<span class="badge text-bg-light">{{ wedding.parishUsers|length }}</span>
									<span>Contact(s)</span>
								</div>
								{% if wedding.parishUsers|length > 0 %}
									<ul class="list-group list-group-flush">
										{% for parishUser in wedding.parishUsers %}
											<li class="list-group-item px-0 border-0 py-3 d-flex justify-content-between align-items-start gap-3">
												<div>
													<span class="fw-semibold">{{ parishUser.fullName ?? parishUser.email }}</span>
													<div class="text-muted small">{{ parishUser.email }}</div>
													{% if parishUser.telephone %}
														<div class="text-muted small">
															<i class="bi bi-telephone me-1"></i>
															{{ parishUser.telephone }}</div>
													{% endif %}
												</div>
											</li>
										{% endfor %}
									</ul>
								{% else %}
									<p class="text-muted small mb-0">Aucun contact paroissial n'est encore associ√© √† ce mariage.</p>
								{% endif %}
							</div>

							<div class="form-card">
								<div class="form-card__title">
									<span>C√©l√©brant</span>
									<h3 class="mb-0">Coordonn√©es du pr√™tre</h3>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Pr√©nom</span>
									<div class="fw-semibold">{{ wedding.priestFirstName ?? '-' }}</div>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Nom</span>
									<div class="fw-semibold">{{ wedding.priestLastName ?? '-' }}</div>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">T√©l√©phone</span>
									<div class="fw-semibold">{{ wedding.priestPhoneNumber ?? '-' }}</div>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Email</span>
									<div class="fw-semibold">{{ wedding.priestEMail ?? '-' }}</div>
								</div>
							</div>
						</div>
					</div>

					<div class="wizard-step" data-step="3">
					<!-- Petite card de l√©gende pour les s√©lections -->
					<div class="mb-4">
						<div class="alert alert-info mb-0 deroule-legend">
							<span class="deroule-legend__intro">Les ic√¥nes indiquent la disponibilit√© d'un chant  :</span>
							<ul class="deroule-legend__list">
									<li><strong>üéπ</strong> <span>Dans le r√©pertoire d'au moins un musicien</span></li>
									<li><strong>‚ö†Ô∏è</strong> <span>Non pr√©sent dans le r√©pertoire d'au moins un musicien</span></li>
									<li><strong>‚ú®</strong> <span>Suggestion</span></li>
									<li><strong>üìñ</strong> <span>Texte uniquement</span></li>
							</ul>
						</div>
					</div>
						<div class="deroule-container">
							{% set types = songTypes is defined ? songTypes : [] %}
							{% set groups = {} %}
							{% for t in types %}
								{% set period = t.celebrationPeriod %}
								{% set label = period ? period.fullName : 'Autres' %}
								{% set color = period ? period.color : null %}
								{% set orderValue = period and period.periodOrder is not null ? period.periodOrder : 999 %}
								{% set key = '%03d'|format(orderValue) ~ '-' ~ (period ? period.id : 'default') %}
								{% set existing = groups[key]|default({ 'label': label, 'color': color, 'order': orderValue, 'types': [] }) %}
								{% set groups = groups|merge({
									(key): existing|merge({
										'label': label,
										'color': color,
										'order': orderValue,
										'types': existing.types|merge([t])
									})
								}) %}
							{% endfor %}
							{% set orderedGroupKeys = groups|keys|sort %}

							{% if groups is empty %}
								<div class="alert alert-light mb-0">Aucun type de chant d√©fini. Ajoute des types dans l'administration.</div>
							{% else %}
								<div class="deroule-print-action d-print-none mb-3">
									<a href="{{ path('app_wedding_export_pdf', { id: wedding.id }) }}" class="btn btn-outline-primary btn-rounded" target="_blank" rel="noopener">
										<i class="bi bi-filetype-pdf me-2"></i>
										Exporter le d√©roul√© en PDF
									</a>
								</div>

								<div class="deroule-print-header d-none d-print-block">
									<h1 class="deroule-print-title">D√©roul√© de la c√©l√©bration</h1>
									<div class="deroule-print-info">
										<p class="mb-1">
											<strong>
												{% if wedding.marie or wedding.mariee %}
													{{ wedding.marie ? wedding.marie.fullName : 'Mari√©' }}
													&amp;
													{{ wedding.mariee ? wedding.mariee.fullName : 'Mari√©e' }}
												{% else %}
													Mariage
												{% endif %}
											</strong>
										</p>
										{% if wedding.date %}
											<p class="mb-1">{{ wedding.date|date('d/m/Y') }}
												{% if wedding.time %}
													√†
													{{ wedding.time|date('H') }}h{{ wedding.time|date('i') }}
												{% endif %}
											</p>
										{% endif %}
										{% if wedding.church %}
											<p class="mb-0">{{ wedding.church }}
												{% if wedding.parish %}
													-
													{{ wedding.parish }}
												{% endif %}
											</p>
										{% endif %}
									</div>
								</div>
								<div class="deroule-header d-none d-lg-flex">
									<div class="deroule-col-type">TYPE</div>
									<div class="deroule-col-choice">VOTRE CHOIX</div>
									<div class="deroule-col-check">VALIDATIONS</div>
									<div class="deroule-col-check">EN CHARGE</div>
									<div class="deroule-col-comments">COM.</div>
								</div>

								<div class="deroule-groups">
									{% for groupKey in orderedGroupKeys %}
										{% set group = groups[groupKey] %}
										{% set sanitizedLabel = group.label ? group.label|replace({' ': '_'}) : 'Autres' %}
										<div class="deroule-group">
											<div class="deroule-group-header" {% if group.color %} style="border-left: 4px solid {{ group.color }}; background-color: {{ group.color }};" {% endif %}>{{ group.label }}</div>
											<div class="deroule-group-body">
												{% for type in group.types %}
													{% set songsForType = availableSongsByType[type.id]|default(type.songs) %}
													{% set selectionState = songSelectionsByType[type.id]|default({}) %}
													{% set selectedSongId = selectionState.songId ?? null %}
													{% set validatedMusician = selectionState.validatedByMusician ?? false %}
													{% set validatedParish = selectionState.validatedByParish ?? false %}
													<div class="deroule-row">
														<div>
															<span class="deroule-type-badge" style="{% if group.color %}background-color: {{ group.color }}; color: #FFFFFF;{% endif %}; max-width: 160px; width: 160px;">{{ type.name }}</span>
														</div>
														<div class="d-flex gap-2 align-items-center">
															{% if selectedSongId %}
																{% set song = songsForType|filter(s => s.id == selectedSongId)|first %}
															{% else %}
																{% set song = null %}
															{% endif %}
															{% if song is null %}
																<span class="text-muted">(Pas de s√©lection)</span>
															{% else %}
																{# Display song name with suggestion indicator #}
																{% if not song.song %}üìñ
																	{% elseif song.suggestion %}‚ú®
																	{% elseif song in availableSongsByTypeInMusiciansRepo[type.id]|default([]) %}üéπ
																	{% else %}‚ö†Ô∏è
																{% endif %}
																{{ song.name ?? (song.title ?? 'Titre inconnu') }}

																<button type="button" class="btn btn-sm btn-outline-secondary js-preview-song" data-song-type="{{ type.id }}" data-song-id="{{ selectedSongId }}" title="Pr√©visualiser le chant" {% if selectedSongId is null %} disabled {% endif %}>
																	<i class="bi bi-eye"></i>
																</button>
															{% endif %}
														</div>
														<div>
															<input type="hidden" name="deroule_validation_musician[{{ type.id }}]" value="{{ validatedMusician ? '1' : '0' }}" data-validation-input="musician-{{ type.id }}">
															<button type="button" class="btn btn-validation js-validation-toggle {{ validatedMusician ? 'is-active' : '' }}" data-role="musician" data-type="{{ type.id }}">MUS</button>
														</div>
														<div>
															<input type="hidden" name="deroule_validation_parish[{{ type.id }}]" value="{{ validatedParish ? '1' : '0' }}" data-validation-input="parish-{{ type.id }}">
															<button type="button" class="btn btn-validation js-validation-toggle {{ validatedParish ? 'is-active' : '' }}" data-role="parish" data-type="{{ type.id }}">PAR</button>
														</div>
														<div class="deroule-person-field">
															{% set personOwner = selectionState.personneEnCharge|default(null) %}
															{% if personOwner %}
																<span class="badge text-bg-light text-dark">{{ personOwner }}</span>
															{% else %}
																<span class="text-muted small">Non renseign√©</span>
															{% endif %}
														</div>
														<div>
															{% if wedding.id %}
																{% set commentsCount = selectionState.commentsCount|default(commentCountsByType[type.id]|default(0)) %}
																<div class="d-flex align-items-center gap-2">
																	<button type="button" class="btn btn-sm btn-outline-secondary open-comments" data-wedding="{{ wedding.id }}" data-songtype="{{ type.id }}" aria-haspopup="dialog" aria-controls="commentsModal">
																		<i class="bi bi-chat-dots"></i>
																	</button>
																	{% if commentsCount > 0 %}
																		<span class="badge rounded-pill text-bg-secondary" aria-label="{{ commentsCount }} commentaire{{ commentsCount > 1 ? 's' : '' }}">
																			{{ commentsCount }}
																		</span>
																	{% endif %}
																</div>
															{% else %}
																<button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Sauvegardez le mariage pour activer les commentaires">
																	<i class="bi bi-chat-dots"></i>
																</button>
															{% endif %}
														</div>
													</div>
												{% endfor %}
											</div>
										</div>
									{% endfor %}
								</div>
							{% endif %}
						</div>
						{% if form is defined %}
							{{ form_widget(form.songs, {'attr': {'class': 'd-none'}}) }}
						{% endif %}
					</div>

					{% if not isCouple %}
						<div class="wizard-step" data-step="4">
							<div class="form-grid">
								<div class="form-card">
									<div class="form-card__title">
										<span>Finances</span>
										<h3 class="mb-0">Suivi des montants</h3>
									</div>
									{% set paymentStatus = {
									'label': 'Statut non d√©fini',
									'badge': 'secondary'
								} %}
									{% if wedding.isPaid %}
										{% set paymentStatus = {
										'label': 'Mariage r√©gl√©',
										'badge': 'success'
									} %}
									{% else %}
										{% if wedding.paymentOption == 'delegated' %}
											{% set paymentStatus = {
											'label': 'En attente du paiement des mari√©s',
											'badge': 'warning'
										} %}
										{% elseif wedding.paymentOption == 'card_pending_partner' %}
											{% set paymentStatus = {
											'label': 'Paiement partenaire en cours',
											'badge': 'warning'
										} %}
										{% elseif wedding.paymentOption == 'card_partner' %}
											{% set paymentStatus = {
											'label': 'Paiement CB partenaire confirm√©',
											'badge': 'success'
										} %}
										{% elseif wedding.paymentOption == 'card_user' %}
											{% set paymentStatus = {
											'label': 'Paiement en ligne √† finaliser',
											'badge': 'info'
										} %}
										{% elseif wedding.paymentOption == 'credit' %}
											{% set paymentStatus = {
											'label': 'R√©gl√© via cr√©dits',
											'badge': 'success'
										} %}
										{% endif %}
									{% endif %}

									<div class="wizard-finance-grid">
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Montant de la prestation</div>
											<div class="wizard-finance-value">{{ wedding.montantTotal is not null ? (wedding.montantTotal ~ ' ‚Ç¨') : '-' }}</div>
										</div>
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Montant d√©j√† vers√©</div>
											<div class="wizard-finance-value">{{ wedding.montantPaye is not null ? (wedding.montantPaye ~ ' ‚Ç¨') : '-' }}</div>
										</div>
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Statut du paiement</div>
											<div class="wizard-finance-value">
												<span class="badge text-bg-{{ paymentStatus.badge }}">{{ paymentStatus.label }}</span>
											</div>
										</div>
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Acompte</div>
											<div class="wizard-finance-value">
												{% if wedding.montantTotal and wedding.montantPaye is not null and wedding.montantTotal > 0 %}
													{{ ((wedding.montantPaye / wedding.montantTotal) * 100)|round(0) }}
													%
												{% else %}
													-
												{% endif %}
											</div>
										</div>
										<div class="wizard-finance-item">
											<div class="wizard-finance-label">Reste d√ª</div>
											<div class="wizard-finance-value">
												{% if wedding.montantTotal is not null and wedding.montantPaye is not null %}
													{{ (wedding.montantTotal - wedding.montantPaye)|number_format(2, '.', ' ') }}
													‚Ç¨
												{% else %}
													-
												{% endif %}
											</div>
										</div>
									</div>

									<div class="wizard-finance-inputs">
										<div class="wizard-finance-field">
											<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Cr√©√© avec un cr√©dit ?</span>
											<div class="fw-semibold">{{ wedding.createdWithCredit ? 'Oui' : 'Non' }}</div>
										</div>
										<div class="wizard-finance-field">
											<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Paiement exig√© des mari√©s ?</span>
											<div class="fw-semibold">{{ wedding.requiresCouplePayment ? 'Oui' : 'Non' }}</div>
										</div>
									</div>
								</div>

								<div class="form-card">
									<div class="form-card__title">
										<span>Cl√¥ture</span>
										<h3 class="mb-0">Archive &amp; options</h3>
									</div>
									<div class="mb-3">
										<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Statut du dossier</span>
										<div class="d-flex flex-wrap gap-2">
											<span class="btn btn-validation {{ not wedding.archive ? 'is-active' : '' }} disabled" role="presentation">Actif</span>
											<span class="btn btn-validation {{ wedding.archive ? 'is-active' : '' }} disabled" role="presentation">Archiv√©</span>
										</div>
									</div>
									<p class="mb-0 small text-muted">Archivez un mariage une fois la c√©l√©bration pass√©e pour conserver un historique propre.</p>
								</div>
							</div>
						</div>
					{% endif %}

					{# Step 5: Notes Musiciens (r√©serv√© aux musiciens) #}
					{% if isMusician|default(false) %}
						<div class="wizard-step" data-step="5">
							<div class="form-grid form-grid--single">
								<div class="form-card">
									<div class="form-card__title">
										<span>Espace Musicien</span>
										<h3 class="mb-0">Notes pour les musiciens</h3>
									</div>
									<p class="text-muted mb-3">
										Ces notes sont partag√©es entre les musiciens associ√©s √† ce mariage.
									</p>

									<div class="markdown-preview-view">
										<div class="markdown-rendered" id="markdownPreviewView">
											{% if wedding.notesMusiciens %}
												{# Le contenu sera rendu en JavaScript #}
												<div class="markdown-source d-none">{{ wedding.notesMusiciens }}</div>
												<p class="text-muted fst-italic">Chargement de l'aper√ßu...</p>
											{% else %}
												<p class="text-muted fst-italic">
													<i class="bi bi-info-circle me-2"></i>
													Aucune note n'a √©t√© ajout√©e pour le moment.
													<a href="{{ path('app_wedding_edit', {'id': wedding.id, 'step': 5}) }}" class="ms-2">
														<i class="bi bi-pencil me-1"></i>Ajouter des notes
													</a>
												</p>
											{% endif %}
										</div>
									</div>

									{% if wedding.notesMusiciens %}
										<div class="mt-3">
											<a href="{{ path('app_wedding_edit', {'id': wedding.id, 'step': 5}) }}" class="btn btn-outline-primary btn-sm">
												<i class="bi bi-pencil me-1"></i>Modifier les notes
											</a>
										</div>
									{% endif %}
								</div>
							</div>
						</div>
					{% endif %}
				</div>

				<div class="wizard-actions">
					<div class="wizard-actions__nav">
						<button type="button" class="btn btn-outline-secondary wizard-prev d-none" data-action="prev-step">
							<i class="bi bi-arrow-left"></i>
							Retour
						</button>
						<button type="button" class="btn btn-primary wizard-next" data-action="next-step">
							Continuer
							<i class="bi bi-arrow-right ms-2"></i>
						</button>
					</div>
					<a href="{{ path('app_wedding_edit', {'id': wedding.id}) }}" class="btn btn-cta btn-rounded btn-icon js-edit-wedding-btn">
						<i class="bi bi-pencil-square"></i>
						Modifier
					</a>
				</div>
			</section>
		</div>
	</div>

	<div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Commentaires</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body">
					<div class="text-center py-4" id="commentsModalSpinner">
						<div class="spinner-border text-secondary" role="status">
							<span class="visually-hidden">Chargement...</span>
						</div>
					</div>
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="inviteModalLabel">Inviter quelqu'un</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<form action="{{ path('app_wedding_invite', {'id': wedding.id}) }}" method="POST">
					<div class="modal-body">
						<div class="mb-3">
							<label for="email" class="form-label">Email</label>
							<input type="email" class="form-control" id="email" name="email" required>
						</div>
						<div class="mb-3">
							<label for="role" class="form-label">R√¥le</label>
							<select class="form-select" id="role" name="role" required>
								<option value="paroisse">Paroisse</option>
								<option value="musicien">Musicien</option>
								<option value="marie">Mari√©</option>
								<option value="mariee">Mari√©e</option>
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						<button type="submit" class="btn btn-primary">Envoyer l'invitation</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Modal de pr√©visualisation d'un chant -->
	<div class="modal fade" id="songPreviewModal" tabindex="-1" aria-labelledby="songPreviewModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="songPreviewModalLabel">Pr√©visualisation du chant</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body" id="songPreviewModalBody">
					<div class="text-center py-4" id="songPreviewSpinner">
						<div class="spinner-border text-secondary" role="status">
							<span class="visually-hidden">Chargement...</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	 <script>
			document.addEventListener('DOMContentLoaded', function () {
				console.log('=== DEBUT SCRIPT VIEW ===');
				const wizardLayout = document.getElementById('weddingWizardView');
				console.log('wizardLayout:', wizardLayout);
				const steps = Array.from(document.querySelectorAll('.wizard-step'));
				console.log('Steps trouv√©s:', steps.length);
				const stepperItems = Array.from(document.querySelectorAll('.wizard-stepper__item'));
				console.log('Stepper items:', stepperItems.length);
				const prevBtn = document.querySelector('.wizard-prev');
				const nextBtn = document.querySelector('.wizard-next');
				
				// Initialiser avec le step pass√© en param√®tre URL
				let currentStep = {{ initialStep|default(0) }};
				console.log('Step initial depuis le serveur:', currentStep);
	
				if (wizardLayout) {
					const defaultStep = parseInt(wizardLayout.dataset.defaultStep || '0', 10);
					if (!Number.isNaN(defaultStep)) {
						currentStep = Math.max(0, Math.min(steps.length - 1, defaultStep));
					}
				}
	
				function syncUI() {
					console.log('syncUI appel√©, currentStep =', currentStep);
					steps.forEach((step, index) => step.classList.toggle('active', index === currentStep));
					stepperItems.forEach((item, index) => item.classList.toggle('active', index === currentStep));
					if (prevBtn) {
						prevBtn.classList.toggle('d-none', currentStep === 0);
					}
					if (nextBtn) {
						nextBtn.classList.toggle('d-none', currentStep >= steps.length - 1);
					}
				}
	
				if (prevBtn) {
					prevBtn.addEventListener('click', function () {
						if (currentStep > 0) {
							currentStep -= 1;
							syncUI();
						}
					});
				}
	
				if (nextBtn) {
					nextBtn.addEventListener('click', function () {
						if (currentStep < steps.length - 1) {
							currentStep += 1;
							syncUI();
						}
					});
				}
	
				stepperItems.forEach((item) => {
					item.addEventListener('click', function () {
						const target = parseInt(item.dataset.step, 10);
						console.log('Clic sur stepper item, √©tape:', target);
						if (!Number.isNaN(target)) {
							currentStep = target;
							syncUI();
						}
					});
				});
	
				console.log('Appel initial de syncUI');
				syncUI();
	
				// Intercepter le clic sur les boutons "Modifier" pour ajouter l'√©tape actuelle
				const editButtons = document.querySelectorAll('.js-edit-wedding-btn');
				console.log('=== RECHERCHE BOUTONS MODIFIER ===');
				console.log('Boutons Modifier trouv√©s:', editButtons.length);
				console.log('currentStep actuel:', currentStep);
				
				if (editButtons.length > 0) {
					console.log('Installation des listeners sur', editButtons.length, 'bouton(s) Modifier');
					editButtons.forEach((editButton, index) => {
						console.log('Bouton', index + 1, '- Href actuel:', editButton.href);
						editButton.addEventListener('click', function(e) {
							e.preventDefault();
							e.stopPropagation();
							const baseUrl = '{{ path('app_wedding_edit', {'id': wedding.id}) }}';
							const finalUrl = baseUrl + '?step=' + currentStep;
							console.log('!!! CLIC DETECTE sur bouton', index + 1, '!!! Redirection vers:', finalUrl, 'currentStep=', currentStep);
							window.location.href = finalUrl;
							return false;
						}, true);
					});
				} else {
					console.error('ERREUR: Aucun bouton Modifier trouv√© !');
				}
	
				const modalEl = document.getElementById('commentsModal');
				if (modalEl && typeof bootstrap !== 'undefined') {
					const bsModal = new bootstrap.Modal(modalEl);
					const bindCommentForm = (formEl, url) => {
						if (!formEl) {
							return;
						}
	
						formEl.addEventListener('submit', async function (evt) {
							evt.preventDefault();
							const fd = new FormData(formEl);
							const action = formEl.getAttribute('action') || url;
							const method = (formEl.getAttribute('method') || 'POST').toUpperCase();
	
							try {
								const response = await fetch(action, {
									method: method,
									body: fd,
									headers: { 'X-Requested-With': 'XMLHttpRequest' },
								});
								if (!response.ok) {
									throw new Error('Requ√™te invalide');
								}
	
								const refreshed = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
								const refreshedText = await refreshed.text();
								const refreshedDoc = new DOMParser().parseFromString(refreshedText, 'text/html');
								const newComments = refreshedDoc.querySelector('#comments-box');
								const newForm = refreshedDoc.querySelector('.card-footer form') || refreshedDoc.querySelector('form');
	
								modalEl.querySelector('.modal-body').querySelector('h2')?.remove();
								if (newComments) {
									const body = modalEl.querySelector('.modal-body');
									const old = body.querySelector('#comments-box');
									if (old) {
										old.replaceWith(newComments.cloneNode(true));
									} else {
										body.appendChild(newComments.cloneNode(true));
									}
								}
	
								const footer = modalEl.querySelector('.modal-footer');
								if (newForm) {
									footer.innerHTML = '';
									const clonedForm = newForm.cloneNode(true);
									footer.appendChild(clonedForm);
									bindCommentForm(clonedForm, url);
								}
							} catch (err) {
								console.error(err);
								alert('Erreur lors de l\'envoi du commentaire.');
							}
						}, { once: true });
					};
					document.querySelectorAll('.open-comments').forEach((btn) => {
						btn.addEventListener('click', async function () {
							const weddingId = this.dataset.wedding;
							const songTypeId = this.dataset.songtype;
							const url = `/comments/${weddingId}/${songTypeId}`;
	
							const body = modalEl.querySelector('.modal-body');
							const footer = modalEl.querySelector('.modal-footer');
							body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Chargement...</span></div></div>';
							footer.innerHTML = '';
							bsModal.show();
	
							try {
								const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
								const text = await res.text();
								const parser = new DOMParser();
								const doc = parser.parseFromString(text, 'text/html');
	
								const header = doc.querySelector('h2');
								const commentsBox = doc.querySelector('#comments-box');
								const form = doc.querySelector('.card-footer form') || doc.querySelector('form');
	
								body.innerHTML = '';
								if (header) {
									body.appendChild(header.cloneNode(true));
								}
								if (commentsBox) {
									body.appendChild(commentsBox.cloneNode(true));
								} else {
									body.innerHTML += '<p class="text-muted">Aucun commentaire.</p>';
								}
	
								footer.innerHTML = '';
								if (form) {
									const injectedForm = form.cloneNode(true);
									footer.appendChild(injectedForm);
									bindCommentForm(injectedForm, url);
								} else {
									footer.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
								}
							} catch (err) {
								console.error(err);
								modalEl.querySelector('.modal-body').innerHTML = '<p class="text-danger">Impossible de charger les commentaires.</p>';
								modalEl.querySelector('.modal-footer').innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
							}
						});
					});
				}
			});
	
			// Rendu Markdown pour les notes musiciens (vue)
			document.addEventListener('DOMContentLoaded', function() {
				const previewContainer = document.getElementById('markdownPreviewView');
				if (!previewContainer) return;
	
				const sourceEl = previewContainer.querySelector('.markdown-source');
				if (!sourceEl) return;
	
				const sourceText = sourceEl.textContent;
				
				// Simple parseur Markdown (m√™me logique que dans edit)
				function parseMarkdown(text) {
					if (!text || !text.trim()) {
						return '<p class="text-muted fst-italic">Aucune note n\'a √©t√© ajout√©e.</p>';
					}
	
					let html = text
						// √âchapper les caract√®res HTML dangereux
						.replace(/&/g, '&amp;')
						.replace(/</g, '&lt;')
						.replace(/>/g, '&gt;')
						// Blocs de code (avant autres transformations)
						.replace(/```([\s\S]*?)```/g, '<pre class="markdown-code-block"><code>$1</code></pre>')
						.replace(/`([^`]+)`/g, '<code class="markdown-inline-code">$1</code>')
						// Titres
						.replace(/^### (.+)$/gm, '<h5 class="markdown-h3">$1</h5>')
						.replace(/^## (.+)$/gm, '<h4 class="markdown-h2">$1</h4>')
						.replace(/^# (.+)$/gm, '<h3 class="markdown-h1">$1</h3>')
						// Gras et italique
						.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
						.replace(/\*([^*]+)\*/g, '<em>$1</em>')
						.replace(/~~([^~]+)~~/g, '<del>$1</del>')
						// Citations
						.replace(/^&gt; (.+)$/gm, '<blockquote class="markdown-quote">$1</blockquote>')
						// Checkboxes
						.replace(/^- \[x\] (.+)$/gm, '<div class="markdown-checkbox"><input type="checkbox" checked disabled> <span>$1</span></div>')
						.replace(/^- \[ \] (.+)$/gm, '<div class="markdown-checkbox"><input type="checkbox" disabled> <span>$1</span></div>')
						// Listes √† puces
						.replace(/^- (.+)$/gm, '<li class="markdown-li">$1</li>')
						.replace(/^(\d+)\. (.+)$/gm, '<li class="markdown-li-num" value="$1">$2</li>')
						// Liens
						.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
						// Lignes horizontales
						.replace(/^---$/gm, '<hr class="markdown-hr">')
						// Paragraphes (lignes vides)
						.replace(/\n\n/g, '</p><p class="markdown-p">')
						// Sauts de ligne simples
						.replace(/\n/g, '<br>');
	
					// Envelopper les listes
					html = html.replace(/(<li class="markdown-li">.*?<\/li>(\s*<br>)?)+/g, function(match) {
						return '<ul class="markdown-ul">' + match.replace(/<br>/g, '') + '</ul>';
					});
					html = html.replace(/(<li class="markdown-li-num".*?<\/li>(\s*<br>)?)+/g, function(match) {
						return '<ol class="markdown-ol">' + match.replace(/<br>/g, '') + '</ol>';
					});
	
					return '<div class="markdown-body"><p class="markdown-p">' + html + '</p></div>';
				}
	
				// Remplacer le contenu par le rendu Markdown
				previewContainer.innerHTML = parseMarkdown(sourceText);
			});
	
			// Pr√©visualisation des chants
			(function() {
				const songPreviewModalEl = document.getElementById('songPreviewModal');
				const songPreviewModalBody = document.getElementById('songPreviewModalBody');
				
				if (!songPreviewModalEl || typeof bootstrap === 'undefined') return;
				
				const songPreviewModal = new bootstrap.Modal(songPreviewModalEl);
				
				// Gestion des clics sur les boutons de pr√©visualisation
				document.querySelectorAll('.js-preview-song').forEach(btn => {
					btn.addEventListener('click', function() {
						const songId = this.dataset.songId;
						if (!songId) return;
						
						// Afficher la modal avec le spinner
						songPreviewModalBody.innerHTML = `
							<div class="text-center py-4">
								<div class="spinner-border text-secondary" role="status">
									<span class="visually-hidden">Chargement...</span>
								</div>
							</div>
						`;
						songPreviewModal.show();
						
						// Charger le contenu via AJAX
						fetch(`/songs/preview/${songId}`)
							.then(response => {
								if (!response.ok) throw new Error('Chant introuvable');
								return response.text();
							})
							.then(html => {
								songPreviewModalBody.innerHTML = html;
							})
							.catch(error => {
								songPreviewModalBody.innerHTML = `
									<div class="alert alert-danger mb-0">
										<i class="bi bi-exclamation-triangle me-2"></i>
										Impossible de charger la pr√©visualisation du chant.
									</div>
								`;
							});
					});
				});
				
				// Mettre √† jour le bouton de pr√©visualisation quand le select change
				document.querySelectorAll('.js-deroule-select').forEach(select => {
					select.addEventListener('change', function() {
						const previewBtn = this.closest('.deroule-row')?.querySelector('.js-preview-song');
						if (previewBtn) {
							const selectedSongId = this.value;
							previewBtn.dataset.songId = selectedSongId;
							previewBtn.disabled = !selectedSongId;
						}
					});
				});
			})();
		</script>
{% endblock %}

