{% extends 'base.html.twig' %}

{% block title %}
	{% if wedding.marie or wedding.mariee or wedding.marieFirstName or wedding.marieeFirstName %}
		Mariage de {% if wedding.marie %}{{ wedding.marie.fullName }}{% elseif wedding.marieFirstName %}{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}{% else %}Marié{% endif %} &amp; {% if wedding.mariee %}{{ wedding.mariee.fullName }}{% elseif wedding.marieeFirstName %}{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}{% else %}Mariée{% endif %}
	{% else %}
		Détails du mariage
	{% endif %}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
{% endblock %}

{% block body %}
	{% set songSelectionsByType = songSelectionsByType|default({}) %}
	{% set commentCountsByType = commentCountsByType|default({}) %}
	{% set types = [] %}
	{% for type in songTypes %}
		{% if wedding.isMesse or not type.isMesse %}
			{% set types = types|merge([type]) %}
		{% endif %}
	{% endfor %}

	{% set groups = {} %}
	{% for t in types %}
		{% set groupKey = t.celebrationPeriod is not null ? t.celebrationPeriod.value : 'Autres' %}
		{% if groups[groupKey] is defined %}
			{% set groups = groups|merge({ (groupKey): groups[groupKey]|merge([t]) }) %}
		{% else %}
			{% set groups = groups|merge({ (groupKey): [t] }) %}
		{% endif %}
	{% endfor %}

	{% set orderedLabels = groups|keys|sort((a, b) => a <=> b) %}
	{% set selectionMap = {} %}
	{% for selection in wedding.songSelections %}
		{% if selection.songType %}
			{% set selectionMap = selectionMap|merge({ ('id_' ~ selection.songType.id): selection }) %}
		{% endif %}
	{% endfor %}

	<div class="container-xl py-5">
		<div class="wizard-layout wizard-layout--full" id="weddingWizardView" data-default-step="{{ initialStep|default(0) }}">
			<section class="wizard-panel">
				<header class="wizard-header">
					<div class="wizard-header__intro">
						<h2 class="wizard-panel__title">
							{% if wedding.marie or wedding.mariee or wedding.marieFirstName or wedding.marieeFirstName %}
								Mariage de {% if wedding.marie %}{{ wedding.marie.fullName }}{% elseif wedding.marieFirstName %}{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}{% else %}Marié{% endif %} &amp; {% if wedding.mariee %}{{ wedding.mariee.fullName }}{% elseif wedding.marieeFirstName %}{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}{% else %}Mariée{% endif %}
							{% else %}
								Détails du mariage
							{% endif %}
						</h2>
						<p class="wizard-header__meta mb-0">
							<span>
								{% if wedding.marie or wedding.mariee or wedding.marieFirstName or wedding.marieeFirstName %}
									{% if wedding.marie %}{{ wedding.marie.fullName }}{% elseif wedding.marieFirstName %}{{ wedding.marieFirstName ~ ' ' ~ wedding.marieName }}{% else %}Marié à compléter{% endif %} &amp; {% if wedding.mariee %}{{ wedding.mariee.fullName }}{% elseif wedding.marieeFirstName %}{{ wedding.marieeFirstName ~ ' ' ~ wedding.marieeName }}{% else %}Mariée à compléter{% endif %}
								{% else %}
									Couple à compléter pour personnaliser la collaboration.
								{% endif %}
							</span>
							{% if wedding.date %}
								<span>&mdash; {{ wedding.date|date('d/m/Y') }}</span>
							{% endif %}
							{% if wedding.church %}
								<span>&mdash; {{ wedding.church }}</span>
							{% endif %}
						</p>
					</div>
					<div class="wizard-header__actions">
						<button type="button" class="btn btn-outline-primary btn-rounded btn-icon" data-bs-toggle="modal" data-bs-target="#inviteModal">
							<i class="bi bi-envelope-plus"></i>
							Inviter
						</button>
						<a href="{{ path('app_wedding_edit', {'id': wedding.id}) }}" id="editWeddingBtn" class="btn btn-cta btn-rounded btn-icon js-edit-wedding-btn">
							<i class="bi bi-pencil-square"></i>
							Modifier
						</a>
						<a href="{{ path('app_wedding_index') }}" class="btn btn-outline-secondary btn-rounded">
							Retour aux mariages
						</a>
					</div>
				</header>

				<div class="wizard-stepper" id="weddingStepper">
					<button type="button" class="wizard-stepper__item active" data-step="0">
						Essentiels<br><small>Date &amp; lieu</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="1">
						Couple<br><small>Coordonnées</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="2">
						Intervenants<br><small>Musiciens &amp; paroisse</small>
					</button>
					<button type="button" class="wizard-stepper__item" data-step="3">
						Répertoire<br><small>Déroulé &amp; validations</small>
					</button>
					{% if not isCouple %}
						<button type="button" class="wizard-stepper__item" data-step="4">
							Suivi<br><small>Finances &amp; archive</small>
						</button>
					{% endif %}
				</div>

				<div class="wizard-steps">
					<div class="wizard-step active" data-step="0">
						<div class="form-grid">
							<div class="form-card">
								<div class="form-card__title">
									<span>Calendrier</span>
									<h3 class="mb-0">Renseignements essentiels</h3>
								</div>
								<div class="mb-4">
									<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Format de la célébration</span>
									<div class="d-flex flex-wrap gap-2">
										<span class="btn btn-validation {{ wedding.isMesse ? 'is-active' : '' }} disabled" role="presentation">Messe</span>
										<span class="btn btn-validation {{ not wedding.isMesse ? 'is-active' : '' }} disabled" role="presentation">Célébration</span>
									</div>
								</div>
								<div class="row g-3">
									<div class="col-sm-6">
										<span class="form-label-sm">Date</span>
										<div class="fs-5 fw-semibold text-primary">{{ wedding.date ? wedding.date|date('d/m/Y') : '-' }}</div>
									</div>
									<div class="col-sm-6">
										<span class="form-label-sm">Heure</span>
										<div class="fs-5 fw-semibold text-primary">
											{% if wedding.time %}
												{{ wedding.time|date('H') }}h{{ wedding.time|date('i') }}
											{% else %}
												-
											{% endif %}
										</div>
									</div>
								</div>
							</div>
							<div class="form-card">
								<div class="form-card__title">
									<span>Localisation</span>
									<h3 class="mb-0">Lieu de la célébration</h3>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Paroisse</span>
									<div class="fw-semibold">{{ wedding.parish ?? '-' }}</div>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Église</span>
									<div class="fw-semibold">{{ wedding.church ?? '-' }}</div>
								</div>
								<div class="form-group-sm">
									<span class="form-label-sm">Adresse</span>
									<div class="fw-semibold">{{ wedding.addressLine1 ?? '-' }}</div>
									{% if wedding.addressLine2 %}
										<div class="text-muted">{{ wedding.addressLine2 }}</div>
									{% endif %}
									<div class="text-muted">{{ wedding.addressPostalCodeAndCity ?? '' }}</div>
								</div>
							</div>
						</div>
					</div>
								{% include 'wedding/_view_participant.html.twig' with {
									'label': 'Futur marié',
									'user': wedding.marie,
									'userEmail': wedding.marie ? wedding.marie.email : wedding.marieEmail,
									'firstName': wedding.marie ? wedding.marie.firstName : wedding.marieFirstName,
									'lastName': wedding.marie ? wedding.marie.name : wedding.marieName,
									'telephone': wedding.marie ? wedding.marie.telephone : wedding.marieTelephone,
									'addressLine1': wedding.marie ? wedding.marie.addressLine1 : wedding.marieAddressLine1,
									'addressLine2': wedding.marie ? wedding.marie.addressLine2 : wedding.marieAddressLine2,
									'addressPostalCodeAndCity': wedding.marie ? wedding.marie.addressPostalCodeAndCity : wedding.marieAddressPostalCodeAndCity
								} only %}
							</div>

							<div>
								{% include 'wedding/_view_participant.html.twig' with {
									'label': 'Future mariée',
									'user': wedding.mariee,
									'userEmail': wedding.mariee ? wedding.mariee.email : wedding.marieeEmail,
									'firstName': wedding.mariee ? wedding.mariee.firstName : wedding.marieeFirstName,
									'lastName': wedding.mariee ? wedding.mariee.name : wedding.marieeName,
									'telephone': wedding.mariee ? wedding.mariee.telephone : wedding.marieeTelephone,
									'addressLine1': wedding.mariee ? wedding.mariee.addressLine1 : wedding.marieeAddressLine1,
									'addressLine2': wedding.mariee ? wedding.mariee.addressLine2 : wedding.marieeAddressLine2,
									'addressPostalCodeAndCity': wedding.mariee ? wedding.mariee.addressPostalCodeAndCity : wedding.marieeAddressPostalCodeAndCity
								} only %}
							</div>
						</div>
					</div>

					<div class="wizard-step" data-step="3">
						<div class="deroule-container">
							{% if groups is empty %}
								<div class="alert alert-light mb-0">Aucun type de chant défini. Ajoutez des types dans l'administration.</div>
							{% else %}
								<div class="deroule-print-action d-print-none mb-3">
									<button type="button" id="printDerouleBtn" class="btn btn-outline-primary btn-rounded">
										<i class="bi bi-printer me-2"></i>
										Imprimer le déroulé
									</button>
								</div>
								<div class="deroule-print-header d-none d-print-block">
									<h1 class="deroule-print-title">Déroulé de la célébration</h1>
									<div class="deroule-print-info">
										<p class="mb-1">
											<strong>
												{% if wedding.marie or wedding.mariee %}
													{{ wedding.marie ? wedding.marie.fullName : 'Marié' }} &amp; {{ wedding.mariee ? wedding.mariee.fullName : 'Mariée' }}
												{% else %}
													Mariage
												{% endif %}
											</strong>
										</p>
										{% if wedding.date %}
											<p class="mb-1">
												{{ wedding.date|date('d/m/Y') }}
												{% if wedding.time %}
													à {{ wedding.time|date('H') }}h{{ wedding.time|date('i') }}
												{% endif %}
											</p>
										{% endif %}
										{% if wedding.church %}
											<p class="mb-0">{{ wedding.church }}{% if wedding.parish %} - {{ wedding.parish }}{% endif %}</p>
										{% endif %}
									</div>
								</div>
								<div class="deroule-header d-none d-lg-flex">
									<div class="deroule-col-type">TYPE</div>
									<div class="deroule-col-choice">CHOIX RETENU</div>
									<div class="deroule-col-check">VALIDATION MUSICIEN</div>
									<div class="deroule-col-check">VALIDATION PAROISSE</div>
									<div class="deroule-col-comments">COM.</div>
								</div>

								<div class="deroule-groups">
									{% for label in orderedLabels %}
										{% set group = groups[label] %}
										<div class="deroule-group">
											<div class="deroule-group-header"{% if group.color %} style="border-left: 4px solid {{ group.color }}"{% endif %}>{{ group.label }}</div>
											<div class="deroule-group-body">
												{% for type in group.types %}
													{% set selection = selectionMap['id_' ~ type.id]|default(null) %}
													{% set selectedSong = selection ? selection.song : null %}
													{% set validatedMusician = selection ? selection.validatedByMusician : false %}
													{% set validatedParish = selection ? selection.validatedByParish : false %}
													{% set selectionState = songSelectionsByType[type.id]|default({}) %}
													<div class="deroule-row">
														<div>
															<span class="deroule-type-badge">{{ type.name }}</span>
														</div>
														<div>
															<span class="deroule-label">Votre choix</span>
															{% if selectedSong %}
																<div class="fw-semibold">{{ selectedSong.name ?? 'Titre inconnu' }}</div>
																{% if selectedSong.textRef %}
																	<div class="text-muted small">{{ selectedSong.textRef }}</div>
																{% endif %}
															{% else %}
																<div class="text-muted">Aucun chant sélectionné</div>
															{% endif %}
														</div>
														<div class="text-center">
															<span class="btn btn-validation {{ validatedMusician ? 'is-active' : '' }} disabled" role="presentation">MUS</span>
														</div>
														<div class="text-center">
															<span class="btn btn-validation {{ validatedParish ? 'is-active' : '' }} disabled" role="presentation">PAR</span>
														</div>
														<div>
															{% set commentsCount = selectionState.commentsCount|default(commentCountsByType[type.id]|default(0)) %}
															<div class="d-flex align-items-center gap-2">
																<button type="button" class="btn btn-sm btn-outline-secondary open-comments" data-wedding="{{ wedding.id }}" data-songtype="{{ type.id }}" aria-haspopup="dialog" aria-controls="commentsModal">
																	<i class="bi bi-chat-dots"></i>
																</button>
																{% if commentsCount > 0 %}
																	<span class="badge rounded-pill text-bg-secondary" aria-label="{{ commentsCount }} commentaire{{ commentsCount > 1 ? 's' : '' }}">
																		{{ commentsCount }}
																	</span>
																{% endif %}
															</div>
														</div>
													</div>
												{% endfor %}
											</div>
										</div>
									{% endfor %}
								</div>
							{% endif %}
						</div>
					</div>

					{% if not isCouple %}
				</div>

				<div class="wizard-actions">
					<div class="wizard-actions__nav">
						<button type="button" class="btn btn-outline-secondary wizard-prev d-none" data-action="prev-step">
							<i class="bi bi-arrow-left"></i>
							Retour
						</button>
						<button type="button" class="btn btn-primary wizard-next" data-action="next-step">
							Continuer
							<i class="bi bi-arrow-right ms-2"></i>
						</button>
					</div>
					<a href="{{ path('app_wedding_edit', {'id': wedding.id}) }}" class="btn btn-cta btn-rounded btn-icon js-edit-wedding-btn">
						<i class="bi bi-pencil-square"></i>
						Modifier
					</a>
				</div>
			</section>
		</div>
	</div>

	<div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Commentaires</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body">
					<div class="text-center py-4" id="commentsModalSpinner">
						<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Chargement...</span></div>
					</div>
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="inviteModalLabel">Inviter quelqu'un</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<form action="{{ path('app_wedding_invite', {'id': wedding.id}) }}" method="POST">
					<div class="modal-body">
						<div class="mb-3">
							<label for="email" class="form-label">Email</label>
							<input type="email" class="form-control" id="email" name="email" required>
						</div>
						<div class="mb-3">
							<label for="role" class="form-label">Rôle</label>
							<select class="form-select" id="role" name="role" required>
								<option value="paroisse">Paroisse</option>
								<option value="musicien">Musicien</option>
								<option value="marie">Marié</option>
								<option value="mariee">Mariée</option>
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						<button type="submit" class="btn btn-primary">Envoyer l'invitation</button>
					</div>
				</form>
			</div>
		</div>
	</div>
{% endblock %}
											</p>
										{% endif %}
										{% if wedding.church %}
											<p class="mb-0">{{ wedding.church }}{% if wedding.parish %} - {{ wedding.parish }}{% endif %}</p>
										{% endif %}
									</div>
								</div>
								<div class="deroule-header d-none d-lg-flex">
									<div class="deroule-col-type">TYPE</div>
									<div class="deroule-col-choice">CHOIX RETENU</div>
									<div class="deroule-col-check">VALIDATION MUSICIEN</div>
									<div class="deroule-col-check">VALIDATION PAROISSE</div>
									<div class="deroule-col-comments">COM.</div>
								</div>

								<div class="deroule-groups">
									{% for label in order %}
										{% if groups[label] is defined %}
											<div class="deroule-group">
												<div class="deroule-group-header">{{ label }}</div>
												<div class="deroule-group-body">
													{% for type in groups[label] %}
														{% set selection = selectionMap['id_' ~ type.id]|default(null) %}
														{% if selection %}
															{% set selectedSong = selection.song %}
															{% set validatedMusician = selection.validatedByMusician %}
															{% set validatedParish = selection.validatedByParish %}
														{% else %}
															{% set selectedSong = null %}
															{% set validatedMusician = false %}
															{% set validatedParish = false %}
														{% endif %}
														{% set selectionState = songSelectionsByType[type.id]|default({}) %}
														<div class="deroule-row">
															<div>
																<span class="deroule-type-badge">{{ type.name }}</span>
															</div>
															<div>
																<span class="deroule-label">Votre choix</span>
																{% if selectedSong %}
																	<div class="fw-semibold">{{ selectedSong.name ?? 'Titre inconnu' }}</div>
																	{% if selectedSong.textRef %}
																		<div class="text-muted small">{{ selectedSong.textRef }}</div>
																	{% endif %}
																{% else %}
																	<div class="text-muted">Aucun chant sélectionné</div>
																{% endif %}
															</div>
															<div class="text-center">
																<span class="btn btn-validation {{ validatedMusician ? 'is-active' : '' }} disabled" role="presentation">MUS</span>
															</div>
															<div class="text-center">
																<span class="btn btn-validation {{ validatedParish ? 'is-active' : '' }} disabled" role="presentation">PAR</span>
															</div>
															<div>
								
							                                                            {% set commentsCount = selectionState.commentsCount|default(commentCountsByType[type.id]|default(0)) %}
                                                            <div class="d-flex align-items-center gap-2">
                                                                <button type="button" class="btn btn-sm btn-outline-secondary open-comments" data-wedding="{{ wedding.id }}" data-songtype="{{ type.id }}" aria-haspopup="dialog" aria-controls="commentsModal">
                                                                    <i class="bi bi-chat-dots"></i>
                                                                </button>
                                                                {% if commentsCount > 0 %}
                                                                    <span class="badge rounded-pill text-bg-secondary" aria-label="{{ commentsCount }} commentaire{{ commentsCount > 1 ? 's' : '' }}">
                                                                        {{ commentsCount }}
                                                                    </span>
                                                                {% endif %}
                                                            </div>
                                                        
															</div>
														</div>
													{% endfor %}
												</div>
											</div>
										{% endif %}
									{% endfor %}
								</div>
							{% endif %}
						</div>
					</div>
					
					{% if not isCouple %}
					<div class="wizard-step" data-step="4">
						<div class="form-grid">
							<div class="form-card">
								<div class="form-card__title">
									<span>Finances</span>
									<h3 class="mb-0">Suivi des montants</h3>
								</div>
								{% set paymentStatus = {
									'label': 'Statut non défini',
									'badge': 'secondary'
								} %}
								{% if wedding.isPaid %}
									{% set paymentStatus = {
										'label': 'Mariage réglé',
										'badge': 'success'
									} %}
								{% else %}
									{% if wedding.paymentOption == 'delegated' %}
										{% set paymentStatus = {
											'label': 'En attente du paiement des mariés',
											'badge': 'warning'
										} %}
									{% elseif wedding.paymentOption == 'card_pending_partner' %}
										{% set paymentStatus = {
											'label': 'Paiement partenaire en cours',
											'badge': 'warning'
										} %}
									{% elseif wedding.paymentOption == 'card_partner' %}
										{% set paymentStatus = {
											'label': 'Paiement CB partenaire confirmé',
											'badge': 'success'
										} %}
									{% elseif wedding.paymentOption == 'card_user' %}
										{% set paymentStatus = {
											'label': 'Paiement en ligne à finaliser',
											'badge': 'info'
										} %}
									{% elseif wedding.paymentOption == 'credit' %}
										{% set paymentStatus = {
											'label': 'Réglé via crédits',
											'badge': 'success'
										} %}
									{% endif %}
								{% endif %}

								<div class="wizard-finance-grid">
									<div class="wizard-finance-item">
										<div class="wizard-finance-label">Montant de la prestation</div>
										<div class="wizard-finance-value">{{ wedding.montantTotal is not null ? (wedding.montantTotal ~ ' €') : '-' }}</div>
									</div>
									<div class="wizard-finance-item">
										<div class="wizard-finance-label">Montant déjà versé</div>
										<div class="wizard-finance-value">{{ wedding.montantPaye is not null ? (wedding.montantPaye ~ ' €') : '-' }}</div>
									</div>
									<div class="wizard-finance-item">
										<div class="wizard-finance-label">Statut du paiement</div>
										<div class="wizard-finance-value">
											<span class="badge text-bg-{{ paymentStatus.badge }}">{{ paymentStatus.label }}</span>
										</div>
									</div>
									<div class="wizard-finance-item">
										<div class="wizard-finance-label">Acompte</div>
										<div class="wizard-finance-value">
											{% if wedding.montantTotal and wedding.montantPaye is not null and wedding.montantTotal > 0 %}
												{{ ((wedding.montantPaye / wedding.montantTotal) * 100)|round(0) }} %
											{% else %}
												-
											{% endif %}
										</div>
									</div>
									<div class="wizard-finance-item">
										<div class="wizard-finance-label">Reste dû</div>
										<div class="wizard-finance-value">
											{% if wedding.montantTotal is not null and wedding.montantPaye is not null %}
												{{ (wedding.montantTotal - wedding.montantPaye)|number_format(2, '.', ' ') }} €
											{% else %}
												-
											{% endif %}
										</div>
									</div>
								</div>

								<div class="wizard-finance-inputs">
									<div class="wizard-finance-field">
										<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Créé avec un crédit ?</span>
										<div class="fw-semibold">{{ wedding.createdWithCredit ? 'Oui' : 'Non' }}</div>
									</div>
									<div class="wizard-finance-field">
										<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Paiement exigé des mariés ?</span>
										<div class="fw-semibold">{{ wedding.requiresCouplePayment ? 'Oui' : 'Non' }}</div>
									</div>
								</div>
							</div>

							<div class="form-card">
								<div class="form-card__title">
									<span>Clôture</span>
									<h3 class="mb-0">Archive &amp; options</h3>
								</div>
								<div class="mb-3">
									<span class="form-label-sm text-uppercase text-muted fw-semibold d-block mb-2">Statut du dossier</span>
									<div class="d-flex flex-wrap gap-2">
										<span class="btn btn-validation {{ not wedding.archive ? 'is-active' : '' }} disabled" role="presentation">Actif</span>
										<span class="btn btn-validation {{ wedding.archive ? 'is-active' : '' }} disabled" role="presentation">Archivé</span>
									</div>
								</div>
								<p class="mb-0 small text-muted">Archivez un mariage une fois la célébration passée pour conserver un historique propre.</p>
							</div>
						</div>
					</div>
					{% endif %}
				</div>

				<div class="wizard-actions">
					<div class="wizard-actions__nav">
						<button type="button" class="btn btn-outline-secondary wizard-prev d-none" data-action="prev-step">
							<i class="bi bi-arrow-left"></i>
							Retour
						</button>
						<button type="button" class="btn btn-primary wizard-next" data-action="next-step">
							Continuer
							<i class="bi bi-arrow-right ms-2"></i>
						</button>
					</div>
					<a href="{{ path('app_wedding_edit', {'id': wedding.id}) }}" class="btn btn-cta btn-rounded btn-icon js-edit-wedding-btn">
						<i class="bi bi-pencil-square"></i>
						Modifier
					</a>
				</div>
			</section>
		</div>
	</div>

	<div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Commentaires</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body">
					<div class="text-center py-4" id="commentsModalSpinner">
						<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Chargement...</span></div>
					</div>
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="inviteModalLabel">Inviter quelqu'un</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<form action="{{ path('app_wedding_invite', {'id': wedding.id}) }}" method="POST">
					<div class="modal-body">
						<div class="mb-3">
							<label for="email" class="form-label">Email</label>
							<input type="email" class="form-control" id="email" name="email" required>
						</div>
						<div class="mb-3">
							<label for="role" class="form-label">Rôle</label>
							<select class="form-select" id="role" name="role" required>
								<option value="paroisse">Paroisse</option>
								<option value="musicien">Musicien</option>
								<option value="marie">Marié</option>
								<option value="mariee">Mariée</option>
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						<button type="submit" class="btn btn-primary">Envoyer l'invitation</button>
					</div>
				</form>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			console.log('=== DEBUT SCRIPT VIEW ===');
			const wizardLayout = document.getElementById('weddingWizardView');
			console.log('wizardLayout:', wizardLayout);
			const steps = Array.from(document.querySelectorAll('.wizard-step'));
			console.log('Steps trouvés:', steps.length);
			const stepperItems = Array.from(document.querySelectorAll('.wizard-stepper__item'));
			console.log('Stepper items:', stepperItems.length);
			const prevBtn = document.querySelector('.wizard-prev');
			const nextBtn = document.querySelector('.wizard-next');
			
			// Initialiser avec le step passé en paramètre URL
			let currentStep = {{ initialStep|default(0) }};
			console.log('Step initial depuis le serveur:', currentStep);

			if (wizardLayout) {
				const defaultStep = parseInt(wizardLayout.dataset.defaultStep || '0', 10);
				if (!Number.isNaN(defaultStep)) {
					currentStep = Math.max(0, Math.min(steps.length - 1, defaultStep));
				}
			}

			function syncUI() {
				console.log('syncUI appelé, currentStep =', currentStep);
				steps.forEach((step, index) => step.classList.toggle('active', index === currentStep));
				stepperItems.forEach((item, index) => item.classList.toggle('active', index === currentStep));
				if (prevBtn) {
					prevBtn.classList.toggle('d-none', currentStep === 0);
				}
				if (nextBtn) {
					nextBtn.classList.toggle('d-none', currentStep >= steps.length - 1);
				}
			}

			if (prevBtn) {
				prevBtn.addEventListener('click', function () {
					if (currentStep > 0) {
						currentStep -= 1;
						syncUI();
					}
				});
			}

			if (nextBtn) {
				nextBtn.addEventListener('click', function () {
					if (currentStep < steps.length - 1) {
						currentStep += 1;
						syncUI();
					}
				});
			}

			stepperItems.forEach((item) => {
				item.addEventListener('click', function () {
					const target = parseInt(item.dataset.step, 10);
					console.log('Clic sur stepper item, étape:', target);
					if (!Number.isNaN(target)) {
						currentStep = target;
						syncUI();
					}
				});
			});

			console.log('Appel initial de syncUI');
			syncUI();

			// Intercepter le clic sur les boutons "Modifier" pour ajouter l'étape actuelle
			const editButtons = document.querySelectorAll('.js-edit-wedding-btn');
			console.log('=== RECHERCHE BOUTONS MODIFIER ===');
			console.log('Boutons Modifier trouvés:', editButtons.length);
			console.log('currentStep actuel:', currentStep);
			
			if (editButtons.length > 0) {
				console.log('Installation des listeners sur', editButtons.length, 'bouton(s) Modifier');
				editButtons.forEach((editButton, index) => {
					console.log('Bouton', index + 1, '- Href actuel:', editButton.href);
					editButton.addEventListener('click', function(e) {
						e.preventDefault();
						e.stopPropagation();
						const baseUrl = '{{ path('app_wedding_edit', {'id': wedding.id}) }}';
						const finalUrl = baseUrl + '?step=' + currentStep;
						console.log('!!! CLIC DETECTE sur bouton', index + 1, '!!! Redirection vers:', finalUrl, 'currentStep=', currentStep);
						window.location.href = finalUrl;
						return false;
					}, true);
				});
			} else {
				console.error('ERREUR: Aucun bouton Modifier trouvé !');
			}

			// Gestion du bouton d'impression
			const printBtn = document.getElementById('printDerouleBtn');
			if (printBtn) {
				printBtn.addEventListener('click', function() {
					// S'assurer d'être sur l'étape du répertoire avant d'imprimer
					if (currentStep !== 3) {
						currentStep = 3;
						syncUI();
					}
					
					// Attendre un court instant pour que l'affichage se mette à jour
					setTimeout(() => {
						window.print();
					}, 100);
				});
			}

			const modalEl = document.getElementById('commentsModal');
			if (modalEl && typeof bootstrap !== 'undefined') {
				const bsModal = new bootstrap.Modal(modalEl);
				const bindCommentForm = (formEl, url) => {
					if (!formEl) {
						return;
					}

					formEl.addEventListener('submit', async function (evt) {
						evt.preventDefault();
						const fd = new FormData(formEl);
						const action = formEl.getAttribute('action') || url;
						const method = (formEl.getAttribute('method') || 'POST').toUpperCase();

						try {
							const response = await fetch(action, {
								method: method,
								body: fd,
								headers: { 'X-Requested-With': 'XMLHttpRequest' },
							});
							if (!response.ok) {
								throw new Error('Requête invalide');
							}

							const refreshed = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
							const refreshedText = await refreshed.text();
							const refreshedDoc = new DOMParser().parseFromString(refreshedText, 'text/html');
							const newComments = refreshedDoc.querySelector('#comments-box');
							const newForm = refreshedDoc.querySelector('.card-footer form') || refreshedDoc.querySelector('form');

							modalEl.querySelector('.modal-body').querySelector('h2')?.remove();
							if (newComments) {
								const body = modalEl.querySelector('.modal-body');
								const old = body.querySelector('#comments-box');
								if (old) {
									old.replaceWith(newComments.cloneNode(true));
								} else {
									body.appendChild(newComments.cloneNode(true));
								}
							}

							const footer = modalEl.querySelector('.modal-footer');
							if (newForm) {
								footer.innerHTML = '';
								const clonedForm = newForm.cloneNode(true);
								footer.appendChild(clonedForm);
								bindCommentForm(clonedForm, url);
							}
						} catch (err) {
							console.error(err);
							alert('Erreur lors de l\'envoi du commentaire.');
						}
					}, { once: true });
				};
				document.querySelectorAll('.open-comments').forEach((btn) => {
					btn.addEventListener('click', async function () {
						const weddingId = this.dataset.wedding;
						const songTypeId = this.dataset.songtype;
						const url = `/comments/${weddingId}/${songTypeId}`;

						const body = modalEl.querySelector('.modal-body');
						const footer = modalEl.querySelector('.modal-footer');
						body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Chargement...</span></div></div>';
						footer.innerHTML = '';
						bsModal.show();

						try {
							const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
							const text = await res.text();
							const parser = new DOMParser();
							const doc = parser.parseFromString(text, 'text/html');

							const header = doc.querySelector('h2');
							const commentsBox = doc.querySelector('#comments-box');
							const form = doc.querySelector('.card-footer form') || doc.querySelector('form');

							body.innerHTML = '';
							if (header) {
								body.appendChild(header.cloneNode(true));
							}
							if (commentsBox) {
								body.appendChild(commentsBox.cloneNode(true));
							} else {
								body.innerHTML += '<p class="text-muted">Aucun commentaire.</p>';
							}

							footer.innerHTML = '';
							if (form) {
								const injectedForm = form.cloneNode(true);
								footer.appendChild(injectedForm);
								bindCommentForm(injectedForm, url);
							} else {
								footer.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
							}
						} catch (err) {
							console.error(err);
							modalEl.querySelector('.modal-body').innerHTML = '<p class="text-danger">Impossible de charger les commentaires.</p>';
							modalEl.querySelector('.modal-footer').innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>';
						}
					});
				});
			}
		});
	</script>
{% endblock %}
