{% extends 'base.html.twig' %}

{% block title %}Connexion{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .auth-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: clamp(2rem, 4vw, 3rem);
            align-items: stretch;
            justify-content: center;
            padding: clamp(1.5rem, 4vw, 3rem) 0;
        }

        .auth-panel {
            background: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 18px 40px rgba(101, 45, 144, 0.12);
            padding: clamp(1.75rem, 3vw, 2.75rem);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-sidecard {
            background: linear-gradient(135deg, rgba(101, 45, 144, 0.92), rgba(255, 129, 0, 0.9));
            border-radius: 1.5rem;
            color: #fff;
            padding: clamp(1.75rem, 3vw, 2.75rem);
            position: relative;
            overflow: hidden;
        }

        .auth-sidecard::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('/images/login_screens/loginbanner1.png');
            background-size: cover;
            background-position: center;
            mix-blend-mode: soft-light;
            opacity: 0.4;
        }

        .auth-sidecard__content {
            position: relative;
            z-index: 2;
        }

        .auth-badge {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .5rem 1rem;
            background: rgba(255, 255, 255, 0.18);
            border-radius: 999px;
            font-size: .85rem;
            letter-spacing: .05em;
            text-transform: uppercase;
        }

        .auth-form-title {
            font-family: 'Alfarn', serif;
            font-size: clamp(1.4rem, 3vw, 1.75rem);
            color: var(--color-secondary);
        }

        .form-floating > label {
            color: var(--color-last);
        }

        .form-floating > .form-control {
            border-radius: .85rem;
            border: 1px solid rgba(101, 45, 144, 0.2);
            padding-left: 1.25rem;
        }

        .form-floating > .form-control:focus {
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 .25rem rgba(101, 45, 144, .15);
        }

        .auth-links {
            display: flex;
            flex-direction: column;
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .auth-meta {
            font-size: .925rem;
            color: rgba(97, 97, 111, .85);
        }

        .auth-steps {
            margin-top: clamp(1.75rem, 3vw, 2.5rem);
            display: grid;
            gap: 1rem;
        }

        .auth-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .auth-step__icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.18);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .auth-insight {
            background: rgba(255, 255, 255, 0.14);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            font-size: .95rem;
            margin-top: 1.75rem;
        }

        /* Animations pour les transitions fluides */
        .fade-slide-enter {
            animation: fadeSlideIn 0.4s ease-out forwards;
        }

        .fade-slide-exit {
            animation: fadeSlideOut 0.3s ease-in forwards;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .email-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(101, 45, 144, 0.08);
            border-radius: 0.5rem;
            color: var(--color-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .btn-change-email {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(101, 45, 144, 0.2);
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: var(--color-secondary);
            width: 24px;
            border-radius: 4px;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 991.98px) {
            .auth-wrapper {
                margin-top: 1rem;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="auth-wrapper">
        <section class="auth-panel">
            <div class="auth-header d-flex flex-column gap-2 mb-4">
                <span class="auth-badge"><i class="bi bi-shield-lock"></i> Espace sécurisé</span>
                <h2 class="auth-form-title">Connexion</h2>
                <p class="auth-meta mb-0">
                    Accédez à votre espace pour suivre votre mariage, gérer vos invitations ou enrichir votre répertoire.
                </p>
                {% if app.session.get('invitation_token') %}
                    <div class="alert alert-warning mt-2 mb-0">
                        <i class="bi bi-envelope-open me-2"></i>
                        Une invitation vous attend &ndash; connectez-vous pour la finaliser.
                    </div>
                {% endif %}
            </div>

            {% if error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ error.messageKey|trans(error.messageData, 'security') }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                </div>
            {% endif %}

            {% if app.user %}
                <div class="alert alert-success d-flex align-items-center gap-2" role="alert">
                    <i class="bi bi-emoji-smile"></i>
                    <span>Connecté en tant que <strong>{{ app.user.userIdentifier }}</strong>. <a class="ms-1" href="{{ path('app_logout') }}">Se déconnecter ?</a></span>
                </div>
            {% endif %}

            <!-- Indicateur d'étapes -->
            <div class="step-indicator">
                <div class="step-dot active" id="step-dot-1"></div>
                <div class="step-dot" id="step-dot-2"></div>
            </div>

            <!-- ÉTAPE 1 : Email uniquement -->
            <div id="step-email">
                <form id="email-form" class="d-flex flex-column gap-3">
                    <div class="form-floating">
                        <input type="email" value="{{ last_username }}" name="email" id="email-input" 
                               class="form-control" placeholder="Email" autocomplete="email" required autofocus>
                        <label for="email-input">Adresse e-mail</label>
                    </div>

                    <button class="btn btn-primary btn-lg w-100" type="submit" id="continue-btn">
                        <span id="continue-text">
                            <i class="bi bi-arrow-right me-2"></i>Continuer
                        </span>
                        <span id="continue-loading" class="d-none">
                            <span class="loading-spinner me-2"></span>Vérification...
                        </span>
                    </button>
                </form>
            </div>

            <!-- ÉTAPE 2 : Mot de passe (cachée par défaut) -->
            <div id="step-password" class="d-none">
                <div class="mb-3">
                    <div class="email-display">
                        <i class="bi bi-envelope-check"></i>
                        <span id="email-display-text"></span>
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-change-email ms-2" id="change-email-btn">
                            <i class="bi bi-pencil"></i> Modifier
                        </button>
                    </div>
                </div>

                <form method="post" id="password-form" class="d-flex flex-column gap-3">
                    <input type="hidden" name="_username" id="username-hidden">
                    
                    <div class="form-floating position-relative">
                        <input type="password" name="_password" id="password" class="form-control" 
                               placeholder="Mot de passe" autocomplete="current-password" required>
                        <label for="password">Mot de passe</label>
                        <button class="btn btn-link text-decoration-none toggle-password" type="button" data-target="password">
                            <i class="bi bi-eye"></i>
                            <span class="visually-hidden">Afficher le mot de passe</span>
                        </button>
                    </div>

                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">

                    <button class="btn btn-primary btn-lg w-100" type="submit">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Se connecter
                    </button>

                    <a class="link-secondary text-center" href="{{ path('app_forgot_password') }}">
                        <i class="bi bi-question-circle me-1"></i>Mot de passe oublié ?
                    </a>
                </form>
            </div>

            <p class="auth-meta mt-4 mb-0 text-center">&copy; {{ "now"|date('Y') }} Notre Messe de Mariage</p>
        </section>

        <aside class="auth-sidecard">
            <div class="auth-sidecard__content">
                <span class="auth-badge mb-3"><i class="bi bi-stars"></i>Le parcours en 3 étapes</span>
                <div class="auth-steps">
                    <div class="auth-step">
                        <span class="auth-step__icon"><i class="bi bi-person-plus"></i></span>
                        <div>
                            <h5 class="mb-1">1. Créez votre espace</h5>
                            <p class="mb-0 small">Inscrivez-vous en tant que couple, musicien ou paroisse. Les invitations reçues sont reconnues automatiquement.</p>
                        </div>
                    </div>
                    <div class="auth-step">
                        <span class="auth-step__icon"><i class="bi bi-envelope-heart"></i></span>
                        <div>
                            <h5 class="mb-1">2. Invitez vos partenaires</h5>
                            <p class="mb-0 small">Partagez des accès sécurisés, suivez l'usage des crédits et pilotez les validations de chants.</p>
                        </div>
                    </div>
                    <div class="auth-step">
                        <span class="auth-step__icon"><i class="bi bi-music-note-beamed"></i></span>
                        <div>
                            <h5 class="mb-1">3. Co-construisez la célébration</h5>
                            <p class="mb-0 small">Centralisez déroulé, répertoire et logistique afin d'arriver sereins le jour J.</p>
                        </div>
                    </div>
                </div>

                        });
    </script>
{% endblock %}


{% block javascripts %}
    {{ parent() }}
    <script>
        // Gestion du toggle password
        document.querySelectorAll('.toggle-password').forEach(function (button) {
            button.addEventListener('click', function () {
                var targetId = button.getAttribute('data-target');
                var input = document.getElementById(targetId);
                if (!input) {
                    return;
                }
                var isPassword = input.getAttribute('type') === 'password';
                input.setAttribute('type', isPassword ? 'text' : 'password');
                button.querySelector('i').classList.toggle('bi-eye');
                button.querySelector('i').classList.toggle('bi-eye-slash');
            });
        });

        // Gestion du formulaire en deux étapes
        const emailForm = document.getElementById('email-form');
        const emailInput = document.getElementById('email-input');
        const stepEmail = document.getElementById('step-email');
        const stepPassword = document.getElementById('step-password');
        const continueBtn = document.getElementById('continue-btn');
        const continueText = document.getElementById('continue-text');
        const continueLoading = document.getElementById('continue-loading');
        const emailDisplayText = document.getElementById('email-display-text');
        const usernameHidden = document.getElementById('username-hidden');
        const changeEmailBtn = document.getElementById('change-email-btn');
        const stepDot1 = document.getElementById('step-dot-1');
        const stepDot2 = document.getElementById('step-dot-2');

        emailForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            
            if (!email) {
                return;
            }

            // Afficher le loading
            continueBtn.disabled = true;
            continueText.classList.add('d-none');
            continueLoading.classList.remove('d-none');

            try {
                // Vérifier si l'email existe
                const response = await fetch('{{ path('api_check_email') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });

                if (!response.ok) {
                    throw new Error('Erreur serveur: ' + response.status);
                }

                const data = await response.json();

                if (data.exists) {
                    // L'utilisateur existe, passer à l'étape 2
                    showPasswordStep(email);
                } else {
                    // L'utilisateur n'existe pas, rediriger vers l'inscription
                    window.location.href = '{{ path('app_register') }}?email=' + encodeURIComponent(email);
                }
            } catch (error) {
                console.error('Erreur détaillée:', error);
                alert('Une erreur est survenue: ' + error.message);
                
                // Restaurer le bouton
                continueBtn.disabled = false;
                continueText.classList.remove('d-none');
                continueLoading.classList.add('d-none');
            }
        });

        function showPasswordStep(email) {
            // Animer la sortie de l'étape email
            stepEmail.classList.add('fade-slide-exit');
            
            setTimeout(() => {
                stepEmail.classList.add('d-none');
                stepEmail.classList.remove('fade-slide-exit');
                
                // Mettre à jour l'affichage de l'email
                emailDisplayText.textContent = email;
                usernameHidden.value = email;
                
                // Afficher l'étape password avec animation
                stepPassword.classList.remove('d-none');
                stepPassword.classList.add('fade-slide-enter');
                
                // Mettre à jour les indicateurs d'étapes
                stepDot1.classList.remove('active');
                stepDot2.classList.add('active');
                
                // Focus sur le champ password
                setTimeout(() => {
                    document.getElementById('password').focus();
                }, 100);
            }, 300);
        }

        // Bouton pour revenir à l'étape email
        changeEmailBtn.addEventListener('click', function() {
            stepPassword.classList.add('fade-slide-exit');
            
            setTimeout(() => {
                stepPassword.classList.add('d-none');
                stepPassword.classList.remove('fade-slide-exit', 'fade-slide-enter');
                
                // Réafficher l'étape email
                stepEmail.classList.remove('d-none');
                stepEmail.classList.add('fade-slide-enter');
                
                // Mettre à jour les indicateurs d'étapes
                stepDot1.classList.add('active');
                stepDot2.classList.remove('active');
                
                // Restaurer le bouton continuer
                continueBtn.disabled = false;
                continueText.classList.remove('d-none');
                continueLoading.classList.add('d-none');
                
                // Focus sur l'email
                setTimeout(() => {
                    emailInput.focus();
                    emailInput.select();
                }, 100);
            }, 300);
        });
    </script>
{% endblock %}