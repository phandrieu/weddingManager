{% extends 'base.html.twig' %}

{% block title %}Connexion{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .auth-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: clamp(2rem, 4vw, 3rem);
            align-items: stretch;
            justify-content: center;
            padding: clamp(1.5rem, 4vw, 3rem) 0;
        }

        .auth-panel {
            background: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 18px 40px rgba(101, 45, 144, 0.12);
            padding: clamp(1.75rem, 3vw, 2.75rem);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-sidecard {
            background: linear-gradient(135deg, rgba(101, 45, 144, 0.92), rgba(255, 129, 0, 0.9));
            border-radius: 1.5rem;
            color: #fff;
            padding: clamp(1.75rem, 3vw, 2.75rem);
            position: relative;
            overflow: hidden;
        }

        .auth-sidecard::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('{{ asset('images/login_screens/loginbanner1.png') }}');
            background-size: cover;
            background-position: center;
            mix-blend-mode: soft-light;
            opacity: 0.4;
        }

        .auth-sidecard__content {
            position: relative;
            z-index: 2;
        }

        .auth-badge {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .5rem 1rem;
            background: rgba(255, 255, 255, 0.18);
            border-radius: 999px;
            font-size: .85rem;
            letter-spacing: .05em;
            text-transform: uppercase;
        }

        .auth-form-title {
            font-family: 'Alfarn', serif;
            font-size: clamp(1.4rem, 3vw, 1.75rem);
            color: var(--color-secondary);
        }

        .form-floating > label {
            color: var(--color-last);
        }

        .form-floating > .form-control {
            border-radius: .85rem;
            border: 1px solid rgba(101, 45, 144, 0.2);
            padding-left: 1.25rem;
        }

        .form-floating > .form-control:focus {
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 .25rem rgba(101, 45, 144, .15);
        }

        .auth-links {
            display: flex;
            flex-direction: column;
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .auth-meta {
            font-size: .925rem;
            color: rgba(97, 97, 111, .85);
        }

        .auth-steps {
            margin-top: clamp(1.75rem, 3vw, 2.5rem);
            display: grid;
            gap: 1rem;
        }

        .auth-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .auth-step__icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.18);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .auth-insight {
            background: rgba(255, 255, 255, 0.14);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            font-size: .95rem;
            margin-top: 1.75rem;
        }

        @media (max-width: 991.98px) {
            .auth-wrapper {
                margin-top: 1rem;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="auth-wrapper">
        <section class="auth-panel">
            <div class="auth-header d-flex flex-column gap-2 mb-4">
                <span class="auth-badge"><i class="bi bi-shield-lock"></i> Espace sécurisé</span>
                <h2 class="auth-form-title">Connexion</h2>
                <p class="auth-meta mb-0">
                    Accédez à votre espace pour suivre votre mariage, gérer vos invitations ou enrichir votre répertoire.
                </p>
                {% if app.session.get('invitation_token') %}
                    <div class="alert alert-warning mt-2 mb-0">
                        <i class="bi bi-envelope-open me-2"></i>
                        Une invitation vous attend &ndash; connectez-vous pour la finaliser.
                    </div>
                {% endif %}
            </div>

            {% if error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ error.messageKey|trans(error.messageData, 'security') }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                </div>
            {% endif %}

            {% if app.user %}
                <div class="alert alert-success d-flex align-items-center gap-2" role="alert">
                    <i class="bi bi-emoji-smile"></i>
                    <span>Connecté en tant que <strong>{{ app.user.userIdentifier }}</strong>. <a class="ms-1" href="{{ path('app_logout') }}">Se déconnecter ?</a></span>
                </div>
            {% endif %}

            <form method="post" class="d-flex flex-column gap-3">
                <div class="form-floating">
                    <input type="email" value="{{ last_username }}" name="_username" id="username" class="form-control" placeholder="Email" autocomplete="email" required autofocus>
                    <label for="username">Adresse e-mail</label>
                </div>

                <div class="form-floating position-relative">
                    <input type="password" name="_password" id="password" class="form-control" placeholder="Mot de passe" autocomplete="current-password" required>
                    <label for="password">Mot de passe</label>
                    <button class="btn btn-link text-decoration-none toggle-password" type="button" data-target="password">
                        <i class="bi bi-eye"></i>
                        <span class="visually-hidden">Afficher le mot de passe</span>
                    </button>
                </div>

                <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">

                <button class="btn btn-primary btn-lg w-100" type="submit">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Se connecter
                </button>
            </form>

            <div class="auth-links">
                <a href="{{ path('app_register') }}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-heart-fill me-2"></i>Créer un compte
                </a>
                <div class="d-flex justify-content-between flex-wrap gap-2">
                    <a class="link-secondary" href="{{ path('app_forgot_password') }}">Mot de passe oublié ?</a>
                    <a class="link-secondary" href="{{ path('app_credits_buy') }}">Acheter des crédits</a>
                </div>
            </div>

            <p class="auth-meta mt-4 mb-0 text-center">&copy; {{ "now"|date('Y') }} Notre Messe de Mariage</p>
        </section>

        <aside class="auth-sidecard">
            <div class="auth-sidecard__content">
                <span class="auth-badge mb-3"><i class="bi bi-stars"></i>Le parcours en 3 étapes</span>
                <div class="auth-steps">
                    <div class="auth-step">
                        <span class="auth-step__icon"><i class="bi bi-person-plus"></i></span>
                        <div>
                            <h5 class="mb-1">1. Créez votre espace</h5>
                            <p class="mb-0 small">Inscrivez-vous en tant que couple, musicien ou paroisse. Les invitations reçues sont reconnues automatiquement.</p>
                        </div>
                    </div>
                    <div class="auth-step">
                        <span class="auth-step__icon"><i class="bi bi-envelope-heart"></i></span>
                        <div>
                            <h5 class="mb-1">2. Invitez vos partenaires</h5>
                            <p class="mb-0 small">Partagez des accès sécurisés, suivez l’usage des crédits et pilotez les validations de chants.</p>
                        </div>
                    </div>
                    <div class="auth-step">
                        <span class="auth-step__icon"><i class="bi bi-music-note-beamed"></i></span>
                        <div>
                            <h5 class="mb-1">3. Co-construisez la célébration</h5>
                            <p class="mb-0 small">Centralisez déroulé, répertoire et logistique afin d’arriver sereins le jour J.</p>
                        </div>
                    </div>
                </div>

                <div class="auth-insight">
                    {% if app.session.get('pending_invitation_token') %}
                        <i class="bi bi-hourglass-split me-2"></i>Un paiement d’invitation est en cours. Finalisez-le depuis vos notifications après connexion.
                    {% else %}
                        <i class="bi bi-lightbulb me-2"></i>Astuce : paroisses et musiciens peuvent débloquer l’accès aux couples grâce aux crédits achetés dans l’espace dédié.
                    {% endif %}
                </div>
            </div>
        </aside>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.querySelectorAll('.toggle-password').forEach(function (button) {
            button.addEventListener('click', function () {
                var targetId = button.getAttribute('data-target');
                var input = document.getElementById(targetId);
                if (!input) {
                    return;
                }
                var isPassword = input.getAttribute('type') === 'password';
                input.setAttribute('type', isPassword ? 'text' : 'password');
                button.querySelector('i').classList.toggle('bi-eye');
                button.querySelector('i').classList.toggle('bi-eye-slash');
            });
        });
    </script>
{% endblock %}