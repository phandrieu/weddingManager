{# templates/song/suggest.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Proposer un chant{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="card shadow p-4" style="max-width: 1200px; margin: auto;">
        <div class="modal-header border-0 pb-0">
            <h5 class="modal-title">Ajouter un nouvel élément</h5>
        </div>
        
        {{ form_start(form, {'attr': {'enctype': 'multipart/form-data', 'id': 'suggestion-form'}}) }}
        
        <div class="modal-body">
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i>
                Cette bibliothèque vit grâce aux apports de la communauté : musiciens, paroisses et futurs mariés.
                Chacun peut proposer ses versions de chants, partitions ou textes pour enrichir la préparation des célébrations.
            </div>

            <div class="row">
                <div class="col-lg-7">
                    <!-- Section principale -->
                    <section>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Type d'élément <span class="text-danger">*</span></label>
                            <div class="d-flex gap-4">
                                <div class="form-check">
                                    {% if form.song is defined %}
                                        {{ form_widget(form.song, {'attr': {'class': 'form-check-input suggestion-type-radio', 'id': 'suggestion-type-text', 'value': '0'}}) }}
                                    {% else %}
                                        <input class="form-check-input suggestion-type-radio" type="radio" name="suggestion-song-type" id="suggestion-type-text" value="0">
                                    {% endif %}
                                    <label class="form-check-label" for="suggestion-type-text">
                                        Lecture et Prière
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input suggestion-type-radio" type="radio" name="suggestion-song-type" id="suggestion-type-song" value="1" checked>
                                    <label class="form-check-label" for="suggestion-type-song">
                                        Chant
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form_label(form.name, 'Titre', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            <span class="text-danger">*</span>
                            {{ form_widget(form.name, {'attr': {'class': 'form-control form-control-lg', 'id': 'suggestion-name', 'placeholder': 'Écrire le titre ici'}}) }}
                            {{ form_errors(form.name) }}
                        </div>

                        {% if form.types is defined %}
                        <div class="mb-3">
                            {{ form_label(form.types, 'Catégorie(s)', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            {{ form_widget(form.types, {'attr': {'class': 'form-select', 'id': 'suggestion-types', 'data-placeholder': 'Rechercher et sélectionner'}}) }}
                            {{ form_errors(form.types) }}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            {{ form_label(form.lyrics, 'Paroles', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            {{ form_widget(form.lyrics, {'attr': {'class': 'form-control', 'id': 'suggestion-lyrics', 'rows': 12, 'placeholder': 'Écrire le texte ici (Mettre « R. » devant les refrains et « 1. » puis suites de nombres devant les couplets)'}}) }}
                            {{ form_errors(form.lyrics) }}
                        </div>
                    </section>
                </div>

                <div class="col-lg-5">
                    <!-- Sidebar -->
                    
                    <!-- Section spécifique aux chants -->
                    <section id="suggestion-song-specific">
                        {% if form.previewUrl is defined %}
                        <div class="mb-4">
                            <h6 class="fw-bold border-bottom pb-2">Prévisualisation</h6>
                            <div class="mb-3">
                                {{ form_label(form.previewUrl, 'URL de prévisualisation (lien Youtube)', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.previewUrl, {'attr': {'class': 'form-control', 'id': 'suggestion-preview-url', 'placeholder': 'Coller l\'URL Youtube ici'}}) }}
                                {{ form_errors(form.previewUrl) }}
                            </div>
                            <div id="suggestion-youtube-preview" class="d-none">
                                <div class="ratio ratio-16x9">
                                    <iframe id="suggestion-youtube-iframe" src="about:blank" title="Prévisualisation vidéo" allowfullscreen></iframe>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <h6 class="fw-bold border-bottom pb-2">Crédits</h6>
                            {% if form.musicAuthor is defined %}
                            <div class="mb-3">
                                {{ form_label(form.musicAuthor, 'Compositeur(s)', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.musicAuthor, {'attr': {'class': 'form-control', 'id': 'suggestion-music-author', 'placeholder': 'Écrire le(s) Nom(s) et Prénom(s) ici'}}) }}
                                {{ form_errors(form.musicAuthor) }}
                            </div>
                            {% endif %}
                            
                            {% if form.lyricsAuthor is defined %}
                            <div class="mb-3">
                                {{ form_label(form.lyricsAuthor, 'Écriture des paroles', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.lyricsAuthor, {'attr': {'class': 'form-control', 'id': 'suggestion-lyrics-author', 'placeholder': 'Écrire le(s) Nom(s) et Prénom(s)'}}) }}
                                {{ form_errors(form.lyricsAuthor) }}
                            </div>
                            {% endif %}
                            
                            {% if form.interpret is defined %}
                            <div class="mb-3">
                                {{ form_label(form.interpret, 'Interprète(s)', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.interpret, {'attr': {'class': 'form-control', 'id': 'suggestion-interpret', 'placeholder': 'Écrire le(s) Nom(s) et Prénom(s)'}}) }}
                                {{ form_errors(form.interpret) }}
                            </div>
                            {% endif %}
                            
                            {% if form.editor is defined %}
                            <div class="mb-3">
                                {{ form_label(form.editor, 'Éditeur(s)', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.editor, {'attr': {'class': 'form-control', 'id': 'suggestion-editor', 'placeholder': 'Écrire le(s) Nom(s) ou organisme'}}) }}
                                {{ form_errors(form.editor) }}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if form.partitionPDFFile is defined %}
                        <div class="mb-4">
                            <h6 class="fw-bold border-bottom pb-2">Partition</h6>
                            <div class="mb-3">
                                {{ form_label(form.partitionPDFFile, 'Partition PDF', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.partitionPDFFile, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.partitionPDFFile) }}
                            </div>
                        </div>
                        {% endif %}
                    </section>

                    <!-- Section spécifique aux textes -->
                    <section id="suggestion-text-specific" class="d-none">
                        <div class="mb-4">
                            <h6 class="fw-bold border-bottom pb-2">Informations sur le texte</h6>
                            {% if form.textReference is defined %}
                            <div class="mb-3">
                                {{ form_label(form.textReference, 'Référence du texte (ex : Jean 3:16)', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.textReference, {'attr': {'class': 'form-control', 'id': 'suggestion-text-ref', 'placeholder': 'Référence du texte'}}) }}
                                {{ form_errors(form.textReference) }}
                            </div>
                            {% endif %}
                            
                            {% if form.textTranslation is defined %}
                            <div class="mb-3">
                                {{ form_label(form.textTranslation, 'Nom de la traduction', {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.textTranslation, {'attr': {'class': 'form-control', 'id': 'suggestion-text-translation', 'placeholder': 'Nom de la traduction'}}) }}
                                {{ form_errors(form.textTranslation) }}
                            </div>
                            {% endif %}
                        </div>
                    </section>
                </div>
            </div>

            <div class="alert alert-secondary small mt-3 mb-0">
                <strong>Note légale :</strong> Ce site agit en tant qu'hébergeur (LCEN, 21 juin 2004). 
                Les publications restent sous la responsabilité de chaque contributeur.
            </div>
            
            {# Afficher les autres champs restants du formulaire #}
            {{ form_rest(form) }}
        </div>
        
        <div class="modal-footer border-0">
            <a href="{{ path('app_song_index') }}" class="btn btn-secondary">Annuler</a>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
        
        {{ form_end(form) }}
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const songSpecific = document.getElementById('suggestion-song-specific');
            const textSpecific = document.getElementById('suggestion-text-specific');
            const previewInput = document.getElementById('suggestion-preview-url');
            const previewWrapper = document.getElementById('suggestion-youtube-preview');
            const iframe = document.getElementById('suggestion-youtube-iframe');
            
            // Initialiser TomSelect pour le sélecteur de catégories
            const typesSelectElement = document.getElementById('suggestion-types');
            if (typesSelectElement && window.TomSelect) {
                new TomSelect(typesSelectElement, {
                    plugins: ['remove_button'],
                    persist: false,
                    maxItems: null,
                    closeAfterSelect: false
                });
            }

            // Basculer entre chant et texte
            document.querySelectorAll('.suggestion-type-radio').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isSong = this.value === '1';
                    if (songSpecific) songSpecific.classList.toggle('d-none', !isSong);
                    if (textSpecific) textSpecific.classList.toggle('d-none', isSong);
                });
            });

            // Gestion de la prévisualisation YouTube
            if (previewInput && previewWrapper && iframe) {
                previewInput.addEventListener('input', function() {
                    const url = this.value.trim();
                    const videoId = extractYouTubeVideoId(url);
                    if (videoId) {
                        iframe.src = `https://www.youtube.com/embed/${videoId}`;
                        previewWrapper.classList.remove('d-none');
                    } else {
                        iframe.src = 'about:blank';
                        previewWrapper.classList.add('d-none');
                    }
                });
            }

            function extractYouTubeVideoId(url) {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/,
                    /youtube\.com\/embed\/([^&\s]+)/
                ];
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match && match[1]) return match[1];
                }
                return null;
            }
        });
    </script>
{% endblock %}