{% extends 'base.html.twig' %}

{% block title %}Bibliothèque partagée{% endblock %}

{% block body %}

<header class="page-header">
    <h1>Bibliothèque partagée</h1>

    <div class="app-actions">
        {% if 'ROLE_ADMIN' in app.user.roles or 'ROLE_MUSICIAN' in app.user.roles %}
            <button type="button" class="btn btn-outline-secondary btn-rounded" data-bs-toggle="modal" data-bs-target="#suggestionsModal">
                <i class="bi bi-lightbulb"></i>
                Suggestions ({{ suggestions|length }})
            </button>

            <a href="{{ path('app_song_edit') }}" class="btn btn-primary btn-rounded btn-icon">
                <i class="bi bi-plus-lg"></i>
                <span>Ajouter</span>
            </a>
        {% elseif 'ROLE_USER' in app.user.roles %}
            <button type="button" class="btn btn-outline-secondary btn-rounded js-open-suggestion-modal">
                <i class="bi bi-lightbulb"></i>
                Suggérer un élément
            </button>
        {% endif %}
    </div>
</header>

<form method="get" class="wedding-filters mb-4" role="search">
    <div class="row g-3 align-items-center">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="search" name="q" value="{{ search }}" class="form-control" placeholder="Rechercher un chant ou texte...">
            </div>
        </div>
        <div class="col-md-3">
            <select name="kind" class="form-select">
                <option value="all" {{ kindFilter == 'all' ? 'selected' }}>Tous</option>
                <option value="chants" {{ kindFilter == 'chants' ? 'selected' }}>Chants uniquement</option>
                <option value="textes" {{ kindFilter == 'textes' ? 'selected' }}>Textes uniquement</option>
            </select>
        </div>
        <div class="col-md-2">
            <select name="type" class="form-select">
                <option value="">Tous les types</option>
                {% for typeName in allTypes %}
                    <option value="{{ typeName }}" {{ typeFilter == typeName ? 'selected' }}>{{ typeName }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">Appliquer</button>
            <a href="{{ path('app_song_index') }}" class="btn btn-outline-secondary flex-fill">Réinitialiser</a>
        </div>
    </div>
</form>

{% if songs is empty %}
    <div class="text-muted text-center py-5">
        <i class="bi bi-music-note-list" style="font-size: 3rem; opacity: 0.3;"></i>
        <p class="mt-3">Aucun chant ou texte ne correspond à vos critères.</p>
    </div>
{% else %}
    <div class="row g-3">
        {% for song in songs %}
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                <div class="app-card-light h-100" style="display: flex; flex-direction: column;">
                    {# En-tête de la carte #}
                    <div class="d-flex align-items-start justify-content-between mb-2">
                        <div class="flex-grow-1">
                            <div class="fw-bold mb-1">{{ song.name }}</div>
                            <div class="small text-muted">
                                {% if song.song %}
                                    <i class="bi bi-music-note"></i> Chant
                                {% else %}
                                    <i class="bi bi-book"></i> Texte
                                {% endif %}
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#creditsModal{{ song.id }}" title="Crédits">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>

                    {# Types #}
                    {% if song.types is not empty %}
                        <div class="mb-2">
                            {% for t in song.types %}
                                <span class="badge text-bg-secondary">{{ t.name }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {# Aperçu du contenu #}
                    <div class="flex-grow-1 mb-3">
                        {% if song.song and song.previewUrl %}
                            {% set youtubeId = song.previewUrl|replace({
                                'https://youtu.be/': '',
                                'https://www.youtube.com/watch?v=': '',
                                '&feature=youtu.be': '',
                                '&si=': ''
                            }) %}
                            <div class="ratio ratio-16x9" style="border-radius: 8px; overflow: hidden;">
                                <iframe src="https://www.youtube.com/embed/{{ youtubeId }}" title="{{ song.name }}" allowfullscreen></iframe>
                            </div>
                        {% elseif song.lyrics %}
                            <div class="small text-muted" style="max-height: 80px; overflow: hidden;">
                                {{ song.lyrics|slice(0, 150) }}{% if song.lyrics|length > 150 %}...{% endif %}
                            </div>
                        {% else %}
                            <div class="text-muted small text-center" style="opacity: 0.5;">
                                <i class="bi bi-file-earmark-text"></i><br>
                                Pas d'aperçu
                            </div>
                        {% endif %}
                    </div>

                    {# Actions #}
                    <div class="d-flex justify-content-center gap-2 pt-2 border-top">
                        <a href="{{ path('app_song_view', {'id': song.id}) }}" class="btn btn-sm btn-light" title="Voir">
                            <i class="bi bi-eye"></i>
                        </a>

                        {% if 'ROLE_ADMIN' in app.user.roles or 'ROLE_MUSICIAN' in app.user.roles %}
                            <a href="{{ path('app_song_edit', {'id': song.id}) }}" class="btn btn-sm btn-light" title="Modifier">
                                <i class="bi bi-pencil"></i>
                            </a>
                        {% endif %}

                        {% if 'ROLE_ADMIN' in app.user.roles %}
                            <form method="post" action="{{ path('app_song_delete', {'id': song.id}) }}" style="display:inline;" onsubmit="return confirm('Voulez-vous vraiment supprimer cet élément ?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ song.id) }}">
                                <button class="btn btn-sm btn-danger" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Modal crédits #}
            <div class="modal fade" id="creditsModal{{ song.id }}" tabindex="-1" aria-labelledby="creditsModalLabel{{ song.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="creditsModalLabel{{ song.id }}">Crédits — {{ song.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <div class="modal-body">
                            {% if song.song %}
                                <p><strong>Titre :</strong> {{ song.name }}</p>
                                <p><strong>Auteur des paroles :</strong> {{ song.lyricsAuthorName ?: '—' }}</p>
                                <p><strong>Auteur de la musique :</strong> {{ song.musicAuthorName ?: '—' }}</p>
                                <p><strong>Maison d'édition :</strong> {{ song.editorName ?: '—' }}</p>
                                <p><strong>Interprète :</strong> {{ song.interpretName ?: '—' }}</p>
                            {% else %}
                                <p><strong>Référence :</strong> {{ song.textRef ?: '—' }}</p>
                                <p><strong>Traduction :</strong> {{ song.textTranslationName ?: '—' }}</p>
                            {% endif %}
                            <hr>
                            <p class="small text-muted mb-1"><strong>Ajouté par :</strong> {{ song.addedBy ? song.addedBy.fullName : '—' }} {% if song.addedAt is not null %}({{ song.addedAt|date('d/m/Y H:i') }}){% endif %}</p>
                            <p class="small text-muted mb-0"><strong>Dernière modification :</strong> {{ song.lastEditBy ? song.lastEditBy.fullName : '—' }} {% if song.lastEditAt is not null %}({{ song.lastEditAt|date('d/m/Y H:i') }}){% endif %}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {# Pagination #}
    {% if pagination.pages > 1 %}
        {% set prevPage = pagination.page > 1 ? pagination.page - 1 : 1 %}
        {% set nextPage = pagination.page < pagination.pages ? pagination.page + 1 : pagination.pages %}
        <nav aria-label="Pagination de la bibliothèque" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item {{ pagination.page == 1 ? 'disabled' }}">
                    <a class="page-link" href="{{ pagination.page == 1 ? '#' : path('app_song_index', {page: prevPage, q: search, type: typeFilter, kind: kindFilter}) }}" tabindex="-1" aria-disabled="{{ pagination.page == 1 ? 'true' : 'false' }}">Précédent</a>
                </li>
                {% for pageNumber in 1..pagination.pages %}
                    {% if pageNumber == 1 or pageNumber == pagination.pages or (pageNumber >= pagination.page - 2 and pageNumber <= pagination.page + 2) %}
                        <li class="page-item {{ pageNumber == pagination.page ? 'active' : '' }}">
                            <a class="page-link" href="{{ path('app_song_index', {page: pageNumber, q: search, type: typeFilter, kind: kindFilter}) }}">{{ pageNumber }}</a>
                        </li>
                    {% elseif pageNumber == pagination.page - 3 or pageNumber == pagination.page + 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {{ pagination.page == pagination.pages ? 'disabled' }}">
                    <a class="page-link" href="{{ pagination.page == pagination.pages ? '#' : path('app_song_index', {page: nextPage, q: search, type: typeFilter, kind: kindFilter}) }}" aria-disabled="{{ pagination.page == pagination.pages ? 'true' : 'false' }}">Suivant</a>
                </li>
            </ul>
        </nav>
    {% endif %}
{% endif %}

{# Modal Suggestions #}
{% if 'ROLE_ADMIN' in app.user.roles or 'ROLE_MUSICIAN' in app.user.roles %}
    <div class="modal fade" id="suggestionsModal" tabindex="-1" aria-labelledby="suggestionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Suggestions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="alert alert-warning d-flex align-items-center gap-2 rounded-0 mb-0 border-bottom">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span>Ces suggestions n’ont pas encore été vérifiées. Merci de contrôler leurs informations avant validation et de les compléter le cas échéant. Votre validation sera signée par votre identifiant.</span>
                </div>
                <div class="modal-body">
                    {% if suggestions is not empty %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Types</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for song in suggestions %}
                                        <tr id="suggestionRow{{ song.id }}">
                                            <td class="fw-bold">
                                                {{ song.name }}
                                                {% if song.privateToWedding %}
                                                    <span class="badge text-bg-dark ms-2">Privé</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if song.song %}
                                                    <span class="badge text-bg-primary">Chant</span>
                                                {% else %}
                                                    <span class="badge text-bg-info">Texte</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% for t in song.types %}
                                                    <span class="badge text-bg-secondary">{{ t.name }}</span>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <form method="post" action="{{ path('app_song_approve_suggestion', {'id': song.id}) }}" style="display:inline;" onsubmit="return confirm('Valider cette suggestion ?');">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('approve_song_' ~ song.id) }}">
                                                    <button class="btn btn-sm btn-success">
                                                        <i class="bi bi-check-lg"></i> Valider
                                                    </button>
                                                </form>
                                                <a href="{{ path('app_song_view', {'id': song.id}) }}" class="btn btn-sm btn-light" target="_blank">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">Aucune suggestion en attente.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<div class="modal fade" id="suggestSongModal" tabindex="-1" aria-labelledby="suggestSongModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suggestSongModalLabel">Ajouter un nouvel élément</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                {% include 'song/_suggestion_content.html.twig' with {
                    songTypes: songTypes|default([]),
                    allowPrivateSuggestions: false
                } %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirm-song-suggestion">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

{# Notice légale #}
<div class="container-fluid mt-5" role="note" aria-label="Information légale">
    <div class="mx-auto" style="max-width:1100px; margin-bottom:2rem;">
        <div class="p-3" style="background:var(--color-tertiary);border-radius:10px;border:1px solid rgba(0,0,0,0.04);">
            <p class="small mb-0 text-muted" style="line-height:1.4;text-align:center;">
                Ce site agit en tant qu'hébergeur (LCEN, 21 juin 2004). Les publications restent sous la responsabilité de chaque contributeur.
                Toute personne peut notifier un contenu illicite via
                <a href="mailto:contact@notremessedemariage.fr">contact@notremessedemariage.fr</a>.
                Les contenus signalés sont retirés promptement.
            </p>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ include('song/_suggestion_ui_script.html.twig') }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modalEl = document.getElementById('suggestSongModal');
            const confirmBtn = document.getElementById('confirm-song-suggestion');

            if (!modalEl || typeof bootstrap === 'undefined' || !confirmBtn) {
                return;
            }

            const modal = new bootstrap.Modal(modalEl);
            const openButtons = document.querySelectorAll('.js-open-suggestion-modal');
            const getState = () => window.suggestionForm || {};

            const resetFields = () => {
                const songRadio = document.getElementById('suggestion-type-song');
                const textRadio = document.getElementById('suggestion-type-text');
                if (songRadio) {
                    songRadio.checked = true;
                }
                if (textRadio) {
                    textRadio.checked = false;
                }

                const ids = [
                    'suggestion-name',
                    'suggestion-lyrics',
                    'suggestion-preview-url',
                    'suggestion-music-author',
                    'suggestion-lyrics-author',
                    'suggestion-interpret',
                    'suggestion-editor',
                    'suggestion-text-ref',
                    'suggestion-text-translation'
                ];
                ids.forEach((id) => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = '';
                    }
                });

                const privateToggle = document.getElementById('suggestion-private');
                if (privateToggle) {
                    privateToggle.checked = false;
                }

                const state = getState();
                if (state.clearTypeSelection) {
                    state.clearTypeSelection();
                }
                if (state.resetPreview) {
                    state.resetPreview();
                }
                if (state.toggleSections) {
                    state.toggleSections(true);
                }
            };

            openButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    resetFields();
                    modal.show();
                    setTimeout(() => document.getElementById('suggestion-name')?.focus(), 250);
                });
            });

            confirmBtn.addEventListener('click', async function () {
                const songName = document.getElementById('suggestion-name')?.value.trim();
                if (!songName) {
                    alert('Veuillez saisir un titre.');
                    return;
                }

                const isSong = document.getElementById('suggestion-type-song')?.checked ?? true;
                const state = getState();
                let selectedTypes = [];
                if (state.tomSelect) {
                    selectedTypes = state.tomSelect.getValue();
                    if (typeof selectedTypes === 'string') {
                        selectedTypes = selectedTypes ? [selectedTypes] : [];
                    }
                } else if (state.typesSelectElement) {
                    selectedTypes = Array.from(state.typesSelectElement.selectedOptions).map((opt) => opt.value);
                }
                const originalLabel = confirmBtn.innerHTML;
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Envoi...';

                try {
                    const toValue = (id) => document.getElementById(id)?.value.trim() || '';
                    const formData = new FormData();
                    formData.append('name', songName);
                    formData.append('isSong', isSong ? '1' : '0');
                    formData.append('lyrics', toValue('suggestion-lyrics'));
                    formData.append('previewUrl', toValue('suggestion-preview-url'));
                    formData.append('lyricsAuthorName', toValue('suggestion-lyrics-author'));
                    formData.append('musicAuthorName', toValue('suggestion-music-author'));
                    formData.append('interpretName', toValue('suggestion-interpret'));
                    formData.append('editorName', toValue('suggestion-editor'));
                    formData.append('textRef', toValue('suggestion-text-ref'));
                    formData.append('textTranslationName', toValue('suggestion-text-translation'));
                    selectedTypes.forEach((typeId) => formData.append('typeIds[]', typeId));

                    const response = await fetch('{{ path("song_suggestion_create") }}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const contentType = response.headers.get('content-type') || '';
                    let data;

                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        const rawResponse = await response.text();
                        console.error('Unexpected response payload', rawResponse);
                        throw new Error('Réponse inattendue du serveur. Merci de réessayer plus tard.');
                    }

                    if (!response.ok || !data.success) {
                        throw new Error(data.message || 'Erreur lors de la création.');
                    }

                    modal.hide();
                    resetFields();
                    alert('Suggestion enregistrée ! Elle sera examinée prochainement.');
                } catch (error) {
                    console.error(error);
                    alert(error.message || 'Impossible de créer la suggestion pour le moment.');
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = originalLabel;
                }
            });
        });
    </script>
{% endblock %}
