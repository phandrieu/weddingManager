{% extends 'base.html.twig' %}

{% block title %}{{ song.id ? 'Modifier le chant' : 'Ajouter un nouvel élément' }}{% endblock %}

{% block body %}
{% set previewValue = form.previewUrl is defined ? form.previewUrl.vars.value : '' %}
{% set previewVideoId = '' %}
{% if previewValue %}
    {% if 'v=' in previewValue %}
        {% set previewVideoId = previewValue|split('v=')|last|split('&')|first %}
    {% elseif previewValue matches '~youtu\\.be/(.+)$~' %}
        {% set previewVideoId = previewValue|replace({'https://youtu.be/':'','http://youtu.be/':''}) %}
    {% endif %}
{% endif %}
{% set previewInitialSrc = previewVideoId ? 'https://www.youtube.com/embed/' ~ previewVideoId : (previewValue ?: 'about:blank') %}

<section class="song-edit" aria-labelledby="song-edit-title">
    <header class="song-edit__header">
        <h1 id="song-edit-title" class="song-edit__title">
            {{ song.id ? 'Modifier le chant' : 'Ajouter un nouvel élément' }}
        </h1>
        <div class="song-edit__actions" role="group" aria-label="Actions rapides">
            <button type="submit" form="songForm" class="btn btn-primary song-edit__submit">
                Enregistrer
            </button>
            <a href="{{ path('app_song_index') }}" class="btn btn-outline-secondary song-edit__cancel">Annuler</a>
        </div>
    </header>

    <div class="song-edit__intro" role="note" aria-label="Présentation de la bibliothèque">
        <p class="mb-0">
            Cette bibliothèque vit grâce aux apports de la communauté&nbsp;: musiciens, paroisses et futurs mariés.
            Chacun peut proposer ses versions de chants, partitions ou textes pour enrichir la préparation des célébrations.
            Chaque contributeur reste responsable de ses publications.
        </p>
    </div>

    {{ form_start(form, {'attr': {'enctype': 'multipart/form-data', 'id': 'songForm'}, 'multipart': true}) }}

    <div class="song-edit__layout">
        <div class="song-edit__main">
            <section class="song-edit__panel" aria-label="Informations principales">
                <div class="song-edit__type">
                    {{ form_widget(form.song, { 'attr': {'class':'song-edit__type-widget'}, 'label_attr': {'class':'song-edit__type-label'} }) }}
                </div>

                <div class="song-edit__field-group">
                    {{ form_label(form.name, 'Titre du chant', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                    {{ form_widget(form.name, {'attr': {'class':'form-control form-control-lg', 'placeholder':'Écrire le titre ici'}}) }}
                    {{ form_errors(form.name) }}
                </div>

                <div class="song-edit__field-group">
                    {{ form_label(form.types, 'Catégorie(s)', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                    {{ form_widget(form.types, {
                        'attr': {
                            'class': 'form-select song-type-select',
                            'data-placeholder': 'Rechercher et sélectionner'
                        }
                    }) }}
                    {{ form_errors(form.types) }}
                </div>

                <div class="song-edit__field-group">
                    {{ form_label(form.lyrics, 'Paroles', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                    {{ form_widget(form.lyrics, {
                        'attr': {
                            'class':'form-control song-edit__textarea',
                            'rows': 16,
                            'placeholder':'Écrire le texte ici (Mettre « R. » devant les refrains et « 1. » puis suites de nombres devant les couplets)'
                        }
                    }) }}
                    {{ form_errors(form.lyrics) }}
                </div>

                {% if form.suggestion is defined %}
                    <div class="song-edit__field-group">
                        {{ form_widget(form.suggestion, {'attr': {'class':'form-control'}}) }}
                        {{ form_errors(form.suggestion) }}
                    </div>
                {% endif %}
            </section>
        </div>

        <aside class="song-edit__sidebar" aria-label="Informations complémentaires">
            <section id="song-specific" class="song-edit__panel" aria-live="polite">
                <div class="song-edit__panel-group">
                    <h2 class="song-edit__section-title">Prévisualisation</h2>
                    <div class="song-edit__field-group">
                        {{ form_label(form.previewUrl, 'URL de prévisualisation (lien Youtube)', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.previewUrl, {'attr': {'class':'form-control', 'placeholder':"Coller l'URL Youtube ici", 'id':'song_form_previewUrl'}}) }}
                        {{ form_errors(form.previewUrl) }}
                    </div>

                    <div id="youtube-preview" class="song-edit__video {{ previewVideoId or previewValue ? '' : 'd-none' }}">
                        <div class="ratio ratio-16x9">
                            <iframe id="youtube-iframe"
                                src="{{ previewInitialSrc }}"
                                title="{{ form.name.vars.value ?: 'Prévisualisation vidéo' }}"
                                allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                </div>

                <div class="song-edit__panel-group">
                    <h2 class="song-edit__section-title">Ressources</h2>
                    <div class="song-edit__field-group">
                        {{ form_label(form.partitionPDFFile, 'Partition(s) : (PDF)', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.partitionPDFFile, {'attr': {'class':'form-control'}}) }}
                        {{ form_errors(form.partitionPDFFile) }}
                        {% if song.partitionPDFName %}
                            <p class="song-edit__file-info mb-0">Fichier actuel :
                                <a href="{{ asset('uploads/song_pdf/' ~ song.partitionPDFName) }}" target="_blank">{{ song.partitionPDFName }}</a>
                            </p>
                        {% endif %}
                    </div>
                </div>

                <div class="song-edit__panel-group">
                    <h2 class="song-edit__section-title">Crédits</h2>
                    <div class="song-edit__field-group">
                        {{ form_label(form.musicAuthorName, 'Compositeur(s)', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.musicAuthorName, {'attr': {'class':'form-control', 'placeholder':'Écrire le(s) Nom(s) et Prénom(s) ici'}}) }}
                        {{ form_errors(form.musicAuthorName) }}
                    </div>

                    <div class="song-edit__field-group">
                        {{ form_label(form.lyricsAuthorName, 'Écriture des paroles', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.lyricsAuthorName, {'attr': {'class':'form-control', 'placeholder':'Écrire le(s) Nom(s) et Prénom(s)'}}) }}
                        {{ form_errors(form.lyricsAuthorName) }}
                    </div>

                    <div class="song-edit__field-group">
                        {{ form_label(form.interpretName, 'Interprète(s)', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.interpretName, {'attr': {'class':'form-control', 'placeholder':'Écrire le(s) Nom(s) et Prénom(s)'}}) }}
                        {{ form_errors(form.interpretName) }}
                    </div>

                    <div class="song-edit__field-group">
                        {{ form_label(form.editorName, 'Éditeur(s)', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.editorName, {'attr': {'class':'form-control', 'placeholder':'Écrire le(s) Nom(s) ou organisme'}}) }}
                        {{ form_errors(form.editorName) }}
                    </div>
                </div>
            </section>

            <section id="text-specific" class="song-edit__panel d-none" aria-live="polite">
                <h2 class="song-edit__section-title">Informations sur le texte</h2>
                {% if form.textRef is defined %}
                    <div class="song-edit__field-group">
                        {{ form_label(form.textRef, 'Référence du texte (ex&nbsp;: Jean 3:16)', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.textRef, {'attr': {'class':'form-control', 'placeholder':'Référence du texte'}}) }}
                        {{ form_errors(form.textRef) }}
                    </div>
                {% endif %}
                {% if form.textTranslationName is defined %}
                    <div class="song-edit__field-group">
                        {{ form_label(form.textTranslationName, 'Nom de la traduction', {'label_attr': {'class':'form-label song-edit__field-label'}}) }}
                        {{ form_widget(form.textTranslationName, {'attr': {'class':'form-control', 'placeholder':'Nom de la traduction'}}) }}
                        {{ form_errors(form.textTranslationName) }}
                    </div>
                {% endif %}
            </section>
        </aside>
    </div>

    {{ form_rest(form) }}
    {{ form_end(form, {'render_rest': false}) }}
    <div class="song-edit__legal" role="note" aria-label="Information légale">
        <p class="mb-0">
            Ce site agit en tant qu’hébergeur (LCEN, 21 juin 2004). Les publications restent sous la responsabilité de chaque contributeur.
            Toute personne peut notifier un contenu illicite via
            <a href="mailto:contact@notremessedemariage.fr">contact@notremessedemariage.fr</a>.
            Les contenus signalés sont retirés promptement.
        </p>
    </div>
</section>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const hiddenClass = 'd-none';
            const radios = Array.from(document.querySelectorAll('input[name="{{ form.song.vars.full_name }}"]'));
            const textSpecific = document.getElementById('text-specific');
            const songSpecific = document.getElementById('song-specific');
            const previewInput = document.getElementById('song_form_previewUrl');
            const previewWrapper = document.getElementById('youtube-preview');
            const iframe = document.getElementById('youtube-iframe');

            function updateBlocks() {
                const checked = radios.find(r => r.checked);
                const isSong = checked ? (checked.value === '1' || checked.value === 'true' || checked.value === 'on') : true;
                if (textSpecific) {
                    textSpecific.classList.toggle(hiddenClass, isSong);
                }
                if (songSpecific) {
                    songSpecific.classList.toggle(hiddenClass, !isSong);
                }
            }

            function extractYoutubeId(rawUrl) {
                if (!rawUrl) {
                    return '';
                }
                const match = rawUrl.match(/(?:youtube\.com.*[?&]v=|youtu\.be\/)([^&\s]+)/);
                return match ? match[1] : '';
            }

            function updatePreview() {
                if (!previewWrapper || !iframe || !previewInput) {
                    return;
                }

                const rawValue = previewInput.value.trim();
                const videoId = extractYoutubeId(rawValue);
                let isValidUrl = false;

                if (rawValue) {
                    try {
                        new URL(rawValue);
                        isValidUrl = true;
                    } catch (error) {
                        isValidUrl = Boolean(videoId);
                    }
                }

                if (isValidUrl || videoId) {
                    previewWrapper.classList.remove(hiddenClass);
                    iframe.src = videoId ? `https://www.youtube.com/embed/${videoId}` : rawValue;
                } else {
                    previewWrapper.classList.add(hiddenClass);
                    iframe.src = 'about:blank';
                }
            }

            radios.forEach(radio => radio.addEventListener('change', updateBlocks));
            updateBlocks();

            if (previewInput) {
                previewInput.addEventListener('input', updatePreview);
                updatePreview();
            }
        });
    </script>
{% endblock %}