{% extends 'base.html.twig' %}

{% block title %}Liste des types de chants{% endblock %}

{% block body %}
<header class="page-header">
    <h1>Types de chants</h1>
    <div class="app-actions">
        <button type="button" class="btn btn-outline-secondary btn-rounded btn-icon" data-bs-toggle="modal" data-bs-target="#reorderSongTypesModal" {% if songTypes is empty %}disabled{% endif %}>
            <i class="bi bi-arrow-down-up"></i>
            Modifier l'ordre
        </button>
        <a href="{{ path('app_songtype_edit') }}" class="btn btn-primary btn-rounded btn-icon">
            <i class="bi bi-plus-lg"></i>
            Ajouter un type
        </a>
    </div>
</header>

<div class="app-table-wrapper">
    <table class="app-table">
        <thead>
            <tr>
                <th>Nom</th>
                <th style="text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for type in songTypes %}
                <tr>
                    <td>{{ type.name }}</td>
                    <td>
                        <div class="d-flex justify-content-center align-items-center" style="gap: 0.5rem;">
                            <a href="{{ path('app_songtype_view', {'id': type.id}) }}" class="btn btn-sm btn-light" title="Voir">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ path('app_songtype_edit', {'id': type.id}) }}" class="btn btn-sm btn-light" title="Modifier">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form method="post" action="{{ path('app_songtype_delete', {'id': type.id}) }}" style="display:inline-block;"
                                  onsubmit="return confirm('Voulez-vous vraiment supprimer ce type de chant ?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ type.id) }}">
                                <button class="btn btn-sm btn-danger" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="2" class="text-center text-muted">Aucun type de chant trouvé.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="reorderSongTypesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier l'ordre des types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                {% if songTypes is empty %}
                    <p class="text-muted mb-0">Ajoute d'abord des types pour les ordonner.</p>
                {% else %}
                    <p class="text-muted">Fais glisser les éléments pour réordonner la liste.</p>
                    <ul class="list-group" id="songTypeReorderList">
                        {% for type in songTypes %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ type.id }}" draggable="true">
                                <div class="d-flex align-items-center" style="gap:0.75rem;">
                                    <span class="text-muted drag-handle" aria-hidden="true" style="cursor:grab;">
                                        <i class="bi bi-grip-vertical"></i>
                                    </span>
                                    <span>{{ type.name }}</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveSongTypeOrderBtn" {% if songTypes is empty %}disabled{% endif %}>
                    Sauvegarder l'ordre
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modalEl = document.getElementById('reorderSongTypesModal');
            const listEl = document.getElementById('songTypeReorderList');
            const saveBtn = document.getElementById('saveSongTypeOrderBtn');
            const reorderToken = "{{ csrf_token('songtype_reorder') }}";

            if (!modalEl || !listEl || !saveBtn) {
                return;
            }

            const getDragAfterElement = (container, y) => {
                const items = [...container.querySelectorAll('li:not(.dragging)')];

                return items.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    }
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
            };

            listEl.addEventListener('dragstart', (event) => {
                const item = event.target.closest('li');
                if (!item) {
                    return;
                }
                item.classList.add('dragging');
                event.dataTransfer.effectAllowed = 'move';
            });

            listEl.addEventListener('dragend', (event) => {
                event.target.classList.remove('dragging');
            });

            listEl.addEventListener('dragover', (event) => {
                event.preventDefault();
                const dragging = listEl.querySelector('.dragging');
                if (!dragging) {
                    return;
                }
                const afterElement = getDragAfterElement(listEl, event.clientY);
                if (!afterElement) {
                    listEl.appendChild(dragging);
                } else {
                    listEl.insertBefore(dragging, afterElement);
                }
            });

            saveBtn.addEventListener('click', async function () {
                const ids = Array.from(listEl.children).map((li) => parseInt(li.dataset.id, 10)).filter(Boolean);
                if (ids.length === 0) {
                    return;
                }

                const originalLabel = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sauvegarde...';

                try {
                    const response = await fetch("{{ path('app_songtype_reorder') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order: ids, csrf: reorderToken })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'Erreur inconnue');
                    }

                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.hide();
                    window.location.reload();
                } catch (error) {
                    console.error(error);
                    alert('Impossible de sauvegarder le nouvel ordre.');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalLabel;
                }
            });
        });
    </script>
{% endblock %}
